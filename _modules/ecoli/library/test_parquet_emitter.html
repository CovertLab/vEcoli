

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ecoli.library.test_parquet_emitter &mdash; Vivarium E. coli 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Vivarium E. coli
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../stores.html">Stores</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../composites.html">Composites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiments.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc.html">HPC Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gcloud.html">Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ci.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycharm.html">PyCharm Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../diffs.html">Model Differences From wcEcoli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/api_ref.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Vivarium E. coli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ecoli.library.test_parquet_emitter</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ecoli.library.test_parquet_emitter</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">duckdb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">Future</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.library.parquet_emitter</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">json_to_parquet</span><span class="p">,</span>
    <span class="n">np_dtype</span><span class="p">,</span>
    <span class="n">named_idx</span><span class="p">,</span>
    <span class="n">ndidx_to_duckdb_expr</span><span class="p">,</span>
    <span class="n">flatten_dict</span><span class="p">,</span>
    <span class="n">union_pl_dtypes</span><span class="p">,</span>
    <span class="n">ParquetEmitter</span><span class="p">,</span>
    <span class="n">quote_columns</span><span class="p">,</span>
    <span class="n">list_columns</span><span class="p">,</span>
    <span class="n">create_duckdb_conn</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="TestHelperFunctions">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.library.test_parquet_emitter.html#ecoli.library.test_parquet_emitter.TestHelperFunctions">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestHelperFunctions</span><span class="p">:</span>
<div class="viewcode-block" id="TestHelperFunctions.query_conn">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.library.test_parquet_emitter.html#ecoli.library.test_parquet_emitter.TestHelperFunctions.query_conn">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Polars DataFrame for DuckDB to query.&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>
        <span class="c1"># Create Polars DataFrame for DuckDB to query</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>  <span class="c1"># noqa: F841</span>
            <span class="p">{</span>
                <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]],</span>
                <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">[[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span>
                    <span class="p">[[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]],</span>
                    <span class="p">[[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]],</span>
                <span class="p">],</span>
                <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">[[[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.9</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">]]],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;CREATE OR REPLACE TABLE test_table AS SELECT * FROM df&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">conn</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">test_named_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_conn</span><span class="p">):</span>
        <span class="n">col_expr</span> <span class="o">=</span> <span class="n">named_idx</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;col1&quot;</span><span class="p">,</span> <span class="s2">&quot;col2&quot;</span><span class="p">,</span> <span class="s2">&quot;col3&quot;</span><span class="p">],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">query_conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">col_expr</span><span class="si">}</span><span class="s2"> FROM test_table&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;col1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;col2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span> <span class="s2">&quot;col3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]}</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="n">col_expr</span> <span class="o">=</span> <span class="n">named_idx</span><span class="p">(</span>
            <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;col1&quot;</span><span class="p">,</span> <span class="s2">&quot;col2&quot;</span><span class="p">,</span> <span class="s2">&quot;col3&quot;</span><span class="p">],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">zero_to_null</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">query_conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">col_expr</span><span class="si">}</span><span class="s2"> FROM test_table&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;col1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="s2">&quot;col2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
                <span class="s2">&quot;col3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="n">col_expr</span> <span class="o">=</span> <span class="n">named_idx</span><span class="p">(</span>
            <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;col1&quot;</span><span class="p">,</span> <span class="s2">&quot;col2&quot;</span><span class="p">,</span> <span class="s2">&quot;col3&quot;</span><span class="p">,</span> <span class="s2">&quot;col4&quot;</span><span class="p">],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">zero_to_null</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">query_conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">col_expr</span><span class="si">}</span><span class="s2"> FROM test_table&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;col1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                <span class="s2">&quot;col2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="s2">&quot;col3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">],</span>
                <span class="s2">&quot;col4&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_ndidx_to_duckdb_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_conn</span><span class="p">):</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">ndidx_to_duckdb_expr</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">query_conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2"> FROM test_table&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">[[[</span><span class="mf">0.2</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.6</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]]]})</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="n">expr</span> <span class="o">=</span> <span class="n">ndidx_to_duckdb_expr</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">query_conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2"> FROM test_table&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">[[[</span><span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.9</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">]]]})</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

        <span class="n">expr</span> <span class="o">=</span> <span class="n">ndidx_to_duckdb_expr</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;:&quot;</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">query_conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2"> FROM test_table&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">[[[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">]],</span> <span class="p">[[</span><span class="mf">0.9</span><span class="p">]]]})</span>
        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_flatten_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Simple dictionary</span>
        <span class="k">assert</span> <span class="n">flatten_dict</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

        <span class="c1"># Nested dictionary</span>
        <span class="k">assert</span> <span class="n">flatten_dict</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span> <span class="o">==</span> <span class="p">{</span>
            <span class="s2">&quot;a__b&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;a__c&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Deeply nested dictionary</span>
        <span class="k">assert</span> <span class="n">flatten_dict</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span> <span class="o">==</span> <span class="p">{</span>
            <span class="s2">&quot;a__b__c__d&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Empty dictionary</span>
        <span class="k">assert</span> <span class="n">flatten_dict</span><span class="p">({})</span> <span class="o">==</span> <span class="p">{}</span>

        <span class="c1"># Dictionary with mixed value types</span>
        <span class="n">nested</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])}})</span>
        <span class="k">assert</span> <span class="n">nested</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">nested</span><span class="p">[</span><span class="s2">&quot;b__c&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_np_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Basic types</span>
        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;float_field&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>

        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;bool_field&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span>

        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;string_field&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">StringDType</span>

        <span class="c1"># Integer with different encodings</span>
        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;int_field&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>

        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;listeners__ribosome_data__mRNA_TU_index&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span>

        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;listeners__monomer_counts&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span>

        <span class="c1"># Arrays with various dimensions</span>
        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="s2">&quot;array1d_field&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>

        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]),</span> <span class="s2">&quot;array2d_field&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>

        <span class="c1"># Empty arrays still have a dtype</span>
        <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s2">&quot;empty_array_field&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np_type</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>

        <span class="c1"># Raise error for empty lists to fall back to Polars serialization</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;empty_list_field has unsupported&quot;</span><span class="p">):</span>
            <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">([[],</span> <span class="p">[],</span> <span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;empty_list_field&quot;</span><span class="p">)</span>

        <span class="c1"># Raise error for none to fall back to Polars serialization</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;none_field has unsupported&quot;</span><span class="p">):</span>
            <span class="n">np_type</span> <span class="o">=</span> <span class="n">np_dtype</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;none_field&quot;</span><span class="p">)</span>

        <span class="c1"># Invalid types</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;complex_field has unsupported type&quot;</span><span class="p">):</span>
            <span class="n">np_dtype</span><span class="p">(</span><span class="nb">complex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;complex_field&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_union_pl_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Basic types</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;Incompatible inner types for field&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">union_pl_dtypes</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int32</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span> <span class="s2">&quot;fail&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;Incompatible inner types for field&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">union_pl_dtypes</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="s2">&quot;fail&quot;</span><span class="p">)</span>

        <span class="c1"># Nested types</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;Incompatible inner types for field&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">union_pl_dtypes</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int16</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">),</span> <span class="s2">&quot;nest&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;Incompatible inner types for field&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">union_pl_dtypes</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">),</span> <span class="s2">&quot;nest_fail&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;Incompatible inner types for field&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">union_pl_dtypes</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">)),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">),</span> <span class="s2">&quot;nest_fail&quot;</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;Incompatible inner types for field&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">union_pl_dtypes</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))),</span> <span class="s2">&quot;nest_fail&quot;</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">),</span> <span class="s2">&quot;force_u32&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span><span class="p">)</span>

        <span class="c1"># Forced types: a bit scary but we assume user knows what they are doing</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int16</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt8</span><span class="p">,</span> <span class="s2">&quot;force_u16&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span> <span class="s2">&quot;force_u32&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">union_pl_dtypes</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="s2">&quot;force_u32&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">),</span> <span class="s2">&quot;force_u32&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">),</span> <span class="s2">&quot;force_u32&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">)),</span>
            <span class="s2">&quot;force_u16&quot;</span><span class="p">,</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">))</span>

        <span class="c1"># Null merge</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span> <span class="s2">&quot;null_merge&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span> <span class="s2">&quot;force_u16&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">),</span> <span class="s2">&quot;force_u16&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)),</span> <span class="s2">&quot;null_merge&quot;</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))),</span>
            <span class="s2">&quot;null_merge&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">),</span> <span class="s2">&quot;force_u16&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt16</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int32</span><span class="p">)),</span> <span class="s2">&quot;force_u32&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int32</span><span class="p">))),</span> <span class="s2">&quot;null_merge&quot;</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int32</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">union_pl_dtypes</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int32</span><span class="p">))),</span>
            <span class="s2">&quot;force_u32&quot;</span><span class="p">,</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">UInt32</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_quote_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test quote_columns handles special characters correctly.&quot;&quot;&quot;</span>
        <span class="c1"># Test single string with special characters</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s2">&quot;simple&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&quot;simple&quot;&#39;</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s2">&quot;with spaces&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&quot;with spaces&quot;&#39;</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s2">&quot;with-hyphens&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&quot;with-hyphens&quot;&#39;</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s2">&quot;with[brackets]&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&quot;with[brackets]&quot;&#39;</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s2">&quot;with/slashes&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&quot;with/slashes&quot;&#39;</span>

        <span class="c1"># Test string with existing double quotes (should be escaped)</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s1">&#39;already&quot;quoted&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&quot;already&quot;&quot;quoted&quot;&#39;</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s1">&#39;&quot;fully&quot;quoted&quot;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&quot;&quot;&quot;fully&quot;&quot;quoted&quot;&quot;&quot;&#39;</span>

        <span class="c1"># Test list of strings</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">([</span><span class="s2">&quot;col1&quot;</span><span class="p">,</span> <span class="s2">&quot;col2&quot;</span><span class="p">,</span> <span class="s2">&quot;col3&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span>
            <span class="s1">&#39;&quot;col1&quot;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&quot;col2&quot;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&quot;col3&quot;&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">([</span><span class="s2">&quot;with spaces&quot;</span><span class="p">,</span> <span class="s2">&quot;with-hyphens&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span>
            <span class="s1">&#39;&quot;with spaces&quot;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&quot;with-hyphens&quot;&#39;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Test mixed special characters in list</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">([</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;space here&quot;</span><span class="p">,</span> <span class="s2">&quot;hyphen-here&quot;</span><span class="p">,</span> <span class="s1">&#39;quote&quot;here&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span>
            <span class="s1">&#39;&quot;normal&quot;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&quot;space here&quot;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&quot;hyphen-here&quot;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&quot;quote&quot;&quot;here&quot;&#39;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Test empty cases</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&quot;&quot;&#39;</span>
        <span class="k">assert</span> <span class="n">quote_columns</span><span class="p">([])</span> <span class="o">==</span> <span class="p">[]</span>

        <span class="c1"># Test that quoted columns actually work in DuckDB queries with weird column names</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_path</span><span class="p">:</span>
            <span class="n">test_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;weird_cols.parquet&quot;</span><span class="p">)</span>
            <span class="c1"># Create test data with columns containing special characters</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;simple&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                    <span class="s2">&quot;with spaces&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                    <span class="s2">&quot;with-hyphens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
                    <span class="s2">&quot;with[brackets]&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>
                    <span class="s2">&quot;with/slashes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
                    <span class="s1">&#39;has&quot;quote&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span>
                    <span class="s2">&quot;dot.name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">],</span>
                    <span class="s2">&quot;colon:name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">test_data</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="n">statistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="n">create_duckdb_conn</span><span class="p">()</span>

            <span class="c1"># Test selecting individual columns with special characters</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">quoted_col</span> <span class="o">=</span> <span class="n">quote_columns</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">quoted_col</span><span class="si">}</span><span class="s2"> FROM &#39;</span><span class="si">{</span><span class="n">test_file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">col</span>
                <span class="n">expected_values</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="n">expected_values</span>

            <span class="c1"># Test selecting multiple columns at once</span>
            <span class="n">weird_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;with spaces&quot;</span><span class="p">,</span> <span class="s2">&quot;with-hyphens&quot;</span><span class="p">,</span> <span class="s2">&quot;with[brackets]&quot;</span><span class="p">,</span> <span class="s1">&#39;has&quot;quote&#39;</span><span class="p">]</span>
            <span class="n">quoted_cols</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote_columns</span><span class="p">(</span><span class="n">weird_cols</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">quoted_cols</span><span class="si">}</span><span class="s2"> FROM &#39;</span><span class="si">{</span><span class="n">test_file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">weird_cols</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="n">test_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

            <span class="c1"># Test that using WHERE clause works with quoted columns</span>
            <span class="n">quoted_space_col</span> <span class="o">=</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s2">&quot;with spaces&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SELECT * FROM &#39;</span><span class="si">{</span><span class="n">test_file</span><span class="si">}</span><span class="s2">&#39; WHERE </span><span class="si">{</span><span class="n">quoted_space_col</span><span class="si">}</span><span class="s2"> &gt; 4&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;with spaces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

            <span class="c1"># Test aggregation with quoted columns</span>
            <span class="n">quoted_bracket_col</span> <span class="o">=</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s2">&quot;with[brackets]&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SELECT AVG(</span><span class="si">{</span><span class="n">quoted_bracket_col</span><span class="si">}</span><span class="s2">) as avg_val FROM &#39;</span><span class="si">{</span><span class="n">test_file</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;avg_val&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">11.0</span>

            <span class="c1"># Test ORDER BY with quoted columns</span>
            <span class="n">quoted_slash_col</span> <span class="o">=</span> <span class="n">quote_columns</span><span class="p">(</span><span class="s2">&quot;with/slashes&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">quoted_slash_col</span><span class="si">}</span><span class="s2"> FROM &#39;</span><span class="si">{</span><span class="n">test_file</span><span class="si">}</span><span class="s2">&#39; ORDER BY </span><span class="si">{</span><span class="n">quoted_slash_col</span><span class="si">}</span><span class="s2"> DESC&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;with/slashes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_list_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test list_columns retrieves column names correctly.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_path</span><span class="p">:</span>
            <span class="c1"># Create test Parquet file with known columns</span>
            <span class="n">test_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span> <span class="s2">&quot;test.parquet&quot;</span><span class="p">)</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;col_a&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                    <span class="s2">&quot;col_b&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">],</span>
                    <span class="s2">&quot;listeners__mass__cell_mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">7.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">],</span>
                    <span class="s2">&quot;listeners__mass__dry_mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">],</span>
                    <span class="s2">&quot;listeners__growth__instantaneous_growth_rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>
                    <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]],</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">test_data</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="n">statistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="n">create_duckdb_conn</span><span class="p">()</span>
            <span class="n">subquery</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM &#39;</span><span class="si">{</span><span class="n">test_file</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

            <span class="c1"># Test getting all columns</span>
            <span class="n">all_cols</span> <span class="o">=</span> <span class="n">list_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">subquery</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
            <span class="k">assert</span> <span class="s2">&quot;col_a&quot;</span> <span class="ow">in</span> <span class="n">all_cols</span>
            <span class="k">assert</span> <span class="s2">&quot;col_b&quot;</span> <span class="ow">in</span> <span class="n">all_cols</span>
            <span class="k">assert</span> <span class="s2">&quot;listeners__mass__cell_mass&quot;</span> <span class="ow">in</span> <span class="n">all_cols</span>

            <span class="c1"># Test pattern matching with glob patterns</span>
            <span class="n">listener_cols</span> <span class="o">=</span> <span class="n">list_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">subquery</span><span class="p">,</span> <span class="s2">&quot;listeners__*&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">listener_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;listeners__&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">listener_cols</span><span class="p">)</span>

            <span class="c1"># Test pattern matching for specific listener</span>
            <span class="n">mass_cols</span> <span class="o">=</span> <span class="n">list_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">subquery</span><span class="p">,</span> <span class="s2">&quot;listeners__mass__*&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mass_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">assert</span> <span class="s2">&quot;listeners__mass__cell_mass&quot;</span> <span class="ow">in</span> <span class="n">mass_cols</span>
            <span class="k">assert</span> <span class="s2">&quot;listeners__mass__dry_mass&quot;</span> <span class="ow">in</span> <span class="n">mass_cols</span>

            <span class="c1"># Test pattern that matches nothing</span>
            <span class="n">no_match</span> <span class="o">=</span> <span class="n">list_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">subquery</span><span class="p">,</span> <span class="s2">&quot;nonexistent__*&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="c1"># Test pattern with single character wildcard</span>
            <span class="n">col_pattern</span> <span class="o">=</span> <span class="n">list_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">subquery</span><span class="p">,</span> <span class="s2">&quot;col_?&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_pattern</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">assert</span> <span class="s2">&quot;col_a&quot;</span> <span class="ow">in</span> <span class="n">col_pattern</span>
            <span class="k">assert</span> <span class="s2">&quot;col_b&quot;</span> <span class="ow">in</span> <span class="n">col_pattern</span>

            <span class="c1"># Test exact match pattern</span>
            <span class="n">exact</span> <span class="o">=</span> <span class="n">list_columns</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">subquery</span><span class="p">,</span> <span class="s2">&quot;bulk&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">exact</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span></div>



<div class="viewcode-block" id="compare_nested">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.library.test_parquet_emitter.html#ecoli.library.test_parquet_emitter.compare_nested">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_nested</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare two lists for equality, including special handling for NaN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">compare_nested</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="TestParquetEmitter">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.library.test_parquet_emitter.html#ecoli.library.test_parquet_emitter.TestParquetEmitter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestParquetEmitter</span><span class="p">:</span>
<div class="viewcode-block" id="TestParquetEmitter.temp_dir">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.library.test_parquet_emitter.html#ecoli.library.test_parquet_emitter.TestParquetEmitter.temp_dir">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">temp_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a temporary directory for testing.&quot;&quot;&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">tmp</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">test_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test ParquetEmitter initialization with different configs.&quot;&quot;&quot;</span>
        <span class="c1"># Test with out_dir</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">})</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">=</span> <span class="s2">&quot;test_exp&quot;</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span> <span class="o">=</span> <span class="s2">&quot;path/to/output&quot;</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">out_uri</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">400</span>

        <span class="c1"># Test with out_uri and custom batch size</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;gs://bucket/path&quot;</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">=</span> <span class="s2">&quot;test_exp&quot;</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span> <span class="o">=</span> <span class="s2">&quot;path/to/output&quot;</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">out_uri</span> <span class="o">==</span> <span class="s2">&quot;gs://bucket/path&quot;</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">100</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_emit_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test emitting configuration data.&quot;&quot;&quot;</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">})</span>

        <span class="c1"># Setup ThreadPoolExecutor mock</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
        <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">future</span><span class="p">)</span>

        <span class="c1"># Test with basic config data</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nested&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">},</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;meta1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;meta2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">config_data</span><span class="p">)</span>

        <span class="c1"># Verify partitioning path</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">==</span> <span class="s2">&quot;test_exp&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;experiment_id=test_exp&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span>
        <span class="k">assert</span> <span class="s2">&quot;variant=1&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span>

        <span class="c1"># Verify json_to_parquet was called</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="o">.</span><span class="n">called</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">emitter</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="o">.</span><span class="n">call_args</span>
        <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">json_to_parquet</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_emit_simulation_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test emitting simulation data with various types.&quot;&quot;&quot;</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

        <span class="c1"># Configuration emit to initialize variables</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">config_data</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Create test data with various types</span>
        <span class="n">sim_data1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;int_field&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
                        <span class="s2">&quot;float_field&quot;</span><span class="p">:</span> <span class="mf">3.14</span><span class="p">,</span>
                        <span class="s2">&quot;bool_field&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;string_field&quot;</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;array_field&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                        <span class="s2">&quot;nested&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># First emit</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">num_emits</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Check that fields were properly encoded</span>
        <span class="k">assert</span> <span class="s2">&quot;int_field&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;int_field&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">42</span>

        <span class="k">assert</span> <span class="s2">&quot;float_field&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;float_field&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.14</span>

        <span class="k">assert</span> <span class="s2">&quot;bool_field&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;bool_field&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">assert</span> <span class="s2">&quot;string_field&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;string_field&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;hello&quot;</span>

        <span class="k">assert</span> <span class="s2">&quot;array_field&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;array_field&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="s2">&quot;nested__value&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;nested__value&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span>

        <span class="c1"># Second emit to trigger batch writing</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">num_emits</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Check output</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">out_uri</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="s2">&quot;history&quot;</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span><span class="p">,</span>
                <span class="s2">&quot;*.pq&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;int_field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;float_field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mf">3.14</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;bool_field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;string_field&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;hello&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_equal</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;array_field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;nested__value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span> <span class="o">==</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_variable_length_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling arrays with changing dimensions.&quot;&quot;&quot;</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="c1"># Configuration emit to initialize variables</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">config_data</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="n">sim_data1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;dynamic_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                        <span class="s2">&quot;ragged_nd&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data1</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Verify arrays were stored correctly</span>
        <span class="k">assert</span> <span class="s2">&quot;dynamic_array&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
        <span class="k">assert</span> <span class="s2">&quot;ragged_nd&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;ragged_nd&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="p">)</span>

        <span class="c1"># Second emit with different shapes</span>
        <span class="n">sim_data2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;dynamic_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
                        <span class="s2">&quot;ragged_nd&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data2</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Verify conversion to variable length type</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;ragged_nd&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span>
        <span class="p">)</span>

        <span class="c1"># Write to Parquet and check output</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data2</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">out_uri</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="s2">&quot;history&quot;</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span><span class="p">,</span>
                <span class="s2">&quot;*.pq&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;ragged_nd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_extreme_data_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test with extreme data types and edge cases.&quot;&quot;&quot;</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="c1"># Create test data with extreme values and special cases</span>
        <span class="n">sim_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="c1"># Extreme values</span>
                        <span class="s2">&quot;max_int&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                        <span class="s2">&quot;min_int&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
                        <span class="s2">&quot;max_float&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                        <span class="s2">&quot;tiny_float&quot;</span><span class="p">:</span> <span class="mf">1e-100</span><span class="p">,</span>
                        <span class="s2">&quot;nan_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                        <span class="s2">&quot;inf_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="c1"># Special cases</span>
                        <span class="s2">&quot;empty_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                        <span class="s2">&quot;zero_dim_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span>
                        <span class="s2">&quot;unicode_string&quot;</span><span class="p">:</span> <span class="s2">&quot;Unicode: &quot;</span><span class="p">,</span>
                        <span class="s2">&quot;very_long_string&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
                        <span class="c1"># Nested structures</span>
                        <span class="s2">&quot;deep_nesting&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;level1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;level2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;level3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}}},</span>
                        <span class="s2">&quot;ragged_nullable&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
                        <span class="c1"># Python datetime objects</span>
                        <span class="s2">&quot;datetime_list&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2002</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2003</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2003</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                        <span class="p">],</span>
                        <span class="s2">&quot;time_list&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                        <span class="p">],</span>
                        <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1776</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="c1"># Test bytes</span>
                        <span class="s2">&quot;npbytes&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;test bytes&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;pybytes&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;test bytes&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;npbytes_list&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;test1&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;test2&quot;</span><span class="p">]),</span>
                        <span class="s2">&quot;pybytes_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;test1&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;test2&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Try to emit the extreme data</span>
        <span class="c1"># First configuration emit to set variables</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="c1"># Then simulation emit</span>
        <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;simulation&quot;</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">num_emits</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># Verify fields were processed</span>
        <span class="k">assert</span> <span class="s2">&quot;max_int&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;max_int&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>

        <span class="k">assert</span> <span class="s2">&quot;min_int&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;min_int&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span>

        <span class="k">assert</span> <span class="s2">&quot;max_float&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;max_float&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>

        <span class="k">assert</span> <span class="s2">&quot;tiny_float&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;tiny_float&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1e-100</span>

        <span class="k">assert</span> <span class="s2">&quot;nan_value&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;nan_value&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">assert</span> <span class="s2">&quot;unicode_string&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;unicode_string&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Unicode: &quot;</span>

        <span class="k">assert</span> <span class="s2">&quot;deep_nesting__level1__level2__level3&quot;</span> <span class="ow">in</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;deep_nesting__level1__level2__level3&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">sim_data_2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="c1"># Shuffle extreme values</span>
                        <span class="s2">&quot;max_int&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
                        <span class="s2">&quot;min_int&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                        <span class="s2">&quot;max_float&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
                        <span class="s2">&quot;tiny_float&quot;</span><span class="p">:</span> <span class="mf">1e100</span><span class="p">,</span>
                        <span class="s2">&quot;nan_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                        <span class="s2">&quot;inf_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                        <span class="c1"># More special cases</span>
                        <span class="s2">&quot;empty_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]),</span>
                        <span class="s2">&quot;zero_dim_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                        <span class="s2">&quot;unicode_string&quot;</span><span class="p">:</span> <span class="s2">&quot;Unicode:  &quot;</span><span class="p">,</span>
                        <span class="s2">&quot;very_long_string&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">,</span>
                        <span class="c1"># Nested structures</span>
                        <span class="s2">&quot;deep_nesting&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;level1&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="c1"># Add a new field mid-batch</span>
                                <span class="s2">&quot;level2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;level3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;level4&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]}</span>
                            <span class="p">}</span>
                        <span class="p">},</span>
                        <span class="s2">&quot;ragged_nullable&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                            <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="kc">None</span><span class="p">,</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                        <span class="p">],</span>
                        <span class="c1"># Python datetime objects</span>
                        <span class="s2">&quot;datetime_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">)],</span>
                        <span class="s2">&quot;time_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span>
                        <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
                        <span class="c1"># Test bytes</span>
                        <span class="s2">&quot;npbytes&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;short&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;pybytes&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;short&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;npbytes_list&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;much longer bytestring&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;1&quot;</span><span class="p">]),</span>
                        <span class="s2">&quot;pybytes_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;much longer bytestring&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;1&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data_2</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span> <span class="o">==</span> <span class="p">{}</span>

        <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">out_uri</span><span class="p">,</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
            <span class="s2">&quot;history&quot;</span><span class="p">,</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emitter</span><span class="o">.</span><span class="n">num_emits</span><span class="si">}</span><span class="s2">.pq&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">output_pl</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>

        <span class="n">output_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;max_int&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">],</span>
            <span class="s2">&quot;min_int&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">],</span>
            <span class="s2">&quot;max_float&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">],</span>
            <span class="s2">&quot;tiny_float&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1e-100</span><span class="p">,</span> <span class="mf">1e100</span><span class="p">],</span>
            <span class="s2">&quot;nan_value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span>
            <span class="s2">&quot;inf_value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
            <span class="s2">&quot;empty_array&quot;</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]],</span>
            <span class="s2">&quot;zero_dim_array&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;unicode_string&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Unicode: &quot;</span><span class="p">,</span> <span class="s2">&quot;Unicode:  &quot;</span><span class="p">],</span>
            <span class="s2">&quot;very_long_string&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">],</span>
            <span class="s2">&quot;deep_nesting__level1__level2__level3&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span>
            <span class="s2">&quot;deep_nesting__level1__level2__level4&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]],</span>
            <span class="s2">&quot;ragged_nullable&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
                <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span>
            <span class="p">],</span>
            <span class="s2">&quot;datetime_list&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2002</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2003</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2003</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">)],</span>
            <span class="p">],</span>
            <span class="s2">&quot;time_list&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span>
            <span class="p">],</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1776</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="c1"># Test bytes</span>
            <span class="s2">&quot;npbytes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;test bytes&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;short&quot;</span><span class="p">],</span>
            <span class="s2">&quot;pybytes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;test bytes&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;short&quot;</span><span class="p">],</span>
            <span class="c1"># Note the truncation for the NumPy bytes array</span>
            <span class="s2">&quot;npbytes_list&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="sa">b</span><span class="s2">&quot;test1&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;test2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;much</span><span class="se">\x20</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;1&quot;</span><span class="p">]],</span>
            <span class="s2">&quot;pybytes_list&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="sa">b</span><span class="s2">&quot;test1&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;test2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;much longer bytestring&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;1&quot;</span><span class="p">]],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">output_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">compare_nested</span><span class="p">(</span><span class="n">output_pl</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">value</span><span class="p">),</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mismatch in field </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test finalize method that handles remaining data.&quot;&quot;&quot;</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">})</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">=</span> <span class="s2">&quot;test_exp&quot;</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span> <span class="o">=</span> <span class="s2">&quot;path/to/output&quot;</span>

        <span class="c1"># Add data to buffered_emits</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;field1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">emitter</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="s2">&quot;field2&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">emitter</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">pl_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;field1&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
            <span class="s2">&quot;field2&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;field1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;field2&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">20.5</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">num_emits</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Only one emit happened</span>

        <span class="c1"># Mock json_to_parquet</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
            <span class="s2">&quot;ecoli.library.parquet_emitter.json_to_parquet&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">mock_json_to_parquet</span><span class="p">:</span>
            <span class="c1"># Test finalize</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

            <span class="c1"># Verify json_to_parquet was called with truncated data</span>
            <span class="n">mock_json_to_parquet</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mock_json_to_parquet</span><span class="o">.</span><span class="n">call_args</span>
            <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;field1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># Only 1 item should remain</span>
            <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;field1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span>
            <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;field2&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">20.5</span>

        <span class="c1"># Test success flag</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">out_uri</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span><span class="p">,</span>
                <span class="s2">&quot;s.pq&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">})</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">=</span> <span class="s2">&quot;test_exp&quot;</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span> <span class="o">=</span> <span class="s2">&quot;path/to/output&quot;</span>

        <span class="c1"># Create data with multiple agents</span>
        <span class="n">sim_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field1&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span> <span class="s2">&quot;agent2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field1&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}},</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># Should return early without processing</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">num_emits</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span> <span class="o">==</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_batch_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test multiple emits and batch processing.&quot;&quot;&quot;</span>
        <span class="c1"># Small batch size for testing</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

        <span class="c1"># Configuration emit to initialize variables</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">config_data</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Create simulation data</span>
        <span class="n">sim_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}}},</span>
        <span class="p">}</span>

        <span class="c1"># Emit 4 times (should trigger batch processing after 3)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="s2">&quot;agent1&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">10</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data</span><span class="p">)</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Verify batch was processed</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">num_emits</span> <span class="o">==</span> <span class="mi">4</span>

        <span class="c1"># One value should remain in buffer</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">emitter</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">30</span>  <span class="c1"># Last value (3*10)</span></div>



<div class="viewcode-block" id="TestParquetEmitterEdgeCases">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.library.test_parquet_emitter.html#ecoli.library.test_parquet_emitter.TestParquetEmitterEdgeCases">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestParquetEmitterEdgeCases</span><span class="p">:</span>
<div class="viewcode-block" id="TestParquetEmitterEdgeCases.temp_dir">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.library.test_parquet_emitter.html#ecoli.library.test_parquet_emitter.TestParquetEmitterEdgeCases.temp_dir">[docs]</a>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">temp_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a temporary directory for testing.&quot;&quot;&quot;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">tmp</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span></div>


    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;ecoli.library.parquet_emitter.ThreadPoolExecutor&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_multithreaded_buffer_clearing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_executor_class</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test to verify that clearing buffers after submitting to ThreadPoolExecutor</span>
<span class="sd">        doesn&#39;t cause race conditions with the worker thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a real executor and a queue to track what&#39;s passed to json_to_parquet</span>
        <span class="n">real_executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data_capture_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

        <span class="c1"># Setup a custom submit function that will capture the dictionaries</span>
        <span class="c1"># being passed to json_to_parquet before they can be cleared</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">capture_submit</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Make a deep copy of the dictionaries to capture their state</span>
            <span class="n">emit_dict_copy</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;copy&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">pl_types_copy</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Put the copies in our queue for later inspection</span>
            <span class="n">data_capture_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">emit_dict_copy</span><span class="p">,</span> <span class="n">pl_types_copy</span><span class="p">))</span>

            <span class="c1"># Create a future that will complete after a delay to simulate</span>
            <span class="c1"># the worker thread taking time to process</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>

            <span class="c1"># Submit the real work to a real executor</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">delayed_execution</span><span class="p">():</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Delay to ensure main thread moves on</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="n">real_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">delayed_execution</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">future</span>

        <span class="c1"># Configure our mock executor to use the capture_submit function</span>
        <span class="n">mock_executor</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_executor</span><span class="o">.</span><span class="n">submit</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">capture_submit</span>
        <span class="n">mock_executor_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_executor</span>

        <span class="c1"># Initialize the emitter with a small batch size</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="c1"># Configuration emit to initialize variables</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">config_data</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># First emit with simple data</span>
        <span class="n">sim_data1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="s2">&quot;field2&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">}},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data1</span><span class="p">)</span>

        <span class="c1"># Second emit that will trigger batch writing</span>
        <span class="c1"># This data has the same structure</span>
        <span class="n">sim_data2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="s2">&quot;field2&quot;</span><span class="p">:</span> <span class="mi">43</span><span class="p">}},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data2</span><span class="p">)</span>

        <span class="c1"># At this point, the batch should have been submitted to the executor</span>
        <span class="c1"># and the buffers cleared in the main thread</span>

        <span class="c1"># Now immediately emit data with a bunch of additional fields</span>
        <span class="c1"># This should not cause any issues even though the previous data is still</span>
        <span class="c1"># being processed by the worker thread</span>
        <span class="n">sim_data3</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sa">f</span><span class="s2">&quot;field</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data3</span><span class="p">)</span>

        <span class="c1"># Verify the captured data matches what was in buffers before clearing</span>
        <span class="n">captured_data</span><span class="p">,</span> <span class="n">captured_types</span> <span class="o">=</span> <span class="n">data_capture_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">captured_data</span><span class="p">[</span><span class="s2">&quot;experiment_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test_exp&quot;</span>
        <span class="k">assert</span> <span class="n">captured_data</span><span class="p">[</span><span class="s2">&quot;variant&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">captured_data</span><span class="p">[</span><span class="s2">&quot;lineage_seed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">captured_types</span> <span class="o">==</span> <span class="p">{</span>
            <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
            <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
            <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
            <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">captured_data</span><span class="p">,</span> <span class="n">captured_types</span> <span class="o">=</span> <span class="n">data_capture_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">captured_data</span><span class="p">[</span><span class="s2">&quot;field1&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">emitter</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">assert</span> <span class="n">captured_data</span><span class="p">[</span><span class="s2">&quot;field1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">captured_data</span><span class="p">[</span><span class="s2">&quot;field1&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">captured_types</span> <span class="o">==</span> <span class="p">{</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
            <span class="s2">&quot;field1&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">),</span>
            <span class="s2">&quot;field2&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Changed type for field2 to list so should fail</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InvalidOperationError</span><span class="p">):</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="c1"># Cleanup the real executor</span>
        <span class="n">real_executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_variable_shape_detection_at_boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test the fixed vs variable shape field detection logic specifically at</span>
<span class="sd">        the boundary points (start of sim, after disk write).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use a small batch size to quickly hit the boundary</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

        <span class="c1"># Setup: Emit configuration data to intitialize variables</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">config_data</span><span class="p">)</span>

        <span class="c1"># PHASE 1: Test at start of sim (first emit)</span>
        <span class="c1"># Start with a variable-shape field, the code should assume it&#39;s fixed-shape</span>
        <span class="n">sim_data1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;dynamic_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                        <span class="s2">&quot;subtle_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]]),</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data1</span><span class="p">)</span>

        <span class="c1"># Verify it was stored as a fixed-shape numpy array</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>

        <span class="c1"># PHASE 2: Immediately send different shape data</span>
        <span class="c1"># This should trigger conversion to variable-shape</span>
        <span class="n">sim_data2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;dynamic_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>
                        <span class="s2">&quot;subtle_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]]),</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data2</span><span class="p">)</span>

        <span class="c1"># Verify it was converted to a list</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>

        <span class="c1"># PHASE 3: Send one more emit to trigger batch writing</span>
        <span class="n">sim_data3</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;dynamic_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
                        <span class="s2">&quot;subtle_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]]),</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data3</span><span class="p">)</span>

        <span class="c1"># PHASE 4: subtle_array changed shape but we are at the start of a new batch.</span>
        <span class="c1"># ParquetEmitter is designed to assume all arrays are fixed-shape until</span>
        <span class="c1"># proven otherwise (better performance and memory usage). The distinction</span>
        <span class="c1"># between a fixed-shape and variable-shape array is purely an implmentation</span>
        <span class="c1"># detail of the buffering logic. In the end, both are written to Parquet</span>
        <span class="c1"># as variable-shape arrays. As such, even though subtle_array as a whole</span>
        <span class="c1"># is variable in shape, as long as it takes on a consistent shape within</span>
        <span class="c1"># a batch of emits, ParquetEmitter is more than happy to treat it as</span>
        <span class="c1"># fixed-shape and reap the performance benefits.</span>
        <span class="n">sim_data4</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;dynamic_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="s2">&quot;subtle_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">]]),</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data4</span><span class="p">)</span>

        <span class="c1"># Should be instantiated as variable length from last batch</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Should be treated as fixed-shape still</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;subtle_array&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;subtle_array&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Trigger another Parquet write and read them both back to confirm</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data4</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data4</span><span class="p">)</span>

        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">out_uri</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="s2">&quot;history&quot;</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span><span class="p">,</span>
                <span class="s2">&quot;*.pq&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;dynamic_array&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;subtle_array&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">]],</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_expected_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test a few cases that are expected to fail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use a small batch size to quickly hit the boundary</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

        <span class="c1"># Setup: Emit configuration data to intitialize variables</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">config_data</span><span class="p">)</span>

        <span class="c1"># Test initial null/empty list (null types), empty NumPy array (typed)</span>
        <span class="n">sim_data1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;init_null&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;init_empty_list&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;init_empty_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                        <span class="c1"># Setup initial value for later test</span>
                        <span class="s2">&quot;3d_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="s2">&quot;another_3d_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data1</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;init_null&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;init_null&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">pl_types</span><span class="p">[</span><span class="s2">&quot;init_null&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">Null</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;init_empty_list&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;init_empty_list&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">Null</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">pl_types</span><span class="p">[</span><span class="s2">&quot;init_empty_list&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;init_empty_array&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;init_empty_array&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">pl_types</span><span class="p">[</span><span class="s2">&quot;init_empty_array&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">)</span>

        <span class="c1"># Try adding another dimension to empty array</span>
        <span class="n">sim_data2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;init_empty_array&quot;</span><span class="p">:</span> <span class="p">[[]],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span>
            <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span>
                <span class="s2">&quot;Incompatible inner types for field init_empty_array: Float64 and List(Null).&quot;</span>
            <span class="p">),</span>
        <span class="p">):</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data2</span><span class="p">)</span>

        <span class="c1"># Try adding 2D array with non-nulls to 3D array field</span>
        <span class="n">sim_data3</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;3d_array&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span>
            <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span>
                <span class="s2">&quot;Incompatible inner types for field 3d_array: List(Float64) and Float64.&quot;</span>
            <span class="p">),</span>
        <span class="p">):</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data3</span><span class="p">)</span>

        <span class="c1"># Try NumPy unsupported datetime64 resolution</span>
        <span class="n">sim_data4</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;datetime_arr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;2023-01-01T01&quot;</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;2023-01-02T02:02&quot;</span><span class="p">),</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;incorrect NumPy datetime resolution&quot;</span><span class="p">):</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data4</span><span class="p">)</span>

        <span class="c1"># Try NumPy void</span>
        <span class="n">sim_data5</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;npvoid&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;test bytes&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">void</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data5</span><span class="p">)</span>

        <span class="c1"># Try NumPy datetime64 in Python list</span>
        <span class="n">sim_data6</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;mixed_datetime&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;2023-01-01&quot;</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;2023-01-02&quot;</span><span class="p">),</span>
                        <span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;not yet implemented: Nested object types&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data6</span><span class="p">)</span>

        <span class="c1"># Try list of NumPy arrays</span>
        <span class="n">sim_data7</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;mixed_nested&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>
                            <span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                            <span class="kc">None</span><span class="p">,</span>
                        <span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span>
            <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;failed to determine supertype of object and list[i64]&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data7</span><span class="p">)</span>

        <span class="c1"># Try shape-varying 3D NumPy array</span>
        <span class="c1"># Polars can gracefully handle nested Python lists wihout explicit type</span>
        <span class="c1"># information, but not NumPy arrays. For example:</span>
        <span class="c1"># WORKS: pl.Series([[[1, 2], [3, 4]]])</span>
        <span class="c1"># FAILS: pl.Series([np.array([[1, 2], [3, 4]])])</span>
        <span class="c1"># This is thankfully not an issue for 1D NumPy arrays, which are the</span>
        <span class="c1"># only type of ragged NumPy arrays in vEcoli. I do not think it</span>
        <span class="c1"># makes much sense to have a ND NumPy array field with variable</span>
        <span class="c1"># shape anyways as it would still be constrained to a data cube.</span>
        <span class="c1"># Nested Python lists would let you deviate from a strict data cube</span>
        <span class="c1"># and even have null values, if desired.</span>
        <span class="n">sim_data8</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;another_3d_array&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
            <span class="ne">ValueError</span><span class="p">,</span>
            <span class="n">match</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s2">&quot;cannot parse numpy data type dtype(&#39;O&#39;)&quot;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data8</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_nested_nullable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling nullable nested types that increase in depth.&quot;&quot;&quot;</span>
        <span class="n">emitter</span> <span class="o">=</span> <span class="n">ParquetEmitter</span><span class="p">({</span><span class="s2">&quot;out_dir&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
        <span class="c1"># Configuration emit to initialize variables</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;configuration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;variant&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;lineage_seed&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;agent_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">config_data</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="n">sim_data1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;nullable_nested&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data1</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Verify arrays were stored correctly</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">pl_types</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">Null</span>

        <span class="n">sim_data2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;nullable_nested&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data2</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Verify arrays were stored correctly</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">Null</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">pl_types</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">)</span>

        <span class="c1"># One level deeper</span>
        <span class="n">sim_data3</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;nullable_nested&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">[]],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data3</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Verify arrays were stored correctly</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">pl_types</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Null</span><span class="p">))</span>

        <span class="c1"># One level deeper and defines non-null values</span>
        <span class="n">sim_data4</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;agent1&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;nullable_nested&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">[],</span>
                            <span class="p">[[</span><span class="s2">&quot;wow&quot;</span><span class="p">,</span> <span class="s2">&quot;this&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="s2">&quot;deep&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                            <span class="kc">None</span><span class="p">,</span>
                            <span class="p">[[],</span> <span class="kc">None</span><span class="p">],</span>
                        <span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data4</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Check output</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">out_uri</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="s2">&quot;history&quot;</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span><span class="p">,</span>
                <span class="s2">&quot;4.pq&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">[]],</span>
            <span class="p">[[],</span> <span class="p">[[</span><span class="s2">&quot;wow&quot;</span><span class="p">,</span> <span class="s2">&quot;this&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="s2">&quot;deep&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[[],</span> <span class="kc">None</span><span class="p">]],</span>
        <span class="p">]</span>

        <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data1</span><span class="p">)</span>
        <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="c1"># Should remember that we fully defined the type before</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">buffered_emits</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">emitter</span><span class="o">.</span><span class="n">pl_types</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># Emit until batch size and check output</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sim_data1</span><span class="p">)</span>
            <span class="n">emitter</span><span class="o">.</span><span class="n">last_batch_future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Check output</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">out_uri</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="s2">&quot;history&quot;</span><span class="p">,</span>
                <span class="n">emitter</span><span class="o">.</span><span class="n">partitioning_path</span><span class="p">,</span>
                <span class="s2">&quot;8.pq&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="k">assert</span> <span class="n">t</span><span class="p">[</span><span class="s2">&quot;nullable_nested&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">String</span><span class="p">)))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2026, The Vivarium E. coli Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>