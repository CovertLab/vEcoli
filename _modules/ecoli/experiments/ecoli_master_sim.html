

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ecoli.experiments.ecoli_master_sim &mdash; Vivarium E. coli 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Vivarium E. coli
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../stores.html">Stores</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../composites.html">Composites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiments.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc.html">HPC Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gcloud.html">Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ci.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycharm.html">PyCharm Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../diffs.html">Model Differences From wcEcoli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/api_ref.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Vivarium E. coli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ecoli.experiments.ecoli_master_sim</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ecoli.experiments.ecoli_master_sim</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Interface for configuring and running **single-cell** E. coli simulations.</span>

<span class="sd">.. note::</span>
<span class="sd">    Simulations can be configured to divide through this interface, but</span>
<span class="sd">    full colony-scale simulations are best run using the</span>
<span class="sd">    :py:mod:`~ecoli.experiments.ecoli_engine_process` module for efficient</span>
<span class="sd">    multiprocessing.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># mypy: disable-error-code=attr-defined</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pstats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.core.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.core.composer</span><span class="w"> </span><span class="kn">import</span> <span class="n">deep_merge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.core.process</span><span class="w"> </span><span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.core.serialize</span><span class="w"> </span><span class="kn">import</span> <span class="n">deserialize_value</span><span class="p">,</span> <span class="n">serialize_value</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.library.dict_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">deep_merge_check</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.library.topology</span><span class="w"> </span><span class="kn">import</span> <span class="n">inverse_topology</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.library.topology</span><span class="w"> </span><span class="kn">import</span> <span class="n">assoc_path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.library.logging_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">write_json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ecoli.composites.ecoli_master</span>

<span class="c1"># Environment composer for spatial environment sim</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ecoli.composites.environment.lattice</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.processes</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_registry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.processes.cell_division</span><span class="w"> </span><span class="kn">import</span> <span class="n">DivisionDetected</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.processes.registries</span><span class="w"> </span><span class="kn">import</span> <span class="n">topology_registry</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">configs</span><span class="w"> </span><span class="kn">import</span> <span class="n">CONFIG_DIR_PATH</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.library.parquet_emitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParquetEmitter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.library.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">not_a_process</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils.filepath</span><span class="w"> </span><span class="kn">import</span> <span class="n">ROOT_PATH</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">runscripts.workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">LIST_KEYS_TO_MERGE</span>


<div class="viewcode-block" id="TimeLimitError">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.TimeLimitError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimeLimitError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error raised when ``fail_at_max_duration`` is True and simulation</span>
<span class="sd">    reaches ``max_duration``.&quot;&quot;&quot;</span>

    <span class="k">pass</span></div>



<div class="viewcode-block" id="tuplify_topology">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.tuplify_topology">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tuplify_topology</span><span class="p">(</span><span class="n">topology</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON files allow lists but do not allow tuples. This function</span>
<span class="sd">    transforms the list paths in topologies loaded from JSON into</span>
<span class="sd">    standard tuple paths.</span>

<span class="sd">    Args:</span>
<span class="sd">        topology: Topology to recursively iterate over, converting</span>
<span class="sd">            all paths to tuples</span>

<span class="sd">    Returns:</span>
<span class="sd">        Topology with tuple paths (e.g. ``[&#39;bulk&#39;]`` turns into ``(&#39;bulk&#39;,)``)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tuplified_topology</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">tuplified_topology</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tuplify_topology</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">tuplified_topology</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tuplified_topology</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tuplified_topology</span></div>



<div class="viewcode-block" id="get_git_revision_hash">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.get_git_revision_hash">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_git_revision_hash</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns current Git hash for model repository to include in metadata</span>
<span class="sd">    that is emitted when starting a simulation.</span>

<span class="sd">    First tries to run git command if git is installed.</span>
<span class="sd">    If that fails, tries to get the value from IMAGE_GIT_HASH environment variable.</span>
<span class="sd">    Raises an error if both methods fail.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try to run git command</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="n">CONFIG_DIR_PATH</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
        <span class="k">pass</span>  <span class="c1"># Continue to next method if git command fails</span>

    <span class="c1"># Try to get from environment variable</span>
    <span class="n">env_hash</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IMAGE_GIT_HASH&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env_hash</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">env_hash</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Raise error if both methods fail</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
        <span class="s2">&quot;Could not determine Git hash: git command failed and IMAGE_GIT_HASH &quot;</span>
        <span class="s2">&quot;environment variable is not set. Either install git, set the environment &quot;</span>
        <span class="s2">&quot;variable, or run from a container with this information.&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="get_git_diff">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.get_git_diff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_git_diff</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns Git diff of model repository to include in metadata that is</span>
<span class="sd">    emitted when starting a simulation.</span>

<span class="sd">    First tries to run git command if git is installed.</span>
<span class="sd">    If that fails, tries to read the diff from source-info/git-diff.txt file.</span>
<span class="sd">    Raises an error if both methods fail.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="n">CONFIG_DIR_PATH</span><span class="p">,</span> <span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">):</span>
        <span class="k">pass</span>  <span class="c1"># Continue to next method if git command fails</span>

    <span class="c1"># Try to read from git-diff.txt file</span>
    <span class="n">diff_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROOT_PATH</span><span class="p">,</span> <span class="s2">&quot;source-info&quot;</span><span class="p">,</span> <span class="s2">&quot;git_diff.txt&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">diff_file_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">diff_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Continue to next method if file read fails</span>

    <span class="c1"># Raise error if both methods fail</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
        <span class="s2">&quot;Could not determine Git diff: git command failed and &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">diff_file_path</span><span class="si">}</span><span class="s2"> does not exist or cannot be read. &quot;</span>
        <span class="s2">&quot;Either install git, create the git-diff.txt file, &quot;</span>
        <span class="s2">&quot;or run from a container with this information.&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="report_profiling">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.report_profiling">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">report_profiling</span><span class="p">(</span><span class="n">stats</span><span class="p">:</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prints out a summary of profiling statistics when ``profile`` option</span>
<span class="sd">    is ``True`` in the config given to</span>
<span class="sd">    :py:class:`~ecoli.experiments.ecoli_master_sim.EcoliSim`</span>

<span class="sd">    Args:</span>
<span class="sd">        stats: Profiling statistics.&quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">stats_keys</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">get_print_list</span><span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;(next_update)|(calculate_request)|(evolve_state)&quot;</span><span class="p">,)</span>
    <span class="p">)</span>
    <span class="n">summed_stats</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">stats_keys</span><span class="p">:</span>
        <span class="n">key_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">cumtime</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">key_stats</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">summed_stats</span><span class="p">[(</span><span class="n">path</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">func</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">summed_stats</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">path</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">func</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">cumtime</span>
        <span class="p">)</span>
    <span class="n">summed_stats_inverse_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">time</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">summed_stats</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Per-process profiling:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">summed_stats_inverse_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">summed_stats_inverse_map</span><span class="p">[</span><span class="n">time</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">(): </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Overall Profile:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s2">&quot;cumtime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_key_value_args">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.parse_key_value_args">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_key_value_args</span><span class="p">(</span><span class="n">args_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses key-value pairs specified as strings of the form ``key=value``</span>
<span class="sd">    via CLI. See ``emitter_arg`` option in</span>
<span class="sd">    :py:class:`~ecoli.experiments.ecoli_master_sim.SimConfig`.</span>

<span class="sd">    Args:</span>
<span class="sd">        argument_string: Key-value pair as a string of the form ``key=value``</span>

<span class="sd">    Returns:</span>
<span class="sd">        ``[key, value]``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create an empty dictionary to store the parsed key-value pairs</span>
    <span class="n">parsed_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">args_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">parsed_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Argument &#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&#39; is not in the form key=value&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed_dict</span></div>



<div class="viewcode-block" id="prepare_save_state">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.prepare_save_state">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_save_state</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepares simulation state to be saved to a JSON file by pruning</span>
<span class="sd">    unsaveable values and adding necessary metadata. Mutates in-place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Processes can&#39;t be serialized</span>
    <span class="k">del</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">]</span>
    <span class="c1"># Bulk random state can&#39;t be serialized</span>
    <span class="k">del</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;allocator_rng&quot;</span><span class="p">]</span>
    <span class="c1"># Save bulk and unique dtypes</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;bulk_dtypes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;unique_dtypes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mols</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;unique_dtypes&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mols</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span></div>



<div class="viewcode-block" id="SimConfig">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.SimConfig">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimConfig</span><span class="p">:</span>
    <span class="c1">#: Path to default JSON configuration file.</span>
    <span class="n">default_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_DIR_PATH</span><span class="p">,</span> <span class="s2">&quot;default.json&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stores configuration options for a simulation. Has dictionary-like</span>
<span class="sd">        interface (e.g. bracket indexing, get, keys).</span>

<span class="sd">        Attributes:</span>
<span class="sd">            config: Current configuration.</span>
<span class="sd">            parser: Argument parser for the command-line interface.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Configuration options. If not provided, the default</span>
<span class="sd">                configuration is loaded from the file path</span>
<span class="sd">                :py:data:`~ecoli.experiments.ecoli_master_sim.SimConfig.default_config_path`.</span>
<span class="sd">            parser: Useful for scripts that leverage the inheritance features</span>
<span class="sd">                of the JSON config files but want to have their own CLI args</span>
<span class="sd">                for clarity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_from_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_config_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;ecoli_master&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--config&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_config_path</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;Path to configuration file for the simulation. &quot;</span>
                    <span class="s2">&quot;All key-value pairs in this file will be applied on top &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;of the options defined in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">default_config_path</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--experiment_id&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;ID for this experiment. A UUID will be generated if &quot;</span>
                    <span class="s1">&#39;this argument is not used and &quot;experiment_id&quot; is null &#39;</span>
                    <span class="s2">&quot;in the configuration file.&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--emitter&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timeseries&quot;</span><span class="p">,</span> <span class="s2">&quot;print&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">],</span>
                <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;Emitter to use. Timeseries uses RAMEmitter, print emits to&quot;</span>
                    <span class="s2">&quot; stdout, and parquet (recommended) saves output to a&quot;</span>
                    <span class="s2">&quot; directory on disk specified using --emitter-arg (e.g.&quot;</span>
                    <span class="s2">&quot; --emitter-arg out_dir=&#39;out&#39;)&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--emitter_arg&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;Key-value pairs, separated by `=`, to include in emitter config.&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--seed&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Random seed.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--max_duration&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time to run the simulation for.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--generations&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of generations to run the simulation for.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--log_updates&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">BooleanOptionalAction</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;Save updates from each process if this flag is set, &quot;</span>
                    <span class="s2">&quot;e.g. for use with blame plot.&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--raw_output&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">BooleanOptionalAction</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;Whether to return data in raw format (dictionary&quot;</span>
                    <span class="s2">&quot; where keys are times, values are states). Requires&quot;</span>
                    <span class="s2">&quot; timeseries emitter (RAMEmitter).&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--agent_id&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Agent ID.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--sim_data_path&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the sim_data (pickle from ParCa) to use for this experiment.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--profile&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">BooleanOptionalAction</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print profiling information at the end.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--initial_state_file&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of initial state file (omit &quot;.json&quot; extension) under data/&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--initial_state_overrides&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of initial state overrides (omit &quot;.json&quot; extension) under &#39;</span>
                <span class="s2">&quot;data/overrides&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--daughter_outdir&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory in which to store daughter cell state JSONs.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--variant&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of variant.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--lineage_seed&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Seed used for first cell in lineage.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--initial_global_time&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Initial time in context of whole lineage.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--fail_at_max_duration&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">BooleanOptionalAction</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Simulation will raise TimeLimitException upon reaching max_duration.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="SimConfig.merge_config_dicts">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.SimConfig.merge_config_dicts">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_config_dicts</span><span class="p">(</span><span class="n">d1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">d2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to safely merge two config dictionaries. Config</span>
<span class="sd">        options whose values are lists (e.g. ``save_times``, ``add_processes``,</span>
<span class="sd">        etc.) are handled separately so that the lists from each config are</span>
<span class="sd">        concatenated in the merged output.</span>

<span class="sd">        Args:</span>
<span class="sd">            d1: Config to mutate by merging in ``d2``.</span>
<span class="sd">            d2: Config to merge into ``d1``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">LIST_KEYS_TO_MERGE</span><span class="p">:</span>
            <span class="n">d2</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;engine_process_reports&quot;</span><span class="p">:</span>
                <span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="c1"># Ensures there are no duplicates in d2</span>
            <span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">deep_merge</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimConfig.update_from_json">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.SimConfig.update_from_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads config dictionary from file path ``path`` and merges it into</span>
<span class="sd">        the currently loaded config.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: The file path of the JSON config to merge in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">new_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">new_config</span> <span class="o">=</span> <span class="n">deserialize_value</span><span class="p">(</span><span class="n">new_config</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">config_name</span> <span class="ow">in</span> <span class="n">new_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inherit_from&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG_DIR_PATH</span><span class="p">,</span> <span class="n">config_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_from_json</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_config_dicts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="n">new_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimConfig.update_from_cli">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.SimConfig.update_from_cli">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_cli</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parses command-line options defined in ``__init__`` and</span>
<span class="sd">        updates config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">emitter_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">emitter_arg</span> <span class="o">=</span> <span class="n">parse_key_value_args</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">emitter_arg</span><span class="p">)</span>
        <span class="c1"># First load in a configuration file, if one was specified.</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_from_json</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="c1"># Then override the configuration file with any command-line</span>
        <span class="c1"># options.</span>
        <span class="n">cli_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;config&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_config_dicts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="n">cli_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimConfig.update_from_dict">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.SimConfig.update_from_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates loaded config with user-specified dictionary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_config_dicts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="n">dict_config</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<div class="viewcode-block" id="SimConfig.get">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.SimConfig.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<div class="viewcode-block" id="SimConfig.keys">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.SimConfig.keys">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>


<div class="viewcode-block" id="SimConfig.to_dict">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.SimConfig.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="EcoliSim">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EcoliSim</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main interface for running single-cell E. coli simulations. Typically</span>
<span class="sd">        instantiated using one of two methods:</span>

<span class="sd">        1. :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.from_file`</span>
<span class="sd">        2. :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.from_cli`</span>

<span class="sd">        Config options can be modified after the creation of an</span>
<span class="sd">        :py:class:`~ecoli.experiments.ecoli_master_sim.EcoliSim` object</span>
<span class="sd">        in one of two ways.</span>

<span class="sd">        1. ``sim.max_duration = 100``</span>
<span class="sd">        2. ``sim.config[&#39;max_duration&#39;] = 100``</span>

<span class="sd">        Args:</span>
<span class="sd">            config: Automatically generated from</span>
<span class="sd">                :py:class:`~ecoli.experiments.ecoli_master_sim.SimConfig` when</span>
<span class="sd">                :py:class:`~ecoli.experiments.ecoli_master_sim.EcoliSim` is</span>
<span class="sd">                instantiated using</span>
<span class="sd">                :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.from_file`</span>
<span class="sd">                or :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.from_cli`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Do some datatype pre-processesing</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;processes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">process</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;processes&quot;</span><span class="p">]}</span>

        <span class="c1"># Keep track of base experiment id</span>
        <span class="c1"># in case multiple simulations are run with suffix_time = True.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id_base</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;experiment_id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;vivarium.core.composer.Composite: Contains the fully instantiated </span>
<span class="sd">        processes, steps, topologies, and flow necessary to run simulation. </span>
<span class="sd">        Generated by </span>
<span class="sd">        :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.build_ecoli` and </span>
<span class="sd">        cleared when :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.run` </span>
<span class="sd">        is called to potentially free up memory after division.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generated_initial_state</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;dict: Fully populated initial state for simulation. Generated by </span>
<span class="sd">        :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.build_ecoli` and </span>
<span class="sd">        cleared when :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.run` </span>
<span class="sd">        is called to potentially free up memory after division.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;vivarium.core.engine.Engine: Engine that runs the simulation. </span>
<span class="sd">        Instantiated by </span>
<span class="sd">        :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.run`.&quot;&quot;&quot;</span>

        <span class="c1"># Unpack config using Descriptor protocol:</span>
        <span class="c1"># All of the entries in config are translated to properties</span>
        <span class="c1"># (of EcoliSim class) that get/set an entry in self.config.</span>
        <span class="c1">#</span>
        <span class="c1"># For example:</span>
        <span class="c1">#</span>
        <span class="c1"># &gt;&gt; sim = EcoliSim.from_file()</span>
        <span class="c1"># &gt;&gt; sim.max_duration</span>
        <span class="c1">#    10</span>
        <span class="c1"># &gt;&gt; sim.config[&#39;max_duration&#39;]</span>
        <span class="c1">#    10</span>
        <span class="c1"># &gt;&gt; sim.max_duration = 100</span>
        <span class="c1"># &gt;&gt; sim.config[&#39;max_duration&#39;]</span>
        <span class="c1">#    100</span>

        <span class="k">class</span><span class="w"> </span><span class="nc">ConfigEntry</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

            <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">config_entry</span> <span class="o">=</span> <span class="n">ConfigEntry</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">EcoliSim</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">config_entry</span><span class="p">)</span>

<div class="viewcode-block" id="EcoliSim.from_file">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.from_file">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">CONFIG_DIR_PATH</span> <span class="o">+</span> <span class="s2">&quot;default.json&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;EcoliSim&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to instantiate</span>
<span class="sd">        :py:class:`~ecoli.experiments.ecoli_master_sim.EcoliSim` with</span>
<span class="sd">        a config loaded from the JSON at ``filepath`` by</span>
<span class="sd">        :py:class:`~ecoli.experiments.ecoli_master_sim.SimConfig`.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: String filepath of JSON file with config options to</span>
<span class="sd">                apply on top of the options laid out in the default JSON</span>
<span class="sd">                located at the default value for ``filepath``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">SimConfig</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update_from_json</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">EcoliSim</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></div>


<div class="viewcode-block" id="EcoliSim.from_cli">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.from_cli">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_cli</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;EcoliSim&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to instantiate</span>
<span class="sd">        :py:class:`~ecoli.experiments.ecoli_master_sim.EcoliSim` with</span>
<span class="sd">        a config loaded from the command-line arguments parsed by</span>
<span class="sd">        :py:class:`~ecoli.experiments.ecoli_master_sim.SimConfig`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">SimConfig</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update_from_cli</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">EcoliSim</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></div>


<div class="viewcode-block" id="EcoliSim._retrieve_processes">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim._retrieve_processes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_retrieve_processes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">processes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">add_processes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">exclude_processes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">swap_processes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Process</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve process classes from</span>
<span class="sd">        :py:data:`~vivarium.core.registry.process_registry` (processes are</span>
<span class="sd">        registered in ``ecoli/processes/__init__.py``).</span>

<span class="sd">        Args:</span>
<span class="sd">            processes: Base list of process names to retrieve classes for</span>
<span class="sd">            add_processes: Additional process names to retrieve classes for</span>
<span class="sd">            exclude_processes: Process names to not retrieve classes for</span>
<span class="sd">            swap_processes: Mapping of process names to the names of the</span>
<span class="sd">                processes they should be swapped for. It is assumed that</span>
<span class="sd">                the swapped processes share the same topologies.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mapping of process names to process classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">process_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">processes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">add_processes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">process_name</span> <span class="ow">in</span> <span class="n">exclude_processes</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">process_name</span> <span class="ow">in</span> <span class="n">swap_processes</span><span class="p">:</span>
                <span class="n">process_name</span> <span class="o">=</span> <span class="n">swap_processes</span><span class="p">[</span><span class="n">process_name</span><span class="p">]</span>
            <span class="n">process_class</span> <span class="o">=</span> <span class="n">process_registry</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">process_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">process_class</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unknown process with name </span><span class="si">{</span><span class="n">process_name</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Did you call process_registry.register() in &quot;</span>
                    <span class="s2">&quot;ecoli/processes/__init__.py?&quot;</span>
                <span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">process_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_class</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="EcoliSim._retrieve_topology">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim._retrieve_topology">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_retrieve_topology</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topology</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
        <span class="n">processes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">swap_processes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">log_updates</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves topologies for processes from</span>
<span class="sd">        :py:data:`~ecoli.processes.registries.topology_registry`.</span>

<span class="sd">        Args:</span>
<span class="sd">            topology: Mapping of process names to user-specified topologies.</span>
<span class="sd">                Will be merged with topology from topology_registry, if exists.</span>
<span class="sd">            processes: List of process names for which to retrive topologies.</span>
<span class="sd">            swap_processes: Mapping of process names to the names of processes</span>
<span class="sd">                to swap them for. By default, the new processes are assumed to</span>
<span class="sd">                have the same topology as the processes they replaced. When</span>
<span class="sd">                this is not the case, users can add/modify the original process</span>
<span class="sd">                topology with custom values in ``topology`` under either the new</span>
<span class="sd">                or the old process name.</span>
<span class="sd">            log_updates: Whether to emit process updates. Adds topology for</span>
<span class="sd">                ``log_update`` port.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mapping of process names to process topologies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">original_processes</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">swap_processes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
            <span class="c1"># Start from default topology if it exists</span>
            <span class="n">original_process</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">process</span>
                <span class="k">if</span> <span class="n">process</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">swap_processes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">else</span> <span class="n">original_processes</span><span class="p">[</span><span class="n">process</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">process_topology</span> <span class="o">=</span> <span class="n">topology_registry</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">original_process</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">process_topology</span><span class="p">:</span>
                <span class="n">process_topology</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">process_topology</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">process_topology</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Allow the user to override default topology</span>
            <span class="k">if</span> <span class="n">original_process</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">deep_merge</span><span class="p">(</span>
                    <span class="n">process_topology</span><span class="p">,</span> <span class="n">tuplify_topology</span><span class="p">(</span><span class="n">topology</span><span class="p">[</span><span class="n">original_process</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="c1"># For swapped processes, do additional overrides if provided</span>
            <span class="k">if</span> <span class="n">process</span> <span class="o">!=</span> <span class="n">original_process</span> <span class="ow">and</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">topology</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">deep_merge</span><span class="p">(</span><span class="n">process_topology</span><span class="p">,</span> <span class="n">tuplify_topology</span><span class="p">(</span><span class="n">topology</span><span class="p">[</span><span class="n">process</span><span class="p">]))</span>
            <span class="n">result</span><span class="p">[</span><span class="n">process</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_topology</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="EcoliSim._retrieve_process_configs">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim._retrieve_process_configs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_retrieve_process_configs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">process_configs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">processes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up process configs to be interpreted by</span>
<span class="sd">        :py:meth:`~ecoli.composites.ecoli_master.Ecoli.generate_processes_and_steps`.</span>

<span class="sd">        Args:</span>
<span class="sd">            process_configs: Mapping of process names to user-specified process</span>
<span class="sd">                configuration dictionaries.</span>
<span class="sd">            processes: List of process names to set up process config for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mapping of process names to process configs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">process</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">process</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">process</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sim_data&quot;</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="EcoliSim.build_ecoli">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.build_ecoli">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_ecoli</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the E. coli composite. **MUST** be called before calling</span>
<span class="sd">        :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.run`.</span>

<span class="sd">        For all processes in ``config[&#39;processes&#39;]``:</span>

<span class="sd">        1. Retrieves process class from</span>
<span class="sd">        :py:data:`~vivarium.core.registry.process_registry`, which is</span>
<span class="sd">        populated in ``ecoli/processes/__init__.py``.</span>

<span class="sd">        2. Retrieves process topology from</span>
<span class="sd">        :py:data:`~ecoli.processes.registries.topology_registry` and merge</span>
<span class="sd">        with user-specified topology from ``config[&#39;topology&#39;]``, if applicable</span>

<span class="sd">        3. Retrieves process configs from ``config[&#39;process_configs&#39;]``</span>
<span class="sd">        if present, else indicate that process config should be loaded from</span>
<span class="sd">        pickled simulation data using</span>
<span class="sd">        :py:meth:`~ecoli.library.sim_data.LoadSimData.get_config_by_name`</span>

<span class="sd">        Adds spatial environment if ``config[&#39;spatial_environment&#39;]`` is</span>
<span class="sd">        ``True``. Spatial environment config options are loaded from</span>
<span class="sd">        ``config[&#39;spatial_environment_config`]``. See</span>
<span class="sd">        ``configs/spatial.json`` for an example.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># build processes, topology, configs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_processes</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_processes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exclude_processes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swap_processes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_topology</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_processes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_updates</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_process_configs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_configs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span>
        <span class="p">)</span>

        <span class="c1"># initialize the ecoli composer</span>
        <span class="n">ecoli_composer</span> <span class="o">=</span> <span class="n">ecoli</span><span class="o">.</span><span class="n">composites</span><span class="o">.</span><span class="n">ecoli_master</span><span class="o">.</span><span class="n">Ecoli</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># set path at which agent is initialized</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_environment</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;agents&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># get initial state</span>
        <span class="n">initial_cell_state</span> <span class="o">=</span> <span class="n">ecoli_composer</span><span class="o">.</span><span class="n">initial_state</span><span class="p">()</span>
        <span class="n">initial_cell_state</span> <span class="o">=</span> <span class="n">assoc_path</span><span class="p">({},</span> <span class="n">path</span><span class="p">,</span> <span class="n">initial_cell_state</span><span class="p">)</span>

        <span class="c1"># generate the composite at the path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span> <span class="o">=</span> <span class="n">ecoli_composer</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># Some processes define their own initial_state methods</span>
        <span class="c1"># Incoporate them into the generated initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generated_initial_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">initial_state</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;initial_state&quot;</span><span class="p">:</span> <span class="n">initial_cell_state</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># merge a lattice composite for the spatial environment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_environment</span><span class="p">:</span>
            <span class="n">initial_state_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_environment_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;initial_state_config&quot;</span>
            <span class="p">)</span>
            <span class="n">environment_composite</span> <span class="o">=</span> <span class="n">ecoli</span><span class="o">.</span><span class="n">composites</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">Lattice</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spatial_environment_config</span>
            <span class="p">)</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
            <span class="n">initial_environment</span> <span class="o">=</span> <span class="n">environment_composite</span><span class="o">.</span><span class="n">initial_state</span><span class="p">(</span>
                <span class="n">initial_state_config</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">environment_composite</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generated_initial_state</span> <span class="o">=</span> <span class="n">deep_merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generated_initial_state</span><span class="p">,</span> <span class="n">initial_environment</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="EcoliSim.update_experiment">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.update_experiment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_to_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the E. coli simulation for a specified amount of time. If the</span>
<span class="sd">        simulation reaches a division event and ``config[&#39;generations&#39;]`` is set,</span>
<span class="sd">        it will save the daughter cell states to JSON files in the directory</span>
<span class="sd">        specified by ``config[&#39;daughter_outdir&#39;]``. Also creates a file</span>
<span class="sd">        ``division_time.sh`` that, when executed, sets the environment variable</span>
<span class="sd">        ``division_time`` to the time at which division occurred (used in</span>
<span class="sd">        Nextflow workflow runs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">time_to_update</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DivisionDetected</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="n">not_a_process</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">agent_state</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">prepare_save_state</span><span class="p">(</span><span class="n">agent_state</span><span class="p">)</span>
                <span class="n">daughter_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">daughter_outdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;daughter_state_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span>
                <span class="p">)</span>
                <span class="n">write_json</span><span class="p">(</span><span class="n">daughter_path</span><span class="p">,</span> <span class="n">agent_state</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Divided at t = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">global_time</span><span class="si">}</span><span class="s2"> after &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">global_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">initial_global_time</span><span class="si">}</span><span class="s2"> sec.&quot;</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;division_time.sh&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;export division_time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">global_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Tell Parquet emitter that simulation was successful</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">emitter</span><span class="p">,</span> <span class="n">ParquetEmitter</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">emitter</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">emitter</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
            <span class="c1"># Exit so that EcoliSim.run() does not raise TimeLimitError</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="c1"># Finish writing any buffered emits to Parquet files if the simulation</span>
            <span class="c1"># encounters any error (including KeyboardInterrupt)</span>
            <span class="c1"># We use a bare except instead of finally because we don&#39;t want to</span>
            <span class="c1"># run finalize() every time update_experiment is called to advance to</span>
            <span class="c1"># save times in save_states()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">emitter</span><span class="p">,</span> <span class="n">ParquetEmitter</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">emitter</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="EcoliSim.save_states">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.save_states">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the simulation while saving the states of specific</span>
<span class="sd">        timesteps to files named ``data/vivecoli_t{time}.json``. Invoked by</span>
<span class="sd">        :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.run`</span>
<span class="sd">        if ``config[&#39;save&#39;] == True``. State is saved as a JSON that</span>
<span class="sd">        can be reloaded into a simulation as described in</span>
<span class="sd">        :py:meth:`~ecoli.composites.ecoli_master.Ecoli.initial_state`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_times</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_duration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Config contains save_time (</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">) &gt; total &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;time (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_duration</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_times</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">time_to_next_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time_to_next_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_times</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_experiment</span><span class="p">(</span><span class="n">time_to_next_save</span><span class="p">)</span>
            <span class="n">time_elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="n">not_a_process</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">agent_state</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">prepare_save_state</span><span class="p">(</span><span class="n">agent_state</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prepare_save_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">write_json</span><span class="p">(</span><span class="s2">&quot;data/vivecoli_t&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_elapsed</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished saving the state at t = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_elapsed</span><span class="p">))</span>
        <span class="n">time_remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_duration</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">time_remaining</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_experiment</span><span class="p">(</span><span class="n">time_remaining</span><span class="p">)</span></div>


<div class="viewcode-block" id="EcoliSim.run">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create and run an EcoliSim experiment. If the simulation reaches</span>
<span class="sd">        the maximum duration specified by ``config[&#39;max_duration&#39;]``, it will</span>
<span class="sd">        raise a :py:class:`~ecoli.experiments.ecoli_master_sim.TimeLimitError`</span>
<span class="sd">        if ``config[&#39;fail_at_max_duration&#39;]`` is ``True``.</span>

<span class="sd">        .. WARNING::</span>
<span class="sd">            Run :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.build_ecoli`</span>
<span class="sd">            before calling :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.run`!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Build the composite by calling build_ecoli() </span><span class="se">\</span>
<span class="s2">                before calling run().&quot;</span>
            <span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;output_metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_metadata</span><span class="p">()</span>
        <span class="c1"># make the experiment</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emitter</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emitter_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emitter</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">emitter_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emitter_arg</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">emitter_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">emitter</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;out_dir&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emitter_config</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="s2">&quot;out_uri&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emitter_config</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Must provide out_dir or out_uri&quot;</span>
                        <span class="s2">&quot; as emitter argument for parquet emitter.&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Emitter option must be a string&quot;</span>
                <span class="s2">&quot; representing the emitter type with any additional config&quot;</span>
                <span class="s2">&quot; options under the emitter_arg key.&quot;</span>
            <span class="p">)</span>
        <span class="n">experiment_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
            <span class="s2">&quot;processes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">processes</span><span class="p">,</span>
            <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span>
            <span class="s2">&quot;flow&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span>
            <span class="s2">&quot;topology&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span>
            <span class="s2">&quot;initial_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_initial_state</span><span class="p">,</span>
            <span class="s2">&quot;progress_bar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">,</span>
            <span class="s2">&quot;emit_topology&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit_topology</span><span class="p">,</span>
            <span class="s2">&quot;emit_processes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit_processes</span><span class="p">,</span>
            <span class="s2">&quot;emit_config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit_config</span><span class="p">,</span>
            <span class="s2">&quot;emitter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emitter_config</span><span class="p">,</span>
            <span class="s2">&quot;initial_global_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_global_time</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">:</span>
            <span class="c1"># Store backup of base experiment ID,</span>
            <span class="c1"># in case multiple experiments are run in a row</span>
            <span class="c1"># with suffix_time = True.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id_base</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_time</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id_base</span><span class="si">}</span><span class="s2">_%Y%m%d-%H%M%S&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Special characters can break Hive partitioning so do not allow them</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">!=</span> <span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Experiment ID cannot contain special characters&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;that change the string when URL quoted: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; != </span><span class="si">{</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">experiment_config</span><span class="p">[</span><span class="s2">&quot;experiment_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span>
        <span class="n">experiment_config</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>

        <span class="c1"># Since unique numpy updater is an class method, internal</span>
        <span class="c1"># deepcopying in vivarium-core causes this warning to appear</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
            <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Incompatible schema &quot;</span>
            <span class="s2">&quot;assignment at .+ Trying to assign the value &lt;bound method &quot;</span>
            <span class="sa">r</span><span class="s2">&quot;UniqueNumpyUpdater\.updater .+ to key updater, which already &quot;</span>
            <span class="sa">r</span><span class="s2">&quot;has the value &lt;bound method UniqueNumpyUpdater\.updater&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">(</span><span class="o">**</span><span class="n">experiment_config</span><span class="p">)</span>

        <span class="c1"># Only emit designated stores if specified</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;emit_paths&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_emit_values</span><span class="p">([</span><span class="nb">tuple</span><span class="p">()],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_emit_values</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;emit_paths&quot;</span><span class="p">],</span>
                <span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Clean up unnecessary references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generated_initial_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">initial_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">del</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">experiment_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># run the experiment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_states</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_experiment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_duration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">:</span>
            <span class="n">report_profiling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_at_max_duration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TimeLimitError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Exceeded maximum simulation time: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_duration</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="EcoliSim.query">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.query">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query data that was emitted to RAMEmitter (``config[&#39;emitter&#39;] == &#39;timeseries&#39;``).</span>
<span class="sd">        For the Parquet emitter, query sim output with an analysis script run using</span>
<span class="sd">        :py:mod:`runscripts.analysis` or with ad-hoc DuckDB SQL queries built using</span>
<span class="sd">        :py:func:`~ecoli.library.parquet_emitter.dataset_sql` as a base.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: List of tuple-style paths in the simulation state to</span>
<span class="sd">                retrieve emitted values for. Returns all emitted data</span>
<span class="sd">                if ``None``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of emitted data in one of two forms.</span>

<span class="sd">            * Raw data (if ``self.raw_output``): Data is keyed by time</span>
<span class="sd">              (e.g. ``{0: {&#39;data&#39;: ...}, 1: {&#39;data&#39;: ...}, ...}``)</span>

<span class="sd">            * Timeseries: Data is reorganized to match the structure of the</span>
<span class="sd">              simulation state. Leaf values in the returned dictionary are</span>
<span class="sd">              lists of the simulation state value over time (e.g.</span>
<span class="sd">              ``{&#39;data&#39;: [..., ..., ...]}``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">emitter_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;timeseries&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Query method only works for timeseries emitter.&quot;</span>
                <span class="s2">&quot; For Parquet emitter, either write an analysis script to be run&quot;</span>
                <span class="s2">&quot; using runscripts/analysis.py or build off the DuckDB SQL query&quot;</span>
                <span class="s2">&quot; returned by ecoli.library.parquet_emitter.dataset_sql.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Retrieve queried data (all if not specified)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_output</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">emitter</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli_experiment</span><span class="o">.</span><span class="n">emitter</span><span class="o">.</span><span class="n">get_timeseries</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="EcoliSim.merge">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.merge">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;EcoliSim&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine settings from this EcoliSim with another, overriding</span>
<span class="sd">        current settings with those from the other EcoliSim.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: Simulation with settings to override current simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deep_merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="EcoliSim.get_metadata">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.get_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compiles all simulation settings, git hash, and process list into a single</span>
<span class="sd">        dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create metadata of this experiment to be emitted,</span>
        <span class="c1"># namely the config of this EcoliSim object</span>
        <span class="c1"># with an additional key for the current git hash.</span>
        <span class="c1"># Goal is to save enough information to reproduce the experiment.</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;git_hash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_git_revision_hash</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;git_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_git_diff</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;processes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;processes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="EcoliSim.output_metadata">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.output_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">output_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters all ports schemas to include only output metadata</span>
<span class="sd">        located at the path ``(&#39;_properties&#39;, &#39;metadata&#39;)`` for each schema by</span>
<span class="sd">        invoking :py:func:`~.extract_metadata`.</span>
<span class="sd">        See :py:meth:`~ecoli.library.schema.listener_schema` for usage details.</span>

<span class="sd">        This dictionary of output metadata is flattened (see :py:func:`~ecoli.library.parquet_emitter.flatten_dict`)</span>
<span class="sd">        into columns with prefix :py:data:`~ecoli.library.parquet_emitter.METADATA_PREFIX`</span>
<span class="sd">        and emitted as part of the simulation config by the Parquet emitter. It can</span>
<span class="sd">        be retrieved later using :py:func:`~ecoli.library.parquet_emitter.field_metadata`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divide</span><span class="p">:</span>
            <span class="n">processes_and_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">]</span>
            <span class="n">processes_and_steps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">])</span>
            <span class="n">topologies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">topology</span><span class="p">[</span><span class="s2">&quot;agents&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">processes_and_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">processes</span>
            <span class="n">processes_and_steps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
            <span class="n">topologies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecoli</span><span class="o">.</span><span class="n">topology</span>
        <span class="n">output_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">proc_name</span><span class="p">,</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">processes_and_steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">proc_ports_schema</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">get_schema</span><span class="p">()</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">extract_metadata</span><span class="p">(</span><span class="n">proc_ports_schema</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extracted</span><span class="p">:</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="n">inverse_topology</span><span class="p">((),</span> <span class="n">extracted</span><span class="p">,</span> <span class="n">topologies</span><span class="p">[</span><span class="n">proc_name</span><span class="p">])</span>
                <span class="n">output_metadata</span> <span class="o">=</span> <span class="n">deep_merge_check</span><span class="p">(</span>
                    <span class="n">output_metadata</span><span class="p">,</span> <span class="n">extracted</span><span class="p">,</span> <span class="n">check_equality</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">output_metadata</span></div>


<div class="viewcode-block" id="EcoliSim.export_json">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.EcoliSim.export_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CONFIG_DIR_PATH</span> <span class="o">+</span> <span class="s2">&quot;export.json&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves current simulation settings along with git hash and final list</span>
<span class="sd">        of process names as a JSON that can be reloaded using</span>
<span class="sd">        :py:meth:`~ecoli.experiments.ecoli_master_sim.EcoliSim.from_file`.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename: Filepath and name for saved JSON (include ``.json``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">serialize_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()),</span> <span class="n">f</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="extract_metadata">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.extract_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_metadata</span><span class="p">(</span><span class="n">ports_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">properties</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filters ports schema to contain only a mapping of ports to user-supplied</span>
<span class="sd">    metadata (pulled from path `(&#39;_properties&#39;, &#39;metadata&#39;)` for each schema).</span>
<span class="sd">    See :py:meth:`~ecoli.library.schema.listener_schema` for usage details.</span>

<span class="sd">    Args:</span>
<span class="sd">        ports_schema: Ports schema to filter and compile metadata for</span>
<span class="sd">        properties: Flag used internally during recursive filtering</span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with same structure as ports schema but with only metadata</span>
<span class="sd">        as leaf nodes instead of complete schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">extracted</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s2">&quot;_properties&quot;</span> <span class="ow">in</span> <span class="n">ports_schema</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ports_schema</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">extract_metadata</span><span class="p">(</span><span class="n">ports_schema</span><span class="p">[</span><span class="s2">&quot;_properties&quot;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">properties</span> <span class="ow">and</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">ports_schema</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">ports_schema</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">metadata</span>

    <span class="k">for</span> <span class="n">port</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="n">ports_schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">subextracted</span> <span class="o">=</span> <span class="n">extract_metadata</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subextracted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">extracted</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">subextracted</span>

    <span class="k">return</span> <span class="n">extracted</span> <span class="ow">or</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.experiments.ecoli_master_sim.html#ecoli.experiments.ecoli_master_sim.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs a simulation with CLI options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ecoli_sim</span> <span class="o">=</span> <span class="n">EcoliSim</span><span class="o">.</span><span class="n">from_cli</span><span class="p">()</span>
    <span class="n">ecoli_sim</span><span class="o">.</span><span class="n">build_ecoli</span><span class="p">()</span>
    <span class="n">ecoli_sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2026, The Vivarium E. coli Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>