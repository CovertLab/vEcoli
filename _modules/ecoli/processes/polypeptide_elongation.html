

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ecoli.processes.polypeptide_elongation &mdash; Vivarium E. coli 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Vivarium E. coli
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../stores.html">Stores</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../composites.html">Composites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiments.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc.html">HPC Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gcloud.html">Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ci.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycharm.html">PyCharm Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/api_ref.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Vivarium E. coli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ecoli.processes.polypeptide_elongation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ecoli.processes.polypeptide_elongation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">======================</span>
<span class="sd">Polypeptide Elongation</span>
<span class="sd">======================</span>

<span class="sd">This process models the polymerization of amino acids into polypeptides</span>
<span class="sd">by ribosomes using an mRNA transcript as a template. Elongation terminates</span>
<span class="sd">once a ribosome has reached the end of an mRNA transcript. Polymerization</span>
<span class="sd">occurs across all ribosomes simultaneously and resources are allocated to</span>
<span class="sd">maximize the progress of all ribosomes within the limits of the maximum ribosome</span>
<span class="sd">elongation rate, available amino acids and GTP, and the length of the transcript.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">njit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">npt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve_ivp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Unum</span>

<span class="c1"># wcEcoli imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils.polymerize</span><span class="w"> </span><span class="kn">import</span> <span class="n">buildSequences</span><span class="p">,</span> <span class="n">polymerize</span><span class="p">,</span> <span class="n">computeMassIncrease</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">stochasticRound</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span>

<span class="c1"># vivarium imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.core.composition</span><span class="w"> </span><span class="kn">import</span> <span class="n">simulate_process</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.library.dict_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">deep_merge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.library.units</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">vivunits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vivarium.plots.simulation_output</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_variables</span>

<span class="c1"># vivarium-ecoli imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.library.schema</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">listener_schema</span><span class="p">,</span>
    <span class="n">numpy_schema</span><span class="p">,</span>
    <span class="n">counts</span><span class="p">,</span>
    <span class="n">attrs</span><span class="p">,</span>
    <span class="n">bulk_name_to_idx</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.processes.registries</span><span class="w"> </span><span class="kn">import</span> <span class="n">topology_registry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.processes.partition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PartitionedProcess</span>


<span class="n">MICROMOLAR_UNITS</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">umol</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">L</span>
<span class="sd">&quot;&quot;&quot;Units used for all concentrations.&quot;&quot;&quot;</span>
<span class="n">REMOVED_FROM_CHARGING</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;L-SELENOCYSTEINE[c]&quot;</span><span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Amino acids to remove from charging when running with </span>
<span class="sd">``steady_state_trna_charging``&quot;&quot;&quot;</span>


<span class="c1"># Register default topology for this process, associating it with process name</span>
<span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;ecoli-polypeptide-elongation&quot;</span>
<span class="n">TOPOLOGY</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;environment&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;environment&quot;</span><span class="p">,),</span>
    <span class="s2">&quot;boundary&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;boundary&quot;</span><span class="p">,),</span>
    <span class="s2">&quot;listeners&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;listeners&quot;</span><span class="p">,),</span>
    <span class="s2">&quot;active_ribosome&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;unique&quot;</span><span class="p">,</span> <span class="s2">&quot;active_ribosome&quot;</span><span class="p">),</span>
    <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;bulk&quot;</span><span class="p">,),</span>
    <span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;process_state&quot;</span><span class="p">,</span> <span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">),</span>
    <span class="c1"># Non-partitioned counts</span>
    <span class="s2">&quot;bulk_total&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;bulk&quot;</span><span class="p">,),</span>
    <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;timestep&quot;</span><span class="p">,),</span>
<span class="p">}</span>
<span class="n">topology_registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="n">TOPOLOGY</span><span class="p">)</span>

<span class="n">DEFAULT_AA_NAMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;L-ALPHA-ALANINE[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ARG[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ASN[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;L-ASPARTATE[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CYS[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLT[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLN[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLY[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HIS[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ILE[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LEU[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LYS[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MET[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PHE[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PRO[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SER[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;THR[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRP[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TYR[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;L-SELENOCYSTEINE[c]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VAL[c]&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="PolypeptideElongation">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.PolypeptideElongation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PolypeptideElongation</span><span class="p">(</span><span class="n">PartitionedProcess</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Polypeptide Elongation PartitionedProcess</span>

<span class="sd">    defaults:</span>
<span class="sd">        proteinIds: array length n of protein names</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">NAME</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="n">TOPOLOGY</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;time_step&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;n_avogadro&quot;</span><span class="p">:</span> <span class="mf">6.02214076e23</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span>
        <span class="s2">&quot;proteinIds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
        <span class="s2">&quot;proteinLengths&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
        <span class="s2">&quot;proteinSequences&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]]),</span>
        <span class="s2">&quot;aaWeightsIncorporated&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
        <span class="s2">&quot;endWeight&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.99146113e-08</span><span class="p">]),</span>
        <span class="s2">&quot;variable_elongation&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;make_elongation_rates&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">random</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">timestep</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="p">),</span>
        <span class="s2">&quot;next_aa_pad&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;ribosomeElongationRate&quot;</span><span class="p">:</span> <span class="mf">17.388824902723737</span><span class="p">,</span>
        <span class="s2">&quot;translation_aa_supply&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;minimal&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])},</span>
        <span class="s2">&quot;import_threshold&quot;</span><span class="p">:</span> <span class="mf">1e-05</span><span class="p">,</span>
        <span class="s2">&quot;aa_from_trna&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span>
        <span class="s2">&quot;gtpPerElongation&quot;</span><span class="p">:</span> <span class="mf">4.2</span><span class="p">,</span>
        <span class="s2">&quot;aa_supply_in_charging&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;mechanistic_translation_supply&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;mechanistic_aa_transport&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ppgpp_regulation&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;disable_ppgpp_elongation_inhibition&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;trna_charging&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;translation_supply&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;mechanistic_supply&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;ribosome30S&quot;</span><span class="p">:</span> <span class="s2">&quot;ribosome30S&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ribosome50S&quot;</span><span class="p">:</span> <span class="s2">&quot;ribosome50S&quot;</span><span class="p">,</span>
        <span class="s2">&quot;amino_acids&quot;</span><span class="p">:</span> <span class="n">DEFAULT_AA_NAMES</span><span class="p">,</span>
        <span class="s2">&quot;aa_exchange_names&quot;</span><span class="p">:</span> <span class="n">DEFAULT_AA_NAMES</span><span class="p">,</span>
        <span class="s2">&quot;basal_elongation_rate&quot;</span><span class="p">:</span> <span class="mf">22.0</span><span class="p">,</span>
        <span class="s2">&quot;ribosomeElongationRateDict&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;minimal&quot;</span><span class="p">:</span> <span class="mf">17.388824902723737</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">aa</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span>
        <span class="p">},</span>
        <span class="s2">&quot;uncharged_trna_names&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
        <span class="s2">&quot;aaNames&quot;</span><span class="p">:</span> <span class="n">DEFAULT_AA_NAMES</span><span class="p">,</span>
        <span class="s2">&quot;aa_enzymes&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;proton&quot;</span><span class="p">:</span> <span class="s2">&quot;PROTON&quot;</span><span class="p">,</span>
        <span class="s2">&quot;water&quot;</span><span class="p">:</span> <span class="s2">&quot;H2O&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cellDensity&quot;</span><span class="p">:</span> <span class="mi">1100</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">L</span><span class="p">,</span>
        <span class="s2">&quot;elongation_max&quot;</span><span class="p">:</span> <span class="mi">22</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">aa</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
        <span class="s2">&quot;aa_from_synthetase&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]]),</span>
        <span class="s2">&quot;charging_stoich_matrix&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]]),</span>
        <span class="s2">&quot;charged_trna_names&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;charging_molecule_names&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;synthetase_names&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;ppgpp_reaction_names&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;ppgpp_reaction_metabolites&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;ppgpp_reaction_stoich&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]]),</span>
        <span class="s2">&quot;ppgpp_synthesis_reaction&quot;</span><span class="p">:</span> <span class="s2">&quot;GDPPYPHOSKIN-RXN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ppgpp_degradation_reaction&quot;</span><span class="p">:</span> <span class="s2">&quot;PPGPPSYN-RXN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aa_importers&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;amino_acid_export&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;synthesis_index&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;aa_exporters&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;get_pathway_enzyme_counts_per_aa&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;import_constraint_threshold&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;unit_conversion&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;elong_rate_by_ppgpp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;amino_acid_import&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;degradation_index&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;amino_acid_synthesis&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;rela&quot;</span><span class="p">:</span> <span class="s2">&quot;RELA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;spot&quot;</span><span class="p">:</span> <span class="s2">&quot;SPOT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ppgpp&quot;</span><span class="p">:</span> <span class="s2">&quot;ppGpp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kS&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="s2">&quot;KMtf&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;KMaa&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="s2">&quot;krta&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;krtf&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">,</span>
        <span class="s2">&quot;KD_RelA&quot;</span><span class="p">:</span> <span class="mf">0.26</span><span class="p">,</span>
        <span class="s2">&quot;k_RelA&quot;</span><span class="p">:</span> <span class="mf">75.0</span><span class="p">,</span>
        <span class="s2">&quot;k_SpoT_syn&quot;</span><span class="p">:</span> <span class="mf">2.6</span><span class="p">,</span>
        <span class="s2">&quot;k_SpoT_deg&quot;</span><span class="p">:</span> <span class="mf">0.23</span><span class="p">,</span>
        <span class="s2">&quot;KI_SpoT&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
        <span class="s2">&quot;aa_supply_scaling&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">aa_conc</span><span class="p">,</span> <span class="n">aa_in_media</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;emit_unique&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

        <span class="c1"># Simulation options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_supply_in_charging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aa_supply_in_charging&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mechanistic_translation_supply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span>
            <span class="s2">&quot;mechanistic_translation_supply&quot;</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mechanistic_aa_transport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;mechanistic_aa_transport&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_regulation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ppgpp_regulation&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_ppgpp_elongation_inhibition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span>
            <span class="s2">&quot;disable_ppgpp_elongation_inhibition&quot;</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_elongation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;variable_elongation&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable_polymerize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_regulation</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable_elongation</span>
        <span class="n">translation_supply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;translation_supply&quot;</span><span class="p">]</span>
        <span class="n">trna_charging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;trna_charging&quot;</span><span class="p">]</span>

        <span class="c1"># Load parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_avogadro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;n_avogadro&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proteinIds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;proteinIds&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protein_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;proteinLengths&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proteinSequences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;proteinSequences&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aaWeightsIncorporated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aaWeightsIncorporated&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endWeight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;endWeight&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_elongation_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;make_elongation_rates&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_aa_pad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;next_aa_pad&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ribosome30S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ribosome30S&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ribosome50S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ribosome50S&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;amino_acids&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_exchange_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aa_exchange_names&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_environment_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">aa</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aa_exchange_names</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_enzymes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aa_enzymes&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ribosomeElongationRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ribosomeElongationRate&quot;</span><span class="p">]</span>

        <span class="c1"># Amino acid supply calculations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translation_aa_supply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;translation_aa_supply&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;import_threshold&quot;</span><span class="p">]</span>

        <span class="c1"># Used for figure in publication</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trpAIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proteinIds</span> <span class="o">==</span> <span class="s2">&quot;TRYPSYN-APROTEIN[c]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elngRateFactor</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Data structures for charging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_trna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aa_from_trna&quot;</span><span class="p">]</span>

        <span class="c1"># Set modeling method</span>
        <span class="c1"># TODO: Test that these models all work properly</span>
        <span class="k">if</span> <span class="n">trna_charging</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elongation_model</span> <span class="o">=</span> <span class="n">SteadyStateElongationModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">translation_supply</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elongation_model</span> <span class="o">=</span> <span class="n">TranslationSupplyElongationModel</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elongation_model</span> <span class="o">=</span> <span class="n">BaseElongationModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Growth associated maintenance energy requirements for elongations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gtpPerElongation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;gtpPerElongation&quot;</span><span class="p">]</span>
        <span class="c1"># Need to account for ATP hydrolysis for charging that has been</span>
        <span class="c1"># removed from measured GAM (ATP -&gt; AMP is 2 hydrolysis reactions)</span>
        <span class="c1"># if charging reactions are not explicitly modeled</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trna_charging</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gtpPerElongation</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="c1"># basic molecule names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proton</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;proton&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;water&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rela</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;rela&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;spot&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ppgpp&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_importers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aa_importers&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_exporters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aa_exporters&quot;</span><span class="p">]</span>
        <span class="c1"># Numpy index for bulk molecule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proton_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Names of molecules associated with tRNA charging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_reaction_metabolites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ppgpp_reaction_metabolites&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;uncharged_trna_names&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charged_trna_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;charged_trna_names&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_molecule_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;charging_molecule_names&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synthetase_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;synthetase_names&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;seed&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zero_aa_exchange_rates</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">MICROMOLAR_UNITS</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">))</span>
        <span class="p">)</span>

<div class="viewcode-block" id="PolypeptideElongation.ports_schema">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.PolypeptideElongation.ports_schema">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ports_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;environment&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;media_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_default&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_updater&quot;</span><span class="p">:</span> <span class="s2">&quot;set&quot;</span><span class="p">},</span>
                <span class="s2">&quot;exchange&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_default&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
            <span class="p">},</span>
            <span class="s2">&quot;boundary&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;external&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">aa</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_default&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aa_environment_names</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;listeners&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">listener_schema</span><span class="p">({</span><span class="s2">&quot;cell_mass&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;dry_mass&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}),</span>
                <span class="s2">&quot;growth_limits&quot;</span><span class="p">:</span> <span class="n">listener_schema</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;fraction_trna_charged&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_allocated&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                        <span class="s2">&quot;aa_pool_size&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                        <span class="s2">&quot;aa_request_size&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;active_ribosome_allocated&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;net_charged&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aas_used&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                        <span class="s2">&quot;aa_count_diff&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="c1"># Below only if trna_charging enbaled</span>
                        <span class="s2">&quot;original_aa_supply&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_in_media&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;synthetase_conc&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;uncharged_trna_conc&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;charged_trna_conc&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_conc&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                        <span class="s2">&quot;ribosome_conc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;fraction_aa_to_elongate&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_supply&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                        <span class="s2">&quot;aa_synthesis&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_import&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                        <span class="s2">&quot;aa_export&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                        <span class="s2">&quot;aa_importers&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aa_importers</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">aa_importers</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_exporters&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aa_exporters</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">aa_exporters</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_supply_enzymes_fwd&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_supply_enzymes_rev&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_supply_aa_conc&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_supply_fraction_fwd&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_supply_fraction_rev&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;ppgpp_conc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;rela_conc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;spot_conc&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;rela_syn&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                        <span class="s2">&quot;spot_syn&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;spot_deg&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;spot_deg_inhibited&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;trna_charged&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">),</span>
                <span class="s2">&quot;ribosome_data&quot;</span><span class="p">:</span> <span class="n">listener_schema</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;translation_supply&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;effective_elongation_rate&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;aa_count_in_sequence&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_counts&quot;</span><span class="p">:</span> <span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                        <span class="s2">&quot;actual_elongations&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;actual_elongation_hist&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">22</span><span class="p">,</span>
                        <span class="s2">&quot;elongations_non_terminating_hist&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">22</span><span class="p">,</span>
                        <span class="s2">&quot;did_terminate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;termination_loss&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;num_trpA_terminated&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;process_elongation_rate&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="n">numpy_schema</span><span class="p">(</span><span class="s2">&quot;bulk&quot;</span><span class="p">),</span>
            <span class="s2">&quot;bulk_total&quot;</span><span class="p">:</span> <span class="n">numpy_schema</span><span class="p">(</span><span class="s2">&quot;bulk&quot;</span><span class="p">),</span>
            <span class="s2">&quot;active_ribosome&quot;</span><span class="p">:</span> <span class="n">numpy_schema</span><span class="p">(</span>
                <span class="s2">&quot;active_ribosome&quot;</span><span class="p">,</span> <span class="n">emit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;emit_unique&quot;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;aa_count_diff&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;_default&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span>
                    <span class="s2">&quot;_emit&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;_updater&quot;</span><span class="p">:</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_divider&quot;</span><span class="p">:</span> <span class="s2">&quot;empty_dict&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;gtp_to_hydrolyze&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;_default&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;_emit&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;_updater&quot;</span><span class="p">:</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_divider&quot;</span><span class="p">:</span> <span class="s2">&quot;zero&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;aa_exchange_rates&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;_default&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_aa_exchange_rates</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="s2">&quot;_emit&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;_updater&quot;</span><span class="p">:</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;_divider&quot;</span><span class="p">:</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_default&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;time_step&quot;</span><span class="p">]},</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="PolypeptideElongation.calculate_request">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.PolypeptideElongation.calculate_request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestep</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set ribosome elongation rate based on simulation medium environment and elongation rate factor</span>
<span class="sd">        which is used to create single-cell variability in growth rate</span>
<span class="sd">        The maximum number of amino acids that can be elongated in a single timestep is set to 22</span>
<span class="sd">        intentionally as the minimum number of padding values on the protein sequence matrix is set to 22.</span>
<span class="sd">        If timesteps longer than 1.0s are used, this feature will lead to errors in the effective ribosome</span>
<span class="sd">        elongation rate.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proton_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bulk_ids</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proton_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proton</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">water_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">water</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rela_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rela</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spot_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppgpp</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monomer_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proteinIds</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aa_enzyme_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aa_enzymes</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_rxn_metabolites_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_reaction_metabolites</span><span class="p">,</span> <span class="n">bulk_ids</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">,</span> <span class="n">bulk_ids</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">charged_trna_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charged_trna_names</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">charging_molecule_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">charging_molecule_names</span><span class="p">,</span> <span class="n">bulk_ids</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">synthetase_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synthetase_names</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ribosome30S_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ribosome30S</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ribosome50S_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ribosome50S</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aa_importer_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aa_importers</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aa_exporter_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aa_exporters</span><span class="p">,</span> <span class="n">bulk_ids</span><span class="p">)</span>

        <span class="c1"># MODEL SPECIFIC: get ribosome elongation rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ribosomeElongationRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongation_model</span><span class="o">.</span><span class="n">elongation_rate</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>

        <span class="c1"># If there are no active ribosomes, return immediately</span>
        <span class="k">if</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;active_ribosome&quot;</span><span class="p">][</span><span class="s2">&quot;_entryState&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;listeners&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ribosome_data&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;growth_limits&quot;</span><span class="p">:</span> <span class="p">{}}}</span>

        <span class="c1"># Build sequences to request appropriate amount of amino acids to</span>
        <span class="c1"># polymerize for next timestep</span>
        <span class="p">(</span>
            <span class="n">proteinIndexes</span><span class="p">,</span>
            <span class="n">peptideLengths</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;active_ribosome&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;protein_index&quot;</span><span class="p">,</span> <span class="s2">&quot;peptide_length&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elongation_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_elongation_rates</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ribosomeElongationRate</span><span class="p">,</span>
            <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variable_elongation</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">sequences</span> <span class="o">=</span> <span class="n">buildSequences</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proteinSequences</span><span class="p">,</span> <span class="n">proteinIndexes</span><span class="p">,</span> <span class="n">peptideLengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongation_rates</span>
        <span class="p">)</span>

        <span class="n">sequenceHasAA</span> <span class="o">=</span> <span class="n">sequences</span> <span class="o">!=</span> <span class="n">polymerize</span><span class="o">.</span><span class="n">PAD_VALUE</span>
        <span class="n">aasInSequences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">sequences</span><span class="p">[</span><span class="n">sequenceHasAA</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>

        <span class="c1"># Calculate AA supply for expected doubling of protein</span>
        <span class="n">dryMass</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">][</span><span class="s2">&quot;dry_mass&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">fg</span>
        <span class="n">current_media_id</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;media_id&quot;</span><span class="p">]</span>
        <span class="n">translation_supply_rate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">translation_aa_supply</span><span class="p">[</span><span class="n">current_media_id</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elngRateFactor</span>
        <span class="p">)</span>
        <span class="n">mol_aas_supplied</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">translation_supply_rate</span> <span class="o">*</span> <span class="n">dryMass</span> <span class="o">*</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_supply</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">strip_empty_units</span><span class="p">(</span><span class="n">mol_aas_supplied</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_avogadro</span><span class="p">)</span>

        <span class="c1"># MODEL SPECIFIC: Calculate AA request</span>
        <span class="n">fraction_charged</span><span class="p">,</span> <span class="n">aa_counts_for_translation</span><span class="p">,</span> <span class="n">requests</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elongation_model</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">aasInSequences</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Write to listeners</span>
        <span class="n">listeners</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;listeners&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">ribosome_data_listener</span> <span class="o">=</span> <span class="n">listeners</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;ribosome_data&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;translation_supply&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">translation_supply_rate</span><span class="o">.</span><span class="n">asNumber</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">growth_limits_listener</span> <span class="o">=</span> <span class="n">requests</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;growth_limits&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">growth_limits_listener</span><span class="p">[</span><span class="s2">&quot;fraction_trna_charged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
            <span class="n">fraction_charged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_trna</span>
        <span class="p">)</span>
        <span class="n">growth_limits_listener</span><span class="p">[</span><span class="s2">&quot;aa_pool_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span>
            <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_idx</span>
        <span class="p">)</span>
        <span class="n">growth_limits_listener</span><span class="p">[</span><span class="s2">&quot;aa_request_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aa_counts_for_translation</span>
        <span class="c1"># Simulations without mechanistic translation supply need this to be</span>
        <span class="c1"># manually zeroed after division</span>
        <span class="n">proc_data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">proc_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;aa_exchange_rates&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">requests</span></div>


<div class="viewcode-block" id="PolypeptideElongation.evolve_state">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.PolypeptideElongation.evolve_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evolve_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestep</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set ribosome elongation rate based on simulation medium environment and elongation rate factor</span>
<span class="sd">        which is used to create single-cell variability in growth rate</span>
<span class="sd">        The maximum number of amino acids that can be elongated in a single timestep is set to 22</span>
<span class="sd">        intentionally as the minimum number of padding values on the protein sequence matrix is set to 22.</span>
<span class="sd">        If timesteps longer than 1.0s are used, this feature will lead to errors in the effective ribosome</span>
<span class="sd">        elongation rate.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">update</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;listeners&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ribosome_data&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;growth_limits&quot;</span><span class="p">:</span> <span class="p">{}},</span>
            <span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;active_ribosome&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="c1"># Begin wcEcoli evolveState()</span>
        <span class="c1"># Set values for metabolism in case of early return</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">][</span><span class="s2">&quot;gtp_to_hydrolyze&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">][</span><span class="s2">&quot;aa_count_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span>
        <span class="p">)</span>

        <span class="c1"># Get number of active ribosomes</span>
        <span class="n">n_active_ribosomes</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;active_ribosome&quot;</span><span class="p">][</span><span class="s2">&quot;_entryState&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;growth_limits&quot;</span><span class="p">][</span><span class="s2">&quot;active_ribosome_allocated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">n_active_ribosomes</span>
        <span class="p">)</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;growth_limits&quot;</span><span class="p">][</span><span class="s2">&quot;aa_allocated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span>
            <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_idx</span>
        <span class="p">)</span>

        <span class="c1"># If there are no active ribosomes, return immediately</span>
        <span class="k">if</span> <span class="n">n_active_ribosomes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">update</span>

        <span class="c1"># Polypeptide elongation requires counts to be updated in real-time</span>
        <span class="c1"># so make a writeable copy of bulk counts to do so</span>
        <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">])))</span>

        <span class="c1"># Build amino acids sequences for each ribosome to polymerize</span>
        <span class="n">protein_indexes</span><span class="p">,</span> <span class="n">peptide_lengths</span><span class="p">,</span> <span class="n">positions_on_mRNA</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">(</span>
            <span class="n">states</span><span class="p">[</span><span class="s2">&quot;active_ribosome&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;protein_index&quot;</span><span class="p">,</span> <span class="s2">&quot;peptide_length&quot;</span><span class="p">,</span> <span class="s2">&quot;pos_on_mRNA&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">all_sequences</span> <span class="o">=</span> <span class="n">buildSequences</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proteinSequences</span><span class="p">,</span>
            <span class="n">protein_indexes</span><span class="p">,</span>
            <span class="n">peptide_lengths</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elongation_rates</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_aa_pad</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="n">all_sequences</span><span class="p">[:,</span> <span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">next_aa_pad</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sequences</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">update</span>

        <span class="c1"># Calculate elongation resource capacity</span>
        <span class="n">aaCountInSequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">sequences</span><span class="p">[(</span><span class="n">sequences</span> <span class="o">!=</span> <span class="n">polymerize</span><span class="o">.</span><span class="n">PAD_VALUE</span><span class="p">)])</span>
        <span class="n">total_aa_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_idx</span><span class="p">)</span>
        <span class="n">charged_trna_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">charged_trna_idx</span><span class="p">)</span>

        <span class="c1"># MODEL SPECIFIC: Get amino acid counts</span>
        <span class="n">aa_counts_for_translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongation_model</span><span class="o">.</span><span class="n">final_amino_acids</span><span class="p">(</span>
            <span class="n">total_aa_counts</span><span class="p">,</span> <span class="n">charged_trna_counts</span>
        <span class="p">)</span>

        <span class="c1"># Using polymerization algorithm elongate each ribosome up to the limits</span>
        <span class="c1"># of amino acids, sequence, and GTP</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">polymerize</span><span class="p">(</span>
            <span class="n">sequences</span><span class="p">,</span>
            <span class="n">aa_counts_for_translation</span><span class="p">,</span>
            <span class="mi">10000000</span><span class="p">,</span>  <span class="c1"># Set to a large number, the limit is now taken care of in metabolism</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elongation_rates</span><span class="p">[</span><span class="n">protein_indexes</span><span class="p">],</span>
            <span class="n">variable_elongation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_polymerize</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">sequence_elongations</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sequenceElongation</span>
        <span class="n">aas_used</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">monomerUsages</span>
        <span class="n">nElongations</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">nReactions</span>

        <span class="n">next_amino_acid</span> <span class="o">=</span> <span class="n">all_sequences</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence_elongations</span><span class="p">)),</span> <span class="n">sequence_elongations</span>
        <span class="p">]</span>
        <span class="n">next_amino_acid_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span>
            <span class="n">next_amino_acid</span><span class="p">[</span><span class="n">next_amino_acid</span> <span class="o">!=</span> <span class="n">polymerize</span><span class="o">.</span><span class="n">PAD_VALUE</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">21</span>
        <span class="p">)</span>

        <span class="c1"># Update masses of ribosomes attached to polymerizing polypeptides</span>
        <span class="n">added_protein_mass</span> <span class="o">=</span> <span class="n">computeMassIncrease</span><span class="p">(</span>
            <span class="n">sequences</span><span class="p">,</span> <span class="n">sequence_elongations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aaWeightsIncorporated</span>
        <span class="p">)</span>

        <span class="n">updated_lengths</span> <span class="o">=</span> <span class="n">peptide_lengths</span> <span class="o">+</span> <span class="n">sequence_elongations</span>
        <span class="n">updated_positions_on_mRNA</span> <span class="o">=</span> <span class="n">positions_on_mRNA</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">sequence_elongations</span>

        <span class="n">didInitialize</span> <span class="o">=</span> <span class="p">(</span><span class="n">sequence_elongations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">peptide_lengths</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">added_protein_mass</span><span class="p">[</span><span class="n">didInitialize</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endWeight</span>

        <span class="c1"># Write current average elongation to listener</span>
        <span class="n">currElongRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">sequence_elongations</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n_active_ribosomes</span><span class="p">)</span> <span class="o">/</span> <span class="n">states</span><span class="p">[</span>
            <span class="s2">&quot;timestep&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Ribosomes that reach the end of their sequences are terminated and</span>
        <span class="c1"># dissociated into 30S and 50S subunits. The polypeptide that they are</span>
        <span class="c1"># polymerizing is converted into a protein in BulkMolecules</span>
        <span class="n">terminalLengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protein_lengths</span><span class="p">[</span><span class="n">protein_indexes</span><span class="p">]</span>

        <span class="n">didTerminate</span> <span class="o">=</span> <span class="n">updated_lengths</span> <span class="o">==</span> <span class="n">terminalLengths</span>

        <span class="n">terminatedProteins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span>
            <span class="n">protein_indexes</span><span class="p">[</span><span class="n">didTerminate</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proteinSequences</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="p">(</span><span class="n">protein_mass</span><span class="p">,)</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;active_ribosome&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;massDiff_protein&quot;</span><span class="p">])</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;active_ribosome&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;delete&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">didTerminate</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;set&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;massDiff_protein&quot;</span><span class="p">:</span> <span class="n">protein_mass</span> <span class="o">+</span> <span class="n">added_protein_mass</span><span class="p">,</span>
                    <span class="s2">&quot;peptide_length&quot;</span><span class="p">:</span> <span class="n">updated_lengths</span><span class="p">,</span>
                    <span class="s2">&quot;pos_on_mRNA&quot;</span><span class="p">:</span> <span class="n">updated_positions_on_mRNA</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">monomer_idx</span><span class="p">,</span> <span class="n">terminatedProteins</span><span class="p">))</span>
        <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">monomer_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">terminatedProteins</span>

        <span class="n">nTerminated</span> <span class="o">=</span> <span class="n">didTerminate</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">nInitialized</span> <span class="o">=</span> <span class="n">didInitialize</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ribosome30S_idx</span><span class="p">,</span> <span class="n">nTerminated</span><span class="p">))</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ribosome50S_idx</span><span class="p">,</span> <span class="n">nTerminated</span><span class="p">))</span>
        <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ribosome30S_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nTerminated</span>
        <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ribosome50S_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nTerminated</span>

        <span class="c1"># MODEL SPECIFIC: evolve</span>
        <span class="n">net_charged</span><span class="p">,</span> <span class="n">aa_count_diff</span><span class="p">,</span> <span class="n">evolve_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongation_model</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span>
            <span class="n">states</span><span class="p">,</span>
            <span class="n">total_aa_counts</span><span class="p">,</span>
            <span class="n">aas_used</span><span class="p">,</span>
            <span class="n">next_amino_acid_count</span><span class="p">,</span>
            <span class="n">nElongations</span><span class="p">,</span>
            <span class="n">nInitialized</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">evolve_bulk_update</span> <span class="o">=</span> <span class="n">evolve_update</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;bulk&quot;</span><span class="p">)</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">deep_merge</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">evolve_update</span><span class="p">)</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">evolve_bulk_update</span><span class="p">)</span>

        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">][</span><span class="s2">&quot;aa_count_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aa_count_diff</span>
        <span class="c1"># GTP hydrolysis is carried out in Metabolism process for growth</span>
        <span class="c1"># associated maintenance. This is passed to metabolism.</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">][</span><span class="s2">&quot;gtp_to_hydrolyze&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gtpPerElongation</span> <span class="o">*</span> <span class="n">nElongations</span>
        <span class="p">)</span>

        <span class="c1"># Write data to listeners</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;growth_limits&quot;</span><span class="p">][</span><span class="s2">&quot;net_charged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_charged</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;growth_limits&quot;</span><span class="p">][</span><span class="s2">&quot;aas_used&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aas_used</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;growth_limits&quot;</span><span class="p">][</span><span class="s2">&quot;aa_count_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aa_count_diff</span>

        <span class="n">ribosome_data_listener</span> <span class="o">=</span> <span class="n">update</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;ribosome_data&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;effective_elongation_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currElongRate</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;aa_count_in_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aaCountInSequence</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;aa_counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aa_counts_for_translation</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;actual_elongations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_elongations</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;actual_elongation_hist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">sequence_elongations</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;elongations_non_terminating_hist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">sequence_elongations</span><span class="p">[</span><span class="o">~</span><span class="n">didTerminate</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;did_terminate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">didTerminate</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;termination_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">terminalLengths</span> <span class="o">-</span> <span class="n">peptide_lengths</span>
        <span class="p">)[</span><span class="n">didTerminate</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;num_trpA_terminated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">terminatedProteins</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trpAIndex</span>
        <span class="p">]</span>
        <span class="n">ribosome_data_listener</span><span class="p">[</span><span class="s2">&quot;process_elongation_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ribosomeElongationRate</span> <span class="o">/</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">update</span></div>
</div>



<div class="viewcode-block" id="BaseElongationModel">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.BaseElongationModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BaseElongationModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base Model: Request amino acids according to upcoming sequence, assuming</span>
<span class="sd">    max ribosome elongation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basal_elongation_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;basal_elongation_rate&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ribosomeElongationRateDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ribosomeElongationRateDict&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="BaseElongationModel.elongation_rate">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.BaseElongationModel.elongation_rate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">elongation_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets ribosome elongation rate accordint to the media; returns</span>
<span class="sd">        max value of 22 amino acids/second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_media_id</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">][</span><span class="s2">&quot;media_id&quot;</span><span class="p">]</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">elngRateFactor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ribosomeElongationRateDict</span><span class="p">[</span>
            <span class="n">current_media_id</span>
        <span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">aa</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">basal_elongation_rate</span><span class="p">,</span> <span class="n">rate</span><span class="p">])</span></div>


<div class="viewcode-block" id="BaseElongationModel.amino_acid_counts">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.BaseElongationModel.amino_acid_counts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">amino_acid_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aasInSequences</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aasInSequences</span></div>


<div class="viewcode-block" id="BaseElongationModel.request">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.BaseElongationModel.request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">aasInSequences</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="n">aa_counts_for_translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_counts</span><span class="p">(</span><span class="n">aasInSequences</span><span class="p">)</span>

        <span class="n">requests</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">amino_acid_idx</span><span class="p">,</span> <span class="n">aa_counts_for_translation</span><span class="p">)]}</span>

        <span class="c1"># Not modeling charging so set fraction charged to 0 for all tRNA</span>
        <span class="n">fraction_charged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">amino_acid_idx</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">fraction_charged</span><span class="p">,</span> <span class="n">aa_counts_for_translation</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">requests</span></div>


<div class="viewcode-block" id="BaseElongationModel.final_amino_acids">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.BaseElongationModel.final_amino_acids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">final_amino_acids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_aa_counts</span><span class="p">,</span> <span class="n">charged_trna_counts</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">total_aa_counts</span></div>


<div class="viewcode-block" id="BaseElongationModel.evolve">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.BaseElongationModel.evolve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">states</span><span class="p">,</span>
        <span class="n">total_aa_counts</span><span class="p">,</span>
        <span class="n">aas_used</span><span class="p">,</span>
        <span class="n">next_amino_acid_count</span><span class="p">,</span>
        <span class="n">nElongations</span><span class="p">,</span>
        <span class="n">nInitialized</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Update counts of amino acids and water to reflect polymerization</span>
        <span class="c1"># reactions</span>
        <span class="n">net_charged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;uncharged_trna_names&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">net_charged</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="p">{</span>
                <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">amino_acid_idx</span><span class="p">,</span> <span class="o">-</span><span class="n">aas_used</span><span class="p">),</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">water_idx</span><span class="p">,</span> <span class="n">nElongations</span> <span class="o">-</span> <span class="n">nInitialized</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">},</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TranslationSupplyElongationModel">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.TranslationSupplyElongationModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TranslationSupplyElongationModel</span><span class="p">(</span><span class="n">BaseElongationModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translation Supply Model: Requests minimum of 1) upcoming amino acid</span>
<span class="sd">    sequence assuming max ribosome elongation (ie. Base Model) and 2)</span>
<span class="sd">    estimation based on doubling the proteome in one cell cycle (does not</span>
<span class="sd">    use ribosome elongation, computed in Parca).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>

<div class="viewcode-block" id="TranslationSupplyElongationModel.elongation_rate">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.TranslationSupplyElongationModel.elongation_rate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">elongation_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets ribosome elongation rate accordint to the media; returns</span>
<span class="sd">        max value of 22 amino acids/second.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basal_elongation_rate</span></div>


<div class="viewcode-block" id="TranslationSupplyElongationModel.amino_acid_counts">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.TranslationSupplyElongationModel.amino_acid_counts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">amino_acid_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aasInSequences</span><span class="p">):</span>
        <span class="c1"># Check if this is required. It is a better request but there may be</span>
        <span class="c1"># fewer elongations.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply</span><span class="p">,</span> <span class="n">aasInSequences</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SteadyStateElongationModel">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.SteadyStateElongationModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SteadyStateElongationModel</span><span class="p">(</span><span class="n">TranslationSupplyElongationModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Steady State Charging Model: Requests amino acids based on the</span>
<span class="sd">    Michaelis-Menten competitive inhibition model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>

        <span class="c1"># Cell parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellDensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;cellDensity&quot;</span><span class="p">]</span>

        <span class="c1"># Names of molecules associated with tRNA charging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charged_trna_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;charged_trna_names&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_molecule_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;charging_molecule_names&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synthetase_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;synthetase_names&quot;</span><span class="p">]</span>

        <span class="c1"># Data structures for charging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_synthetase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aa_from_synthetase&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_stoich_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;charging_stoich_matrix&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_molecules_not_aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">mol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;amino_acids&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">charging_molecule_names</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># ppGpp synthesis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_reaction_metabolites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ppgpp_reaction_metabolites&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elong_rate_by_ppgpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;elong_rate_by_ppgpp&quot;</span><span class="p">]</span>

        <span class="c1"># Parameters for tRNA charging, ribosome elongation and ppGpp reactions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kS&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;kS&quot;</span><span class="p">],</span>
            <span class="s2">&quot;KMaa&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;KMaa&quot;</span><span class="p">],</span>
            <span class="s2">&quot;KMtf&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;KMtf&quot;</span><span class="p">],</span>
            <span class="s2">&quot;krta&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;krta&quot;</span><span class="p">],</span>
            <span class="s2">&quot;krtf&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;krtf&quot;</span><span class="p">],</span>
            <span class="s2">&quot;max_elong_rate&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;elongation_max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">aa</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;charging_mask&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">aa</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REMOVED_FROM_CHARGING</span>
                    <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;amino_acids&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="s2">&quot;unit_conversion&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;unit_conversion&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;KD_RelA&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;KD_RelA&quot;</span><span class="p">],</span>
            <span class="s2">&quot;k_RelA&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;k_RelA&quot;</span><span class="p">],</span>
            <span class="s2">&quot;k_SpoT_syn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;k_SpoT_syn&quot;</span><span class="p">],</span>
            <span class="s2">&quot;k_SpoT_deg&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;k_SpoT_deg&quot;</span><span class="p">],</span>
            <span class="s2">&quot;KI_SpoT&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;KI_SpoT&quot;</span><span class="p">],</span>
            <span class="s2">&quot;ppgpp_reaction_stoich&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ppgpp_reaction_stoich&quot;</span><span class="p">],</span>
            <span class="s2">&quot;synthesis_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;synthesis_index&quot;</span><span class="p">],</span>
            <span class="s2">&quot;degradation_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;degradation_index&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Amino acid supply calculations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_supply_scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;aa_supply_scaling&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_synthesis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;amino_acid_synthesis&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_import</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;amino_acid_import&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_export</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;amino_acid_export&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_pathway_enzyme_counts_per_aa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span>
            <span class="s2">&quot;get_pathway_enzyme_counts_per_aa&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Comparing two values with units is faster than converting units</span>
        <span class="c1"># and comparing magnitudes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_constraint_threshold</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;import_constraint_threshold&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vivunits</span><span class="o">.</span><span class="n">mM</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SteadyStateElongationModel.elongation_rate">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.SteadyStateElongationModel.elongation_rate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">elongation_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_regulation</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">disable_ppgpp_elongation_inhibition</span>
        <span class="p">):</span>
            <span class="n">cell_mass</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">][</span><span class="s2">&quot;cell_mass&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">fg</span>
            <span class="n">cell_volume</span> <span class="o">=</span> <span class="n">cell_mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDensity</span>
            <span class="n">counts_to_molar</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">n_avogadro</span> <span class="o">*</span> <span class="n">cell_volume</span><span class="p">)</span>
            <span class="n">ppgpp_count</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_idx</span><span class="p">)</span>
            <span class="n">ppgpp_conc</span> <span class="o">=</span> <span class="n">ppgpp_count</span> <span class="o">*</span> <span class="n">counts_to_molar</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elong_rate_by_ppgpp</span><span class="p">(</span>
                <span class="n">ppgpp_conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basal_elongation_rate</span>
            <span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">aa</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">elongation_rate</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rate</span></div>


<div class="viewcode-block" id="SteadyStateElongationModel.request">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.SteadyStateElongationModel.request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">aasInSequences</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="c1"># Conversion from counts to molarity</span>
        <span class="n">cell_mass</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">][</span><span class="s2">&quot;cell_mass&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">fg</span>
        <span class="n">dry_mass</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">][</span><span class="s2">&quot;dry_mass&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">fg</span>
        <span class="n">cell_volume</span> <span class="o">=</span> <span class="n">cell_mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellDensity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">n_avogadro</span> <span class="o">*</span> <span class="n">cell_volume</span><span class="p">)</span>

        <span class="c1"># ppGpp related concentrations</span>
        <span class="n">ppgpp_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">counts</span><span class="p">(</span>
            <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_idx</span>
        <span class="p">)</span>
        <span class="n">rela_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">counts</span><span class="p">(</span>
            <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">rela_idx</span>
        <span class="p">)</span>
        <span class="n">spot_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">counts</span><span class="p">(</span>
            <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">spot_idx</span>
        <span class="p">)</span>

        <span class="c1"># Get counts and convert synthetase and tRNA to a per AA basis</span>
        <span class="n">synthetase_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_synthetase</span><span class="p">,</span>
            <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">synthetase_idx</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">aa_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">amino_acid_idx</span><span class="p">)</span>
        <span class="n">uncharged_trna_array</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span>
            <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">uncharged_trna_idx</span>
        <span class="p">)</span>
        <span class="n">charged_trna_array</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">charged_trna_idx</span><span class="p">)</span>
        <span class="n">uncharged_trna_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">,</span> <span class="n">uncharged_trna_array</span><span class="p">)</span>
        <span class="n">charged_trna_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">,</span> <span class="n">charged_trna_array</span><span class="p">)</span>
        <span class="n">ribosome_counts</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;active_ribosome&quot;</span><span class="p">][</span><span class="s2">&quot;_entryState&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Get concentration</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">aasInSequences</span> <span class="o">/</span> <span class="n">aasInSequences</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">synthetase_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">synthetase_counts</span>
        <span class="n">aa_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">aa_counts</span>
        <span class="n">uncharged_trna_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">uncharged_trna_counts</span>
        <span class="n">charged_trna_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">charged_trna_counts</span>
        <span class="n">ribosome_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">ribosome_counts</span>

        <span class="c1"># Calculate amino acid supply</span>
        <span class="n">aa_in_media</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">states</span><span class="p">[</span><span class="s2">&quot;boundary&quot;</span><span class="p">][</span><span class="s2">&quot;external&quot;</span><span class="p">][</span><span class="n">aa</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_constraint_threshold</span>
                <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_environment_names</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">fwd_enzyme_counts</span><span class="p">,</span> <span class="n">rev_enzyme_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pathway_enzyme_counts_per_aa</span><span class="p">(</span>
            <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_enzyme_idx</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">importer_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_importer_idx</span><span class="p">)</span>
        <span class="n">exporter_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_exporter_idx</span><span class="p">)</span>
        <span class="n">synthesis</span><span class="p">,</span> <span class="n">fwd_saturation</span><span class="p">,</span> <span class="n">rev_saturation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_synthesis</span><span class="p">(</span>
            <span class="n">fwd_enzyme_counts</span><span class="p">,</span> <span class="n">rev_enzyme_counts</span><span class="p">,</span> <span class="n">aa_conc</span>
        <span class="p">)</span>
        <span class="n">import_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_import</span><span class="p">(</span>
            <span class="n">aa_in_media</span><span class="p">,</span>
            <span class="n">dry_mass</span><span class="p">,</span>
            <span class="n">aa_conc</span><span class="p">,</span>
            <span class="n">importer_counts</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">mechanistic_aa_transport</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">export_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_export</span><span class="p">(</span>
            <span class="n">exporter_counts</span><span class="p">,</span> <span class="n">aa_conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">mechanistic_aa_transport</span>
        <span class="p">)</span>
        <span class="n">exchange_rates</span> <span class="o">=</span> <span class="n">import_rates</span> <span class="o">-</span> <span class="n">export_rates</span>

        <span class="n">supply_function</span> <span class="o">=</span> <span class="n">get_charging_supply_function</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply_in_charging</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">mechanistic_translation_supply</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">mechanistic_aa_transport</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_synthesis</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_import</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amino_acid_export</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aa_supply_scaling</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply</span><span class="p">,</span>
            <span class="n">fwd_enzyme_counts</span><span class="p">,</span>
            <span class="n">rev_enzyme_counts</span><span class="p">,</span>
            <span class="n">dry_mass</span><span class="p">,</span>
            <span class="n">importer_counts</span><span class="p">,</span>
            <span class="n">exporter_counts</span><span class="p">,</span>
            <span class="n">aa_in_media</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Calculate steady state tRNA levels and resulting elongation rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_params</span><span class="p">[</span><span class="s2">&quot;max_elong_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongation_rate</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">fraction_charged</span><span class="p">,</span>
            <span class="n">v_rib</span><span class="p">,</span>
            <span class="n">synthesis_in_charging</span><span class="p">,</span>
            <span class="n">import_in_charging</span><span class="p">,</span>
            <span class="n">export_in_charging</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">calculate_trna_charging</span><span class="p">(</span>
            <span class="n">synthetase_conc</span><span class="p">,</span>
            <span class="n">uncharged_trna_conc</span><span class="p">,</span>
            <span class="n">charged_trna_conc</span><span class="p">,</span>
            <span class="n">aa_conc</span><span class="p">,</span>
            <span class="n">ribosome_conc</span><span class="p">,</span>
            <span class="n">f</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">charging_params</span><span class="p">,</span>
            <span class="n">supply</span><span class="o">=</span><span class="n">supply_function</span><span class="p">,</span>
            <span class="n">limit_v_rib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">time_limit</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Use the supply calculated from each sub timestep while solving the charging steady state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply_in_charging</span><span class="p">:</span>
            <span class="n">conversion</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span> <span class="o">/</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">synthesis</span> <span class="o">=</span> <span class="n">conversion</span> <span class="o">*</span> <span class="n">synthesis_in_charging</span>
            <span class="n">import_rates</span> <span class="o">=</span> <span class="n">conversion</span> <span class="o">*</span> <span class="n">import_in_charging</span>
            <span class="n">export_rates</span> <span class="o">=</span> <span class="n">conversion</span> <span class="o">*</span> <span class="n">export_in_charging</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply</span> <span class="o">=</span> <span class="n">synthesis</span> <span class="o">+</span> <span class="n">import_rates</span> <span class="o">-</span> <span class="n">export_rates</span>
        <span class="c1"># Use the supply calculated from the starting amino acid concentrations only</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">mechanistic_translation_supply</span><span class="p">:</span>
            <span class="c1"># Set supply based on mechanistic synthesis and supply</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">synthesis</span> <span class="o">+</span> <span class="n">exchange_rates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Adjust aa_supply higher if amino acid concentrations are low</span>
            <span class="c1"># Improves stability of charging and mimics amino acid synthesis</span>
            <span class="c1"># inhibition and export</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aa_supply_scaling</span><span class="p">(</span><span class="n">aa_conc</span><span class="p">,</span> <span class="n">aa_in_media</span><span class="p">)</span>

        <span class="n">aa_counts_for_translation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">v_rib</span>
            <span class="o">*</span> <span class="n">f</span>
            <span class="o">*</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">total_trna</span> <span class="o">=</span> <span class="n">charged_trna_array</span> <span class="o">+</span> <span class="n">uncharged_trna_array</span>
        <span class="n">final_charged_trna</span> <span class="o">=</span> <span class="n">stochasticRound</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">fraction_charged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span> <span class="o">*</span> <span class="n">total_trna</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Request charged tRNA that will become uncharged</span>
        <span class="n">charged_trna_request</span> <span class="o">=</span> <span class="n">charged_trna_array</span> <span class="o">-</span> <span class="n">final_charged_trna</span>
        <span class="n">charged_trna_request</span><span class="p">[</span><span class="n">charged_trna_request</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">uncharged_trna_request</span> <span class="o">=</span> <span class="n">final_charged_trna</span> <span class="o">-</span> <span class="n">charged_trna_array</span>
        <span class="n">uncharged_trna_request</span><span class="p">[</span><span class="n">uncharged_trna_request</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_to_charge</span> <span class="o">=</span> <span class="n">uncharged_trna_request</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aa_counts_for_translation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aa_counts_for_translation</span><span class="p">)</span>

        <span class="n">fraction_trna_per_aa</span> <span class="o">=</span> <span class="n">total_trna</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">,</span> <span class="n">total_trna</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span>
        <span class="p">)</span>
        <span class="n">total_charging_reactions</span> <span class="o">=</span> <span class="n">stochasticRound</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">aa_counts_for_translation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">fraction_trna_per_aa</span>
            <span class="o">+</span> <span class="n">uncharged_trna_request</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Only request molecules that will be consumed in the charging reactions</span>
        <span class="n">aa_from_uncharging</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_stoich_matrix</span> <span class="o">@</span> <span class="n">charged_trna_request</span>
        <span class="n">aa_from_uncharging</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_molecules_not_aa</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">requested_molecules</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_stoich_matrix</span><span class="p">,</span> <span class="n">total_charging_reactions</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">aa_from_uncharging</span>
        <span class="p">)</span>
        <span class="n">requested_molecules</span><span class="p">[</span><span class="n">requested_molecules</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_to_charge</span> <span class="o">=</span> <span class="n">uncharged_trna_request</span>

        <span class="c1"># ppGpp reactions based on charged tRNA</span>
        <span class="n">bulk_request</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">charging_molecule_idx</span><span class="p">,</span>
                <span class="n">requested_molecules</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">charged_trna_idx</span><span class="p">,</span> <span class="n">charged_trna_request</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)),</span>
            <span class="c1"># Request water for transfer of AA from tRNA for initial polypeptide.</span>
            <span class="c1"># This is severe overestimate assuming the worst case that every</span>
            <span class="c1"># elongation is initializing a polypeptide. This excess of water</span>
            <span class="c1"># shouldn&#39;t matter though.</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">water_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">aa_counts_for_translation</span><span class="o">.</span><span class="n">sum</span><span class="p">())),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_regulation</span><span class="p">:</span>
            <span class="n">total_trna_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">uncharged_trna_counts</span> <span class="o">+</span> <span class="n">charged_trna_counts</span>
            <span class="p">)</span>
            <span class="n">updated_charged_trna_conc</span> <span class="o">=</span> <span class="n">total_trna_conc</span> <span class="o">*</span> <span class="n">fraction_charged</span>
            <span class="n">updated_uncharged_trna_conc</span> <span class="o">=</span> <span class="n">total_trna_conc</span> <span class="o">-</span> <span class="n">updated_charged_trna_conc</span>
            <span class="n">delta_metabolites</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">ppgpp_metabolite_changes</span><span class="p">(</span>
                <span class="n">updated_uncharged_trna_conc</span><span class="p">,</span>
                <span class="n">updated_charged_trna_conc</span><span class="p">,</span>
                <span class="n">ribosome_conc</span><span class="p">,</span>
                <span class="n">f</span><span class="p">,</span>
                <span class="n">rela_conc</span><span class="p">,</span>
                <span class="n">spot_conc</span><span class="p">,</span>
                <span class="n">ppgpp_conc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span><span class="p">,</span>
                <span class="n">v_rib</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">charging_params</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_params</span><span class="p">,</span>
                <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">],</span>
                <span class="n">request</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">request_ppgpp_metabolites</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta_metabolites</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ppgpp_request</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_idx</span><span class="p">)</span>
            <span class="n">bulk_request</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_idx</span><span class="p">,</span> <span class="n">ppgpp_request</span><span class="p">))</span>
            <span class="n">bulk_request</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_rxn_metabolites_idx</span><span class="p">,</span>
                    <span class="n">request_ppgpp_metabolites</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">fraction_charged</span><span class="p">,</span>
            <span class="n">aa_counts_for_translation</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="n">bulk_request</span><span class="p">,</span>
                <span class="s2">&quot;listeners&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;growth_limits&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;original_aa_supply&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply</span><span class="p">,</span>
                        <span class="s2">&quot;aa_in_media&quot;</span><span class="p">:</span> <span class="n">aa_in_media</span><span class="p">,</span>
                        <span class="s2">&quot;synthetase_conc&quot;</span><span class="p">:</span> <span class="n">synthetase_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">),</span>
                        <span class="s2">&quot;uncharged_trna_conc&quot;</span><span class="p">:</span> <span class="n">uncharged_trna_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span>
                            <span class="n">MICROMOLAR_UNITS</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;charged_trna_conc&quot;</span><span class="p">:</span> <span class="n">charged_trna_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span>
                            <span class="n">MICROMOLAR_UNITS</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;aa_conc&quot;</span><span class="p">:</span> <span class="n">aa_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">),</span>
                        <span class="s2">&quot;ribosome_conc&quot;</span><span class="p">:</span> <span class="n">ribosome_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">),</span>
                        <span class="s2">&quot;fraction_aa_to_elongate&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span>
                        <span class="s2">&quot;aa_supply&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply</span><span class="p">,</span>
                        <span class="s2">&quot;aa_synthesis&quot;</span><span class="p">:</span> <span class="n">synthesis</span> <span class="o">*</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;aa_import&quot;</span><span class="p">:</span> <span class="n">import_rates</span> <span class="o">*</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;aa_export&quot;</span><span class="p">:</span> <span class="n">export_rates</span> <span class="o">*</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;aa_supply_enzymes_fwd&quot;</span><span class="p">:</span> <span class="n">fwd_enzyme_counts</span><span class="p">,</span>
                        <span class="s2">&quot;aa_supply_enzymes_rev&quot;</span><span class="p">:</span> <span class="n">rev_enzyme_counts</span><span class="p">,</span>
                        <span class="s2">&quot;aa_importers&quot;</span><span class="p">:</span> <span class="n">importer_counts</span><span class="p">,</span>
                        <span class="s2">&quot;aa_exporters&quot;</span><span class="p">:</span> <span class="n">exporter_counts</span><span class="p">,</span>
                        <span class="s2">&quot;aa_supply_aa_conc&quot;</span><span class="p">:</span> <span class="n">aa_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">mmol</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">L</span><span class="p">),</span>
                        <span class="s2">&quot;aa_supply_fraction_fwd&quot;</span><span class="p">:</span> <span class="n">fwd_saturation</span><span class="p">,</span>
                        <span class="s2">&quot;aa_supply_fraction_rev&quot;</span><span class="p">:</span> <span class="n">rev_saturation</span><span class="p">,</span>
                        <span class="s2">&quot;ppgpp_conc&quot;</span><span class="p">:</span> <span class="n">ppgpp_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">),</span>
                        <span class="s2">&quot;rela_conc&quot;</span><span class="p">:</span> <span class="n">rela_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">),</span>
                        <span class="s2">&quot;spot_conc&quot;</span><span class="p">:</span> <span class="n">spot_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;polypeptide_elongation&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;aa_exchange_rates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span>
                    <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">import_rates</span> <span class="o">-</span> <span class="n">export_rates</span><span class="p">)</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SteadyStateElongationModel.final_amino_acids">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.SteadyStateElongationModel.final_amino_acids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">final_amino_acids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_aa_counts</span><span class="p">,</span> <span class="n">charged_trna_counts</span><span class="p">):</span>
        <span class="n">charged_counts_to_uncharge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span> <span class="o">@</span> <span class="n">charged_trna_counts</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span>
            <span class="n">total_aa_counts</span> <span class="o">+</span> <span class="n">charged_counts_to_uncharge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aa_counts_for_translation</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SteadyStateElongationModel.evolve">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.SteadyStateElongationModel.evolve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">states</span><span class="p">,</span>
        <span class="n">total_aa_counts</span><span class="p">,</span>
        <span class="n">aas_used</span><span class="p">,</span>
        <span class="n">next_amino_acid_count</span><span class="p">,</span>
        <span class="n">nElongations</span><span class="p">,</span>
        <span class="n">nInitialized</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;listeners&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;growth_limits&quot;</span><span class="p">:</span> <span class="p">{}},</span>
        <span class="p">}</span>

        <span class="c1"># Get tRNA counts</span>
        <span class="n">uncharged_trna</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">uncharged_trna_idx</span><span class="p">)</span>
        <span class="n">charged_trna</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">charged_trna_idx</span><span class="p">)</span>
        <span class="n">total_trna</span> <span class="o">=</span> <span class="n">uncharged_trna</span> <span class="o">+</span> <span class="n">charged_trna</span>

        <span class="c1"># Adjust molecules for number of charging reactions that occurred</span>
        <span class="c1">## Determine limitations for charging and uncharging reactions</span>
        <span class="n">charged_and_elongated_per_aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">aas_used</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span> <span class="o">@</span> <span class="n">charged_trna</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">aa_for_charging</span> <span class="o">=</span> <span class="n">total_aa_counts</span> <span class="o">-</span> <span class="n">charged_and_elongated_per_aa</span>
        <span class="n">n_aa_charged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span>
            <span class="n">aa_for_charging</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_to_charge</span><span class="p">,</span> <span class="n">uncharged_trna</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">n_uncharged_per_aa</span> <span class="o">=</span> <span class="n">aas_used</span> <span class="o">-</span> <span class="n">charged_and_elongated_per_aa</span>

        <span class="c1">## Calculate changes in tRNA based on limitations</span>
        <span class="n">n_trna_charged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution_from_aa</span><span class="p">(</span><span class="n">n_aa_charged</span><span class="p">,</span> <span class="n">uncharged_trna</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">n_trna_uncharged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution_from_aa</span><span class="p">(</span>
            <span class="n">n_uncharged_per_aa</span><span class="p">,</span> <span class="n">charged_trna</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1">## Determine reactions that are charged and elongated in same time step without changing</span>
        <span class="c1">## charged or uncharged counts</span>
        <span class="n">charged_and_elongated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution_from_aa</span><span class="p">(</span>
            <span class="n">charged_and_elongated_per_aa</span><span class="p">,</span> <span class="n">total_trna</span>
        <span class="p">)</span>

        <span class="c1">## Determine total number of reactions that occur</span>
        <span class="n">total_uncharging_reactions</span> <span class="o">=</span> <span class="n">charged_and_elongated</span> <span class="o">+</span> <span class="n">n_trna_uncharged</span>
        <span class="n">total_charging_reactions</span> <span class="o">=</span> <span class="n">charged_and_elongated</span> <span class="o">+</span> <span class="n">n_trna_charged</span>
        <span class="n">net_charged</span> <span class="o">=</span> <span class="n">total_charging_reactions</span> <span class="o">-</span> <span class="n">total_uncharging_reactions</span>
        <span class="n">charging_mol_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">charging_stoich_matrix</span><span class="p">,</span> <span class="n">total_charging_reactions</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">charging_molecule_idx</span><span class="p">,</span> <span class="n">charging_mol_delta</span><span class="p">))</span>
        <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">charging_molecule_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">charging_mol_delta</span>

        <span class="c1">## Account for uncharging of tRNA during elongation</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">charged_trna_idx</span><span class="p">,</span> <span class="o">-</span><span class="n">total_uncharging_reactions</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">uncharged_trna_idx</span><span class="p">,</span> <span class="n">total_uncharging_reactions</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">charged_trna_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">total_uncharging_reactions</span>
        <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">uncharged_trna_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total_uncharging_reactions</span>

        <span class="c1"># Update proton counts to reflect polymerization reactions and transfer of AA from tRNA</span>
        <span class="c1"># Peptide bond formation releases a water but transferring AA from tRNA consumes a OH-</span>
        <span class="c1"># Net production of H+ for each elongation, consume extra water for each initialization</span>
        <span class="c1"># since a peptide bond doesn&#39;t form</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">proton_idx</span><span class="p">,</span> <span class="n">nElongations</span><span class="p">))</span>
        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">water_idx</span><span class="p">,</span> <span class="o">-</span><span class="n">nInitialized</span><span class="p">))</span>
        <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">proton_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nElongations</span>
        <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">water_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">nInitialized</span>

        <span class="c1"># Create or degrade ppGpp</span>
        <span class="c1"># This should come after all countInc/countDec calls since it shares some molecules with</span>
        <span class="c1"># other views and those counts should be updated to get the proper limits on ppGpp reactions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_regulation</span><span class="p">:</span>
            <span class="n">v_rib</span> <span class="o">=</span> <span class="p">(</span><span class="n">nElongations</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span><span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span>
                <span class="n">MICROMOLAR_UNITS</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span>
            <span class="n">ribosome_conc</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">states</span><span class="p">[</span><span class="s2">&quot;active_ribosome&quot;</span><span class="p">][</span><span class="s2">&quot;_entryState&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">updated_uncharged_trna_counts</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">uncharged_trna_idx</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">net_charged</span>
            <span class="p">)</span>
            <span class="n">updated_charged_trna_counts</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">charged_trna_idx</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">net_charged</span>
            <span class="p">)</span>
            <span class="n">uncharged_trna_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">,</span> <span class="n">updated_uncharged_trna_counts</span>
            <span class="p">)</span>
            <span class="n">charged_trna_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">,</span> <span class="n">updated_charged_trna_counts</span>
            <span class="p">)</span>
            <span class="n">ppgpp_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">counts</span><span class="p">(</span>
                <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_idx</span>
            <span class="p">)</span>
            <span class="n">rela_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">counts</span><span class="p">(</span>
                <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">rela_idx</span>
            <span class="p">)</span>
            <span class="n">spot_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">counts</span><span class="p">(</span>
                <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk_total&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">spot_idx</span>
            <span class="p">)</span>

            <span class="c1"># Need to include the next amino acid the ribosome sees for certain</span>
            <span class="c1"># cases where elongation does not occur, otherwise f will be NaN</span>
            <span class="n">aa_at_ribosome</span> <span class="o">=</span> <span class="n">aas_used</span> <span class="o">+</span> <span class="n">next_amino_acid_count</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">aa_at_ribosome</span> <span class="o">/</span> <span class="n">aa_at_ribosome</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_rxn_metabolites_idx</span><span class="p">)</span>
            <span class="p">(</span>
                <span class="n">delta_metabolites</span><span class="p">,</span>
                <span class="n">ppgpp_syn</span><span class="p">,</span>
                <span class="n">ppgpp_deg</span><span class="p">,</span>
                <span class="n">rela_syn</span><span class="p">,</span>
                <span class="n">spot_syn</span><span class="p">,</span>
                <span class="n">spot_deg</span><span class="p">,</span>
                <span class="n">spot_deg_inhibited</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">ppgpp_metabolite_changes</span><span class="p">(</span>
                <span class="n">uncharged_trna_conc</span><span class="p">,</span>
                <span class="n">charged_trna_conc</span><span class="p">,</span>
                <span class="n">ribosome_conc</span><span class="p">,</span>
                <span class="n">f</span><span class="p">,</span>
                <span class="n">rela_conc</span><span class="p">,</span>
                <span class="n">spot_conc</span><span class="p">,</span>
                <span class="n">ppgpp_conc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counts_to_molar</span><span class="p">,</span>
                <span class="n">v_rib</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">charging_params</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_params</span><span class="p">,</span>
                <span class="n">states</span><span class="p">[</span><span class="s2">&quot;timestep&quot;</span><span class="p">],</span>
                <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
                <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">update</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;growth_limits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;rela_syn&quot;</span><span class="p">:</span> <span class="n">rela_syn</span><span class="p">,</span>
                <span class="s2">&quot;spot_syn&quot;</span><span class="p">:</span> <span class="n">spot_syn</span><span class="p">,</span>
                <span class="s2">&quot;spot_deg&quot;</span><span class="p">:</span> <span class="n">spot_deg</span><span class="p">,</span>
                <span class="s2">&quot;spot_deg_inhibited&quot;</span><span class="p">:</span> <span class="n">spot_deg_inhibited</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">update</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_rxn_metabolites_idx</span><span class="p">,</span> <span class="n">delta_metabolites</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">states</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ppgpp_rxn_metabolites_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">delta_metabolites</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Use the difference between (expected AA supply based on expected</span>
        <span class="c1"># doubling time and current DCW) and AA used to charge tRNA to update</span>
        <span class="c1"># the concentration target in metabolism during the next time step</span>
        <span class="n">aa_used_trna</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">,</span> <span class="n">total_charging_reactions</span><span class="p">)</span>
        <span class="n">aa_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_supply</span> <span class="o">-</span> <span class="n">aa_used_trna</span>

        <span class="n">update</span><span class="p">[</span><span class="s2">&quot;listeners&quot;</span><span class="p">][</span><span class="s2">&quot;growth_limits&quot;</span><span class="p">][</span><span class="s2">&quot;trna_charged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aa_used_trna</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">net_charged</span><span class="p">,</span>
            <span class="n">aa_diff</span><span class="p">,</span>
            <span class="n">update</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SteadyStateElongationModel.distribution_from_aa">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.SteadyStateElongationModel.distribution_from_aa">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">distribution_from_aa</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_aa</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span>
        <span class="n">n_trna</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span>
        <span class="n">limited</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Distributes counts of amino acids to tRNAs that are associated with</span>
<span class="sd">        each amino acid. Uses self.process.aa_from_trna mapping to distribute</span>
<span class="sd">        from amino acids to tRNA based on the fraction that each tRNA species</span>
<span class="sd">        makes up for all tRNA species that code for the same amino acid.</span>

<span class="sd">        Args:</span>
<span class="sd">            n_aa: counts of each amino acid to distribute to each tRNA</span>
<span class="sd">            n_trna: counts of each tRNA to determine the distribution</span>
<span class="sd">            limited: optional, if True, limits the amino acids</span>
<span class="sd">                distributed to each tRNA to the number of tRNA that are</span>
<span class="sd">                available (n_trna)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Distributed counts for each tRNA</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Determine the fraction each tRNA species makes up out of all tRNA of</span>
        <span class="c1"># the associated amino acid</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
            <span class="n">f_trna</span> <span class="o">=</span> <span class="n">n_trna</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">,</span> <span class="n">n_trna</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span>
            <span class="p">)</span>
        <span class="n">f_trna</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">f_trna</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">trna_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">f_trna</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">n_aa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">f_trna</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">frac</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">counts</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

            <span class="c1"># Add additional counts to get up to counts to distribute</span>
            <span class="c1"># Prevent adding over the number of tRNA available if limited</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">limited</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">diff</span><span class="p">):</span>
                        <span class="n">frac</span><span class="p">[(</span><span class="n">n_trna</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">counts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c1"># normalize for multinomial distribution</span>
                        <span class="n">frac</span> <span class="o">/=</span> <span class="n">frac</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">adjustment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">random_state</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
                        <span class="n">counts</span> <span class="o">+=</span> <span class="n">adjustment</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">adjustment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">random_state</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
                    <span class="n">counts</span> <span class="o">+=</span> <span class="n">adjustment</span>

            <span class="n">trna_counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>

        <span class="k">return</span> <span class="n">trna_counts</span></div>
</div>



<div class="viewcode-block" id="ppgpp_metabolite_changes">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.ppgpp_metabolite_changes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ppgpp_metabolite_changes</span><span class="p">(</span>
    <span class="n">uncharged_trna_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">charged_trna_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">ribosome_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
    <span class="n">rela_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">spot_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">ppgpp_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">counts_to_molar</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">v_rib</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">charging_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">ppgpp_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">time_step</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">request</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">limits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Unum</span><span class="p">,</span> <span class="n">Unum</span><span class="p">,</span> <span class="n">Unum</span><span class="p">,</span> <span class="n">Unum</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the changes in metabolite counts based on ppGpp synthesis and</span>
<span class="sd">    degradation reactions.</span>

<span class="sd">    Args:</span>
<span class="sd">        uncharged_trna_conc: concentration (:py:data:`~ecoli.processes.polypeptide_elongation.MICROMOLAR_UNITS`)</span>
<span class="sd">            of uncharged tRNA associated with each amino acid</span>
<span class="sd">        charged_trna_conc: concentration (:py:data:`~ecoli.processes.polypeptide_elongation.MICROMOLAR_UNITS`)</span>
<span class="sd">            of charged tRNA associated with each amino acid</span>
<span class="sd">        ribosome_conc: concentration (:py:data:`~ecoli.processes.polypeptide_elongation.MICROMOLAR_UNITS`)</span>
<span class="sd">            of active ribosomes</span>
<span class="sd">        f: fraction of each amino acid to be incorporated</span>
<span class="sd">            to total amino acids incorporated</span>
<span class="sd">        rela_conc: concentration (:py:data:`~ecoli.processes.polypeptide_elongation.MICROMOLAR_UNITS`) of RelA</span>
<span class="sd">        spot_conc: concentration (:py:data:`~ecoli.processes.polypeptide_elongation.MICROMOLAR_UNITS`) of SpoT</span>
<span class="sd">        ppgpp_conc: concentration (:py:data:`~ecoli.processes.polypeptide_elongation.MICROMOLAR_UNITS`) of ppGpp</span>
<span class="sd">        counts_to_molar: conversion factor</span>
<span class="sd">            from counts to molarity (:py:data:`~ecoli.processes.polypeptide_elongation.MICROMOLAR_UNITS`)</span>
<span class="sd">        v_rib: rate of amino acid incorporation at the ribosome (units of uM/s)</span>
<span class="sd">        charging_params: parameters used in charging equations</span>
<span class="sd">        ppgpp_params: parameters used in ppGpp reactions</span>
<span class="sd">        time_step: length of the current time step</span>
<span class="sd">        request: if True, only considers reactant stoichiometry,</span>
<span class="sd">            otherwise considers reactants and products. For use in</span>
<span class="sd">            calculateRequest. GDP appears as both a reactant and product</span>
<span class="sd">            and the request can be off the actual use if not handled in this</span>
<span class="sd">            manner.</span>
<span class="sd">        limits: counts of molecules that are available to prevent</span>
<span class="sd">            negative total counts as a result of delta_metabolites.</span>
<span class="sd">            If None, no limits are placed on molecule changes.</span>
<span class="sd">        random_state: random state for the process</span>
<span class="sd">    Returns:</span>
<span class="sd">        7-element tuple containing</span>

<span class="sd">        - **delta_metabolites**: the change in counts of each metabolite</span>
<span class="sd">          involved in ppGpp reactions</span>
<span class="sd">        - **n_syn_reactions**: the number of ppGpp synthesis reactions</span>
<span class="sd">        - **n_deg_reactions**: the number of ppGpp degradation reactions</span>
<span class="sd">        - **v_rela_syn**: rate of synthesis from RelA per amino</span>
<span class="sd">          acid tRNA species</span>
<span class="sd">        - **v_spot_syn**: rate of synthesis from SpoT</span>
<span class="sd">        - **v_deg**: rate of degradation from SpoT</span>
<span class="sd">        - **v_deg_inhibited**: rate of degradation from SpoT per</span>
<span class="sd">          amino acid tRNA species</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()</span>

    <span class="n">uncharged_trna_conc</span> <span class="o">=</span> <span class="n">uncharged_trna_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">charged_trna_conc</span> <span class="o">=</span> <span class="n">charged_trna_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">ribosome_conc</span> <span class="o">=</span> <span class="n">ribosome_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">rela_conc</span> <span class="o">=</span> <span class="n">rela_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">spot_conc</span> <span class="o">=</span> <span class="n">spot_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">ppgpp_conc</span> <span class="o">=</span> <span class="n">ppgpp_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">counts_to_micromolar</span> <span class="o">=</span> <span class="n">counts_to_molar</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>

    <span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mi">1</span>
        <span class="o">+</span> <span class="n">charged_trna_conc</span> <span class="o">/</span> <span class="n">charging_params</span><span class="p">[</span><span class="s2">&quot;krta&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">uncharged_trna_conc</span> <span class="o">/</span> <span class="n">charging_params</span><span class="p">[</span><span class="s2">&quot;krtf&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">saturated_charged</span> <span class="o">=</span> <span class="n">charged_trna_conc</span> <span class="o">/</span> <span class="n">charging_params</span><span class="p">[</span><span class="s2">&quot;krta&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">numerator</span>
    <span class="n">saturated_uncharged</span> <span class="o">=</span> <span class="n">uncharged_trna_conc</span> <span class="o">/</span> <span class="n">charging_params</span><span class="p">[</span><span class="s2">&quot;krtf&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">numerator</span>
    <span class="k">if</span> <span class="n">v_rib</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ribosome_conc_a_site</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">ribosome_conc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ribosome_conc_a_site</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f</span> <span class="o">*</span> <span class="n">v_rib</span> <span class="o">/</span> <span class="p">(</span><span class="n">saturated_charged</span> <span class="o">*</span> <span class="n">charging_params</span><span class="p">[</span><span class="s2">&quot;max_elong_rate&quot;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="n">ribosomes_bound_to_uncharged</span> <span class="o">=</span> <span class="n">ribosome_conc_a_site</span> <span class="o">*</span> <span class="n">saturated_uncharged</span>

    <span class="c1"># Handle rare cases when tRNA concentrations are 0</span>
    <span class="c1"># Can result in inf and nan so assume a fraction of ribosomes</span>
    <span class="c1"># bind to the uncharged tRNA if any tRNA are present or 0 if not</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ribosomes_bound_to_uncharged</span><span class="p">)</span>
    <span class="n">ribosomes_bound_to_uncharged</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ribosome_conc</span>
        <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">uncharged_trna_conc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">charged_trna_conc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Calculate active fraction of RelA</span>
    <span class="n">competitive_inhibition</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ribosomes_bound_to_uncharged</span> <span class="o">/</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;KD_RelA&quot;</span><span class="p">]</span>
    <span class="n">inhibition_product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">competitive_inhibition</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
        <span class="n">frac_rela</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;KD_RelA&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">ribosomes_bound_to_uncharged</span>
            <span class="o">*</span> <span class="n">inhibition_product</span>
            <span class="o">/</span> <span class="n">competitive_inhibition</span>
            <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>

    <span class="c1"># Calculate rates for synthesis and degradation</span>
    <span class="n">v_rela_syn</span> <span class="o">=</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;k_RelA&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">rela_conc</span> <span class="o">*</span> <span class="n">frac_rela</span>
    <span class="n">v_spot_syn</span> <span class="o">=</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;k_SpoT_syn&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spot_conc</span>
    <span class="n">v_syn</span> <span class="o">=</span> <span class="n">v_rela_syn</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">v_spot_syn</span>
    <span class="n">max_deg</span> <span class="o">=</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;k_SpoT_deg&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spot_conc</span> <span class="o">*</span> <span class="n">ppgpp_conc</span>
    <span class="n">fractions</span> <span class="o">=</span> <span class="n">uncharged_trna_conc</span> <span class="o">/</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;KI_SpoT&quot;</span><span class="p">]</span>
    <span class="n">v_deg</span> <span class="o">=</span> <span class="n">max_deg</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">fractions</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">v_deg_inhibited</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_deg</span> <span class="o">-</span> <span class="n">v_deg</span><span class="p">)</span> <span class="o">*</span> <span class="n">fractions</span> <span class="o">/</span> <span class="n">fractions</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Convert to discrete reactions</span>
    <span class="n">n_syn_reactions</span> <span class="o">=</span> <span class="n">stochasticRound</span><span class="p">(</span>
        <span class="n">random_state</span><span class="p">,</span> <span class="n">v_syn</span> <span class="o">*</span> <span class="n">time_step</span> <span class="o">/</span> <span class="n">counts_to_micromolar</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_deg_reactions</span> <span class="o">=</span> <span class="n">stochasticRound</span><span class="p">(</span>
        <span class="n">random_state</span><span class="p">,</span> <span class="n">v_deg</span> <span class="o">*</span> <span class="n">time_step</span> <span class="o">/</span> <span class="n">counts_to_micromolar</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Only look at reactant stoichiometry if requesting molecules to use</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
        <span class="n">ppgpp_reaction_stoich</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;ppgpp_reaction_stoich&quot;</span><span class="p">])</span>
        <span class="n">reactants</span> <span class="o">=</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;ppgpp_reaction_stoich&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">ppgpp_reaction_stoich</span><span class="p">[</span><span class="n">reactants</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;ppgpp_reaction_stoich&quot;</span><span class="p">][</span>
            <span class="n">reactants</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ppgpp_reaction_stoich</span> <span class="o">=</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;ppgpp_reaction_stoich&quot;</span><span class="p">]</span>

    <span class="c1"># Calculate the change in metabolites and adjust to limits if provided</span>
    <span class="c1"># Possible reactions are adjusted down to limits if the change in any</span>
    <span class="c1"># metabolites would result in negative counts</span>
    <span class="n">max_iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_deg_reactions</span> <span class="o">+</span> <span class="n">n_syn_reactions</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">old_counts</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="n">delta_metabolites</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ppgpp_reaction_stoich</span><span class="p">[:,</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;synthesis_index&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">n_syn_reactions</span>
            <span class="o">+</span> <span class="n">ppgpp_reaction_stoich</span><span class="p">[:,</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;degradation_index&quot;</span><span class="p">]]</span>
            <span class="o">*</span> <span class="n">n_deg_reactions</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_counts</span> <span class="o">=</span> <span class="n">delta_metabolites</span> <span class="o">+</span> <span class="n">limits</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">final_counts</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">old_counts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">final_counts</span> <span class="o">==</span> <span class="n">old_counts</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">break</span>

            <span class="n">limited_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">final_counts</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ppgpp_reaction_stoich</span><span class="p">[</span><span class="n">limited_index</span><span class="p">,</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;synthesis_index&quot;</span><span class="p">]]</span>
                <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">limited</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                    <span class="n">final_counts</span><span class="p">[</span><span class="n">limited_index</span><span class="p">]</span>
                    <span class="o">/</span> <span class="n">ppgpp_reaction_stoich</span><span class="p">[</span>
                        <span class="n">limited_index</span><span class="p">,</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;synthesis_index&quot;</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">n_syn_reactions</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limited</span><span class="p">,</span> <span class="n">n_syn_reactions</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ppgpp_reaction_stoich</span><span class="p">[</span><span class="n">limited_index</span><span class="p">,</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;degradation_index&quot;</span><span class="p">]]</span>
                <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">limited</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                    <span class="n">final_counts</span><span class="p">[</span><span class="n">limited_index</span><span class="p">]</span>
                    <span class="o">/</span> <span class="n">ppgpp_reaction_stoich</span><span class="p">[</span>
                        <span class="n">limited_index</span><span class="p">,</span> <span class="n">ppgpp_params</span><span class="p">[</span><span class="s2">&quot;degradation_index&quot;</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">n_deg_reactions</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limited</span><span class="p">,</span> <span class="n">n_deg_reactions</span><span class="p">)</span>

            <span class="n">old_counts</span> <span class="o">=</span> <span class="n">final_counts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to meet molecule limits with ppGpp reactions.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">delta_metabolites</span><span class="p">,</span>
        <span class="n">n_syn_reactions</span><span class="p">,</span>
        <span class="n">n_deg_reactions</span><span class="p">,</span>
        <span class="n">v_rela_syn</span><span class="p">,</span>
        <span class="n">v_spot_syn</span><span class="p">,</span>
        <span class="n">v_deg</span><span class="p">,</span>
        <span class="n">v_deg_inhibited</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="calculate_trna_charging">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.calculate_trna_charging">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_trna_charging</span><span class="p">(</span>
    <span class="n">synthetase_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">uncharged_trna_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">charged_trna_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">aa_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">ribosome_conc</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">supply</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">limit_v_rib</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_disabled_aas</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Unum</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Unum</span><span class="p">,</span> <span class="n">Unum</span><span class="p">,</span> <span class="n">Unum</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the steady state value of tRNA based on charging and</span>
<span class="sd">    incorporation through polypeptide elongation. The fraction of</span>
<span class="sd">    charged/uncharged is also used to determine how quickly the</span>
<span class="sd">    ribosome is elongating. All concentrations are given in units of</span>
<span class="sd">    :py:data:`~ecoli.processes.polypeptide_elongation.MICROMOLAR_UNITS`.</span>

<span class="sd">    Args:</span>
<span class="sd">        synthetase_conc: concentration of synthetases associated with</span>
<span class="sd">            each amino acid</span>
<span class="sd">        uncharged_trna_conc: concentration of uncharged tRNA associated</span>
<span class="sd">            with each amino acid</span>
<span class="sd">        charged_trna_conc: concentration of charged tRNA associated with</span>
<span class="sd">            each amino acid</span>
<span class="sd">        aa_conc: concentration of each amino acid</span>
<span class="sd">        ribosome_conc: concentration of active ribosomes</span>
<span class="sd">        f: fraction of each amino acid to be incorporated to total amino</span>
<span class="sd">            acids incorporated</span>
<span class="sd">        params: parameters used in charging equations</span>
<span class="sd">        supply: function to get the rate of amino acid supply (synthesis</span>
<span class="sd">            and import) based on amino acid concentrations. If None, amino</span>
<span class="sd">            acid concentrations remain constant during charging</span>
<span class="sd">        time_limit: time limit to reach steady state</span>
<span class="sd">        limit_v_rib: if True, v_rib is limited to the number of amino acids</span>
<span class="sd">            that are available</span>
<span class="sd">        use_disabled_aas: if False, amino acids in</span>
<span class="sd">            :py:data:`~ecoli.processes.polypeptide_elongation.REMOVED_FROM_CHARGING`</span>
<span class="sd">            are excluded from charging</span>

<span class="sd">    Returns:</span>
<span class="sd">        5-element tuple containing</span>

<span class="sd">        - **new_fraction_charged**: fraction of total tRNA that is charged for each</span>
<span class="sd">          amino acid species</span>
<span class="sd">        - **v_rib**: ribosomal elongation rate in units of uM/s</span>
<span class="sd">        - **total_synthesis**: the total amount of amino acids synthesized during charging</span>
<span class="sd">          in units of MICROMOLAR_UNITS. Will be zeros if supply function is not given.</span>
<span class="sd">        - **total_import**: the total amount of amino acids imported during charging</span>
<span class="sd">          in units of MICROMOLAR_UNITS. Will be zeros if supply function is not given.</span>
<span class="sd">        - **total_export**: the total amount of amino acids exported during charging</span>
<span class="sd">          in units of MICROMOLAR_UNITS. Will be zeros if supply function is not given.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">negative_check</span><span class="p">(</span><span class="n">trna1</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">trna2</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check for floating point precision issues that can lead to small</span>
<span class="sd">        negative numbers instead of 0. Adjusts both species of tRNA to</span>
<span class="sd">        bring concentration of trna1 to 0 and keep the same total concentration.</span>

<span class="sd">        Args:</span>
<span class="sd">            trna1: concentration of one tRNA species (charged or uncharged)</span>
<span class="sd">            trna2: concentration of another tRNA species (charged or uncharged)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">trna1</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">trna2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">trna1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">trna2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">trna1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dcdt</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for solve_ivp to integrate</span>

<span class="sd">        Args:</span>
<span class="sd">            c: 1D array of concentrations of uncharged and charged tRNAs</span>
<span class="sd">                dims: 2 * number of amino acids (uncharged tRNA come first, then charged)</span>
<span class="sd">            t: time of integration step</span>

<span class="sd">        Returns:</span>
<span class="sd">            Array of dc/dt for tRNA concentrations</span>
<span class="sd">                dims: 2 * number of amino acids (uncharged tRNA come first, then charged)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">v_charging</span><span class="p">,</span> <span class="n">dtrna</span><span class="p">,</span> <span class="n">daa</span> <span class="o">=</span> <span class="n">dcdt_jit</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span>
            <span class="n">c</span><span class="p">,</span>
            <span class="n">n_aas_masked</span><span class="p">,</span>
            <span class="n">n_aas</span><span class="p">,</span>
            <span class="n">mask</span><span class="p">,</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kS&quot;</span><span class="p">],</span>
            <span class="n">synthetase_conc</span><span class="p">,</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;KMaa&quot;</span><span class="p">],</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;KMtf&quot;</span><span class="p">],</span>
            <span class="n">f</span><span class="p">,</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;krta&quot;</span><span class="p">],</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;krtf&quot;</span><span class="p">],</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;max_elong_rate&quot;</span><span class="p">],</span>
            <span class="n">ribosome_conc</span><span class="p">,</span>
            <span class="n">limit_v_rib</span><span class="p">,</span>
            <span class="n">aa_rate_limit</span><span class="p">,</span>
            <span class="n">v_rib_max</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">supply</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v_synthesis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_aas</span><span class="p">)</span>
            <span class="n">v_import</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_aas</span><span class="p">)</span>
            <span class="n">v_export</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_aas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aa_conc</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="o">+</span> <span class="n">n_aas</span><span class="p">]</span>
            <span class="n">v_synthesis</span><span class="p">,</span> <span class="n">v_import</span><span class="p">,</span> <span class="n">v_export</span> <span class="o">=</span> <span class="n">supply</span><span class="p">(</span><span class="n">unit_conversion</span> <span class="o">*</span> <span class="n">aa_conc</span><span class="p">)</span>
            <span class="n">v_supply</span> <span class="o">=</span> <span class="n">v_synthesis</span> <span class="o">+</span> <span class="n">v_import</span> <span class="o">-</span> <span class="n">v_export</span>
            <span class="n">daa</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_supply</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_charging</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">dtrna</span><span class="p">,</span> <span class="n">dtrna</span><span class="p">,</span> <span class="n">daa</span><span class="p">,</span> <span class="n">v_synthesis</span><span class="p">,</span> <span class="n">v_import</span><span class="p">,</span> <span class="n">v_export</span><span class="p">))</span>

    <span class="c1"># Convert inputs for integration</span>
    <span class="n">synthetase_conc</span> <span class="o">=</span> <span class="n">synthetase_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">uncharged_trna_conc</span> <span class="o">=</span> <span class="n">uncharged_trna_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">charged_trna_conc</span> <span class="o">=</span> <span class="n">charged_trna_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">aa_conc</span> <span class="o">=</span> <span class="n">aa_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">ribosome_conc</span> <span class="o">=</span> <span class="n">ribosome_conc</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
    <span class="n">unit_conversion</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;unit_conversion&quot;</span><span class="p">]</span>

    <span class="c1"># Remove disabled amino acids from calculations</span>
    <span class="n">n_total_aas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa_conc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_disabled_aas</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_total_aas</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;charging_mask&quot;</span><span class="p">]</span>
    <span class="n">synthetase_conc</span> <span class="o">=</span> <span class="n">synthetase_conc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">original_uncharged_trna_conc</span> <span class="o">=</span> <span class="n">uncharged_trna_conc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">original_charged_trna_conc</span> <span class="o">=</span> <span class="n">charged_trna_conc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">original_aa_conc</span> <span class="o">=</span> <span class="n">aa_conc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="n">n_aas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa_conc</span><span class="p">)</span>
    <span class="n">n_aas_masked</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_aa_conc</span><span class="p">)</span>

    <span class="c1"># Limits for integration</span>
    <span class="n">aa_rate_limit</span> <span class="o">=</span> <span class="n">original_aa_conc</span> <span class="o">/</span> <span class="n">time_limit</span>
    <span class="n">trna_rate_limit</span> <span class="o">=</span> <span class="n">original_charged_trna_conc</span> <span class="o">/</span> <span class="n">time_limit</span>
    <span class="n">v_rib_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="n">aa_rate_limit</span> <span class="o">+</span> <span class="n">trna_rate_limit</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="c1"># Integrate rates of charging and elongation</span>
    <span class="n">c_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">original_uncharged_trna_conc</span><span class="p">,</span>
            <span class="n">original_charged_trna_conc</span><span class="p">,</span>
            <span class="n">aa_conc</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_aas</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_aas</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_aas</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span><span class="n">dcdt</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_limit</span><span class="p">],</span> <span class="n">c_init</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BDF&quot;</span><span class="p">)</span>
    <span class="n">c_sol</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Determine new values from integration results</span>
    <span class="n">final_uncharged_trna_conc</span> <span class="o">=</span> <span class="n">c_sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="n">n_aas_masked</span><span class="p">]</span>
    <span class="n">final_charged_trna_conc</span> <span class="o">=</span> <span class="n">c_sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_aas_masked</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span><span class="p">]</span>
    <span class="n">total_synthesis</span> <span class="o">=</span> <span class="n">c_sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="o">+</span> <span class="n">n_aas</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas</span><span class="p">]</span>
    <span class="n">total_import</span> <span class="o">=</span> <span class="n">c_sol</span><span class="p">[</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_aas</span>
    <span class="p">]</span>
    <span class="n">total_export</span> <span class="o">=</span> <span class="n">c_sol</span><span class="p">[</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_aas</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">n_aas</span>
    <span class="p">]</span>

    <span class="n">negative_check</span><span class="p">(</span><span class="n">final_uncharged_trna_conc</span><span class="p">,</span> <span class="n">final_charged_trna_conc</span><span class="p">)</span>
    <span class="n">negative_check</span><span class="p">(</span><span class="n">final_charged_trna_conc</span><span class="p">,</span> <span class="n">final_uncharged_trna_conc</span><span class="p">)</span>

    <span class="n">fraction_charged</span> <span class="o">=</span> <span class="n">final_charged_trna_conc</span> <span class="o">/</span> <span class="p">(</span>
        <span class="n">final_uncharged_trna_conc</span> <span class="o">+</span> <span class="n">final_charged_trna_conc</span>
    <span class="p">)</span>
    <span class="n">numerator_ribosome</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">f</span>
        <span class="o">*</span> <span class="p">(</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;krta&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">final_charged_trna_conc</span>
            <span class="o">+</span> <span class="n">final_uncharged_trna_conc</span>
            <span class="o">/</span> <span class="n">final_charged_trna_conc</span>
            <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;krta&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;krtf&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">v_rib</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;max_elong_rate&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ribosome_conc</span> <span class="o">/</span> <span class="n">numerator_ribosome</span>
    <span class="k">if</span> <span class="n">limit_v_rib</span><span class="p">:</span>
        <span class="n">v_rib_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">original_aa_conc</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">original_charged_trna_conc</span> <span class="o">-</span> <span class="n">final_charged_trna_conc</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">time_limit</span>
                <span class="o">/</span> <span class="n">f</span>
            <span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">v_rib</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v_rib</span><span class="p">,</span> <span class="n">v_rib_max</span><span class="p">)</span>

    <span class="c1"># Replace SEL fraction charged with average</span>
    <span class="n">new_fraction_charged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_total_aas</span><span class="p">)</span>
    <span class="n">new_fraction_charged</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">fraction_charged</span>
    <span class="n">new_fraction_charged</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">fraction_charged</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">new_fraction_charged</span><span class="p">,</span> <span class="n">v_rib</span><span class="p">,</span> <span class="n">total_synthesis</span><span class="p">,</span> <span class="n">total_import</span><span class="p">,</span> <span class="n">total_export</span></div>



<div class="viewcode-block" id="dcdt_jit">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.dcdt_jit">[docs]</a>
<span class="nd">@njit</span><span class="p">(</span><span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dcdt_jit</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">c</span><span class="p">,</span>
    <span class="n">n_aas_masked</span><span class="p">,</span>
    <span class="n">n_aas</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">,</span>
    <span class="n">kS</span><span class="p">,</span>
    <span class="n">synthetase_conc</span><span class="p">,</span>
    <span class="n">KMaa</span><span class="p">,</span>
    <span class="n">KMtf</span><span class="p">,</span>
    <span class="n">f</span><span class="p">,</span>
    <span class="n">krta</span><span class="p">,</span>
    <span class="n">krtf</span><span class="p">,</span>
    <span class="n">max_elong_rate</span><span class="p">,</span>
    <span class="n">ribosome_conc</span><span class="p">,</span>
    <span class="n">limit_v_rib</span><span class="p">,</span>
    <span class="n">aa_rate_limit</span><span class="p">,</span>
    <span class="n">v_rib_max</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">uncharged_trna_conc</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:</span><span class="n">n_aas_masked</span><span class="p">]</span>
    <span class="n">charged_trna_conc</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">n_aas_masked</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span><span class="p">]</span>
    <span class="n">aa_conc</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_aas_masked</span> <span class="o">+</span> <span class="n">n_aas</span><span class="p">]</span>
    <span class="n">masked_aa_conc</span> <span class="o">=</span> <span class="n">aa_conc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="n">v_charging</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">kS</span>
        <span class="o">*</span> <span class="n">synthetase_conc</span>
        <span class="o">*</span> <span class="n">uncharged_trna_conc</span>
        <span class="o">*</span> <span class="n">masked_aa_conc</span>
        <span class="o">/</span> <span class="p">(</span><span class="n">KMaa</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">KMtf</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="o">/</span> <span class="p">(</span>
            <span class="mi">1</span>
            <span class="o">+</span> <span class="n">uncharged_trna_conc</span> <span class="o">/</span> <span class="n">KMtf</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">masked_aa_conc</span> <span class="o">/</span> <span class="n">KMaa</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">uncharged_trna_conc</span> <span class="o">*</span> <span class="n">masked_aa_conc</span> <span class="o">/</span> <span class="n">KMtf</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">KMaa</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">numerator_ribosome</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">f</span>
        <span class="o">*</span> <span class="p">(</span>
            <span class="n">krta</span> <span class="o">/</span> <span class="n">charged_trna_conc</span>
            <span class="o">+</span> <span class="n">uncharged_trna_conc</span> <span class="o">/</span> <span class="n">charged_trna_conc</span> <span class="o">*</span> <span class="n">krta</span> <span class="o">/</span> <span class="n">krtf</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">v_rib</span> <span class="o">=</span> <span class="n">max_elong_rate</span> <span class="o">*</span> <span class="n">ribosome_conc</span> <span class="o">/</span> <span class="n">numerator_ribosome</span>

    <span class="c1"># Handle case when f is 0 and charged_trna_conc is 0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">v_rib</span><span class="p">):</span>
        <span class="n">v_rib</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Limit v_rib and v_charging to the amount of available amino acids</span>
    <span class="k">if</span> <span class="n">limit_v_rib</span><span class="p">:</span>
        <span class="n">v_charging</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">v_charging</span><span class="p">,</span> <span class="n">aa_rate_limit</span><span class="p">)</span>
        <span class="n">v_rib</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v_rib</span><span class="p">,</span> <span class="n">v_rib_max</span><span class="p">)</span>

    <span class="n">dtrna</span> <span class="o">=</span> <span class="n">v_charging</span> <span class="o">-</span> <span class="n">v_rib</span> <span class="o">*</span> <span class="n">f</span>
    <span class="n">daa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_aas</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">v_charging</span><span class="p">,</span> <span class="n">dtrna</span><span class="p">,</span> <span class="n">daa</span></div>



<div class="viewcode-block" id="get_charging_supply_function">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.get_charging_supply_function">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_charging_supply_function</span><span class="p">(</span>
    <span class="n">supply_in_charging</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">mechanistic_supply</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">mechanistic_aa_transport</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">amino_acid_synthesis</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">amino_acid_import</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">amino_acid_export</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">aa_supply_scaling</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">counts_to_molar</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">aa_supply</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
    <span class="n">fwd_enzyme_counts</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span>
    <span class="n">rev_enzyme_counts</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span>
    <span class="n">dry_mass</span><span class="p">:</span> <span class="n">Unum</span><span class="p">,</span>
    <span class="n">importer_counts</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span>
    <span class="n">exporter_counts</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span>
    <span class="n">aa_in_media</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Unum</span><span class="p">,</span> <span class="n">Unum</span><span class="p">,</span> <span class="n">Unum</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a function mapping internal amino acid concentrations to the amount of</span>
<span class="sd">    amino acid supply expected.</span>

<span class="sd">    Args:</span>
<span class="sd">        supply_in_charging: True if using aa_supply_in_charging option</span>
<span class="sd">        mechanistic_supply: True if using mechanistic_translation_supply option</span>
<span class="sd">        mechanistic_aa_transport: True if using mechanistic_aa_transport option</span>
<span class="sd">        amino_acid_synthesis: function to provide rates of synthesis for amino</span>
<span class="sd">            acids based on the internal state</span>
<span class="sd">        amino_acid_import: function to provide import rates for amino</span>
<span class="sd">            acids based on the internal and external state</span>
<span class="sd">        amino_acid_export: function to provide export rates for amino</span>
<span class="sd">            acids based on the internal state</span>
<span class="sd">        aa_supply_scaling: function to scale the amino acid supply based</span>
<span class="sd">            on the internal state</span>
<span class="sd">        counts_to_molar: conversion factor for counts to molar</span>
<span class="sd">            (:py:data:`~ecoli.processes.polypeptide_elongation.MICROMOLAR_UNITS`)</span>
<span class="sd">        aa_supply: rate of amino acid supply expected</span>
<span class="sd">        fwd_enzyme_counts: enzyme counts in forward reactions for each amino acid</span>
<span class="sd">        rev_enzyme_counts: enzyme counts in loss reactions for each amino acid</span>
<span class="sd">        dry_mass: dry mass of the cell with mass units</span>
<span class="sd">        importer_counts: counts for amino acid importers</span>
<span class="sd">        exporter_counts: counts for amino acid exporters</span>
<span class="sd">        aa_in_media: True for each amino acid that is present in the media</span>
<span class="sd">    Returns:</span>
<span class="sd">        Function that provides the amount of supply (synthesis, import, export)</span>
<span class="sd">        for each amino acid based on the internal state of the cell</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create functions that are only dependent on amino acid concentrations for more stable</span>
    <span class="c1"># charging and amino acid concentrations.  If supply_in_charging is not set, then</span>
    <span class="c1"># setting None will maintain constant amino acid concentrations throughout charging.</span>
    <span class="n">supply_function</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">supply_in_charging</span><span class="p">:</span>
        <span class="n">counts_to_molar</span> <span class="o">=</span> <span class="n">counts_to_molar</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">MICROMOLAR_UNITS</span><span class="p">)</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">counts_to_molar</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">aa_supply</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mechanistic_supply</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mechanistic_aa_transport</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">supply_function</span><span class="p">(</span><span class="n">aa_conc</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="n">counts_to_molar</span>
                        <span class="o">*</span> <span class="n">amino_acid_synthesis</span><span class="p">(</span>
                            <span class="n">fwd_enzyme_counts</span><span class="p">,</span> <span class="n">rev_enzyme_counts</span><span class="p">,</span> <span class="n">aa_conc</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">counts_to_molar</span>
                        <span class="o">*</span> <span class="n">amino_acid_import</span><span class="p">(</span>
                            <span class="n">aa_in_media</span><span class="p">,</span>
                            <span class="n">dry_mass</span><span class="p">,</span>
                            <span class="n">aa_conc</span><span class="p">,</span>
                            <span class="n">importer_counts</span><span class="p">,</span>
                            <span class="n">mechanistic_aa_transport</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">counts_to_molar</span>
                        <span class="o">*</span> <span class="n">amino_acid_export</span><span class="p">(</span>
                            <span class="n">exporter_counts</span><span class="p">,</span> <span class="n">aa_conc</span><span class="p">,</span> <span class="n">mechanistic_aa_transport</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">supply_function</span><span class="p">(</span><span class="n">aa_conc</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="n">counts_to_molar</span>
                        <span class="o">*</span> <span class="n">amino_acid_synthesis</span><span class="p">(</span>
                            <span class="n">fwd_enzyme_counts</span><span class="p">,</span> <span class="n">rev_enzyme_counts</span><span class="p">,</span> <span class="n">aa_conc</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">counts_to_molar</span>
                        <span class="o">*</span> <span class="n">amino_acid_import</span><span class="p">(</span>
                            <span class="n">aa_in_media</span><span class="p">,</span>
                            <span class="n">dry_mass</span><span class="p">,</span>
                            <span class="n">aa_conc</span><span class="p">,</span>
                            <span class="n">importer_counts</span><span class="p">,</span>
                            <span class="n">mechanistic_aa_transport</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">zeros</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">supply_function</span><span class="p">(</span><span class="n">aa_conc</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">counts_to_molar</span>
                    <span class="o">*</span> <span class="n">aa_supply</span>
                    <span class="o">*</span> <span class="n">aa_supply_scaling</span><span class="p">(</span><span class="n">aa_conc</span><span class="p">,</span> <span class="n">aa_in_media</span><span class="p">),</span>
                    <span class="n">zeros</span><span class="p">,</span>
                    <span class="n">zeros</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">supply_function</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">test_polypeptide_elongation</span><span class="p">(</span><span class="n">return_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_elongation_rates</span><span class="p">(</span><span class="n">random</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">variable_elongation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">time_step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">stochasticRound</span><span class="p">(</span><span class="n">random</span><span class="p">,</span> <span class="n">lengths</span><span class="p">)</span> <span class="k">if</span> <span class="n">random</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lengths</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="n">test_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;time_step&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;proteinIds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;TRYPSYN-APROTEIN[c]&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;ribosome30S&quot;</span><span class="p">:</span> <span class="s2">&quot;CPLX0-3953[c]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ribosome50S&quot;</span><span class="p">:</span> <span class="s2">&quot;CPLX0-3962[c]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;make_elongation_rates&quot;</span><span class="p">:</span> <span class="n">make_elongation_rates</span><span class="p">,</span>
        <span class="s2">&quot;proteinLengths&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">245</span><span class="p">]</span>
        <span class="p">),</span>  <span class="c1"># this is the length of proteins in proteinSequences</span>
        <span class="s2">&quot;translation_aa_supply&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;minimal&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">mol</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">fg</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="mf">6.73304301e-21</span><span class="p">,</span>
                    <span class="mf">3.63835219e-21</span><span class="p">,</span>
                    <span class="mf">2.89772671e-21</span><span class="p">,</span>
                    <span class="mf">3.88086822e-21</span><span class="p">,</span>
                    <span class="mf">5.04645651e-22</span><span class="p">,</span>
                    <span class="mf">4.45295877e-21</span><span class="p">,</span>
                    <span class="mf">2.64600664e-21</span><span class="p">,</span>
                    <span class="mf">5.35711230e-21</span><span class="p">,</span>
                    <span class="mf">1.26817689e-21</span><span class="p">,</span>
                    <span class="mf">3.81168405e-21</span><span class="p">,</span>
                    <span class="mf">5.66834531e-21</span><span class="p">,</span>
                    <span class="mf">4.30576056e-21</span><span class="p">,</span>
                    <span class="mf">1.70428208e-21</span><span class="p">,</span>
                    <span class="mf">2.24878356e-21</span><span class="p">,</span>
                    <span class="mf">2.49335033e-21</span><span class="p">,</span>
                    <span class="mf">3.47019761e-21</span><span class="p">,</span>
                    <span class="mf">3.83858460e-21</span><span class="p">,</span>
                    <span class="mf">6.34564026e-22</span><span class="p">,</span>
                    <span class="mf">1.86880523e-21</span><span class="p">,</span>
                    <span class="mf">1.40959498e-27</span><span class="p">,</span>
                    <span class="mf">5.20884460e-21</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">},</span>
        <span class="s2">&quot;proteinSequences&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="mi">12</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">18</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">18</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">4</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">18</span><span class="p">,</span>
                    <span class="mi">4</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">,</span>
                    <span class="mi">12</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">4</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">18</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">18</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">,</span>
                    <span class="mi">6</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">18</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="mi">12</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">6</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">17</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">6</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">18</span><span class="p">,</span>
                    <span class="mi">17</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">17</span><span class="p">,</span>
                    <span class="mi">12</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">13</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">4</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">16</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">12</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">14</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">6</span><span class="p">,</span>
                    <span class="mi">18</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="mi">6</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">8</span><span class="p">,</span>
                    <span class="mi">4</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">15</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">12</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">6</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">11</span><span class="p">,</span>
                    <span class="mi">20</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">polypep_elong</span> <span class="o">=</span> <span class="n">PolypeptideElongation</span><span class="p">(</span><span class="n">test_config</span><span class="p">)</span>

    <span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;environment&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;media_id&quot;</span><span class="p">:</span> <span class="s2">&quot;minimal&quot;</span><span class="p">},</span>
        <span class="s2">&quot;bulk&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;CPLX0-3953[c]&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;CPLX0-3962[c]&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;TRYPSYN-APROTEIN[c]&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;RELA&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;SPOT&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;H2O&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;PROTON&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;ppGpp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="o">+</span> <span class="p">[(</span><span class="n">aa</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">DEFAULT_AA_NAMES</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;U40&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
        <span class="p">),</span>
        <span class="s2">&quot;unique&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;active_ribosome&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;_entryState&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;unique_index&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;protein_index&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;peptide_length&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;pos_on_mRNA&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;massDiff_DNA&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;massDiff_mRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;massDiff_metabolite&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;massDiff_miscRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;massDiff_nonspecific_RNA&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;massDiff_protein&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;massDiff_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;massDiff_tRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;massDiff_water&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;f8&quot;</span><span class="p">),</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="p">},</span>
        <span class="s2">&quot;listeners&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dry_mass&quot;</span><span class="p">:</span> <span class="mf">350.0</span><span class="p">}},</span>
    <span class="p">}</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;total_time&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;initial_state&quot;</span><span class="p">:</span> <span class="n">initial_state</span><span class="p">,</span> <span class="s2">&quot;topology&quot;</span><span class="p">:</span> <span class="n">TOPOLOGY</span><span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">simulate_process</span><span class="p">(</span><span class="n">polypep_elong</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">test_config</span>


<div class="viewcode-block" id="run_plot">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.run_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="c1"># plot a list of variables</span>
    <span class="n">bulk_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;CPLX0-3953[c]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CPLX0-3962[c]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;TRYPSYN-APROTEIN[c]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RELA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SPOT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;H2O&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PROTON&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ppGpp&quot;</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">aa</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">DEFAULT_AA_NAMES</span><span class="p">]</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[(</span><span class="n">bulk_id</span><span class="p">,)</span> <span class="k">for</span> <span class="n">bulk_id</span> <span class="ow">in</span> <span class="n">bulk_ids</span><span class="p">]</span>

    <span class="c1"># format data</span>
    <span class="n">bulk_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bulk_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bulk_ids</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">bulk_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">bulk_timeseries</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

    <span class="n">plot_variables</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="o">=</span><span class="s2">&quot;out/processes/polypeptide_elongation&quot;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;variables&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../reference/api/ecoli/ecoli.processes.polypeptide_elongation.html#ecoli.processes.polypeptide_elongation.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="n">test_polypeptide_elongation</span><span class="p">(</span><span class="n">return_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">run_plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2025, The Vivarium E. coli Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>