

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wholecell.utils.voronoi_plot_main &mdash; Vivarium E. coli 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Vivarium E. coli
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../stores.html">Stores</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../composites.html">Composites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../experiments.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hpc.html">HPC Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gcloud.html">Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ci.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pycharm.html">PyCharm Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/api_ref.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Vivarium E. coli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wholecell.utils.voronoi_plot_main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wholecell.utils.voronoi_plot_main</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Plot voronoi diagram</span>

<span class="sd">Algorithm Reference: A. Nocaj and U. Brandes, &quot;Computing voronoi Treemaps:</span>
<span class="sd">Faster, Simpler, and Resolution-independent, Computer Graphics Forum,</span>
<span class="sd">vol. 31, no. 31, pp. 855-864, 2012. Available: 10.1111/j.1467-8659.2012.03078.x.</span>

<span class="sd">This program generate a voronoi diagram, in which the canvas of a plot is</span>
<span class="sd">divided in to n polygons. Each data point (or &quot;Points&quot; in this program)</span>
<span class="sd">corresponds to one polygon, and the centroid of each polygon is called a &quot;site&quot;.</span>
<span class="sd">The area of each polygon is proportional to the value each point wants to</span>
<span class="sd">represent. For example, it can be the mass compositions of a cell, the relative</span>
<span class="sd">abundance of  different proteins, or the energy cost of different cellular</span>
<span class="sd">processes.</span>

<span class="sd">Dividing a canvas (in this program we use np.array([[0,0],[4,0],[4,4],[0,4]]))</span>
<span class="sd">into multiple polygons is a complicated computational geometry problem. The main</span>
<span class="sd">working horse of this task is the function &quot;_voronoi_treemap&quot;.</span>
<span class="sd">In &quot;_voronoi_treemap&quot;, we did the following things:</span>
<span class="sd">(1) initialize random sites within the canvas (using &quot;random_points_in_canvas&quot;)</span>
<span class="sd">and assign an initial weight to each site. The initial weights of each site are</span>
<span class="sd">set equal so that it will be easier to compute a draft.</span>
<span class="sd">(2) compute the draft of our voronoi diagram, which is called &quot;Power Diagram&quot;</span>
<span class="sd">following the notation of our algorithm reference.</span>
<span class="sd">(using &quot;_compute_power_diagram&quot;)</span>
<span class="sd">(3) adjust the positions of each site and the weights of each site until the</span>
<span class="sd">program reaches the maximum iterations (i_max = 75) or until error &lt; err_thres.</span>
<span class="sd">(4) return the final error of the whole voronoi diagram.</span>

<span class="sd">In voronoi diagram, certain amount of error in area representation is expected.</span>
<span class="sd">According to the analysis in our algorithm reference, an error between 5~23% is</span>
<span class="sd">expected. However, an error up to 20% can severely distort the diagram. We</span>
<span class="sd">therefore set a stricter limit (15%) on our error in the function</span>
<span class="sd">&quot;_voronoi_main_function&quot;. If the newly computed voronoi diagram has a lower</span>
<span class="sd">error compared to the previous one, it will continuously increase the number of</span>
<span class="sd">iterations until the error falls below 15%. However, if the error of a newly</span>
<span class="sd">computed diagram is greater than the previous one, the program will plot the</span>
<span class="sd">diagram all over again. Generally, a final error &lt;=10% will give you a nice</span>
<span class="sd">representation.</span>

<span class="sd">Using this algorithm, the program is capable of dividing 32 polygons in 10</span>
<span class="sd">seconds, and the program scales with O(n*log(n)). As a result, it would be</span>
<span class="sd">preferable to introduce layered structure if the number of polygons are more</span>
<span class="sd">than 50.</span>

<span class="sd">If you want to implement the functions that are created here and make a new</span>
<span class="sd">voronoi plot with your own data, please read the following instructions:</span>
<span class="sd">(1)Place this in the heading, or other ways that can import every function in</span>
<span class="sd">this file.</span>
<span class="sd">from wholecell.utils.voronoiPlotMain import VoronoiMaster</span>

<span class="sd">(2)Copy the following code and modify it appropriately:</span>
<span class="sd">vm = VoronoiMaster()</span>
<span class="sd">vm.plot(&quot;YOUR DICTIONARY&quot;, title = &quot;YOUR TITLE&quot;)</span>
<span class="sd">exportFigure(plt, plotOutDir, plotOutFileName, metadata)</span>
<span class="sd">plt.close(&quot;all&quot;)</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">distance_matrix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConvexHull</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">PatchCollection</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>


<span class="n">COLORS_256</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">55</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">184</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">152</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">163</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">77</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">74</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">51</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">166</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">247</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">191</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">228</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">28</span><span class="p">],</span>
<span class="p">]</span>  <span class="c1"># From colorbrewer2.org, qualitative 8-class set 1</span>
<span class="n">COLORS</span> <span class="o">=</span> <span class="p">[[</span><span class="n">colorValue</span> <span class="o">/</span> <span class="mf">255.0</span> <span class="k">for</span> <span class="n">colorValue</span> <span class="ow">in</span> <span class="n">color</span><span class="p">]</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">COLORS_256</span><span class="p">]</span>


<div class="viewcode-block" id="angle">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.angle">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">angle</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dot_product</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">((</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>

    <span class="n">cosine</span> <span class="o">=</span> <span class="n">dot_product</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cosine</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cosine</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">100</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">cosine</span><span class="p">)</span></div>



<div class="viewcode-block" id="is_on_segment">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.is_on_segment">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_on_segment</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">edge</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine whether a point is on a segment by checking if Ax+By-C == 0</span>
<span class="sd">    and falls between the two corners which define the edge.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">edge</span>
    <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
    <span class="c1"># convert to ax + by = c</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">x1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">y1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="n">c</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">test</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="PolygonClass">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.PolygonClass">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PolygonClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A polygon object stores the coordinates of the corners, the edges, and</span>
<span class="sd">        the area of the polygon.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_reorder_points</span><span class="p">(</span><span class="n">corners</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This function reorders the corners of a polygon in a</span>
<span class="sd">            counterclockwise manner. The input should be a numpy array of nx2.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">ordered_points</span> <span class="o">=</span> <span class="n">corners</span>
            <span class="n">com</span> <span class="o">=</span> <span class="n">ordered_points</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># find center of mass</span>
            <span class="n">ordered_points</span> <span class="o">=</span> <span class="n">ordered_points</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ordered_points</span> <span class="o">-</span> <span class="n">com</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">ordered_points</span> <span class="o">-</span> <span class="n">com</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">ordered_points</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">_reorder_points</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_corners</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_corners</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_area</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>

<div class="viewcode-block" id="PolygonClass._polygon_area">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.PolygonClass._polygon_area">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_polygon_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corners</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate polygon area using shoelace formula.</span>
<span class="sd">        Please make sure that the corners are reordered before calling</span>
<span class="sd">        _polygon_area function!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">corners</span><span class="p">)</span>
        <span class="n">area</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
            <span class="n">area</span> <span class="o">+=</span> <span class="n">corners</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">corners</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">area</span> <span class="o">-=</span> <span class="n">corners</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">corners</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">area</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">return</span> <span class="n">area</span></div>


<div class="viewcode-block" id="PolygonClass.random_points_in_canvas">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.PolygonClass.random_points_in_canvas">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">random_points_in_canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_points</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function assigns n random points within the canvas. The algorithm</span>
<span class="sd">        is as followed:</span>
<span class="sd">        (1) divide the canvas into multiple triangels</span>
<span class="sd">        (2) weight each triangle according to the area</span>
<span class="sd">        (3) randomly placed points within the triangles</span>
<span class="sd">        Please make sure that the points have been reordered properly!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vec_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">n_triangle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_corners</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">area_triangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_triangle</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_triangle</span><span class="p">):</span>
            <span class="n">area_triangle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_polygon_area</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vec_all</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vec_all</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="p">)</span>
        <span class="n">rand_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">area_triangle</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">area_triangle</span><span class="p">)</span>
        <span class="n">rand_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n_points</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">])])</span>

        <span class="n">sites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_points</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_triangle</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand_num</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">rand_scale</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">rand_num</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vec1_tile_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">vec_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">vec2_tile_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">vec_all</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">rand_num_masked</span> <span class="o">=</span> <span class="n">rand_num</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">rand_len_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rand_num</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">sites</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">rand_num_masked</span> <span class="o">*</span> <span class="n">vec1_tile_xy</span> <span class="o">*</span> <span class="n">rand_len_masked</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rand_num_masked</span><span class="p">)</span> <span class="o">*</span> <span class="n">vec2_tile_xy</span> <span class="o">*</span> <span class="n">rand_len_masked</span>
            <span class="p">)</span>
            <span class="n">rand_num</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">sites</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="n">n_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">sites</span></div>


<div class="viewcode-block" id="PolygonClass.point_is_within_canvas">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.PolygonClass.point_is_within_canvas">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">point_is_within_canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a point is within canvas by computing the sum of the angle</span>
<span class="sd">        formed by adjacent corners and the point. If a point is within canvas,</span>
<span class="sd">        the sum of the angle should be 2*pi.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_point_is_on_corner_of_canvas</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Check if a point is one of the corner of the canvas.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">==</span> <span class="n">p</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">_point_is_on_corner_of_canvas</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sum_angle</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">edge_canvas</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">edge_canvas</span> <span class="o">-</span> <span class="n">p</span>
                <span class="n">sum_angle</span> <span class="o">+=</span> <span class="n">angle</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sum_angle</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sum_angle</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="PolygonClass.find_min_dist_to_border">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.PolygonClass.find_min_dist_to_border">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_min_dist_to_border</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find the minimum distance of the site to the borders of its polygon.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_find_min_dist_to_edge</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">edge</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            find the minimum distance of the site to one specific edge of a</span>
<span class="sd">            polygon.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">[[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">edge</span>
            <span class="p">[</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">]</span> <span class="o">=</span> <span class="n">site</span>
            <span class="c1"># convert to ax + by + c = 0</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
            <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span>
            <span class="n">dist_perp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">ys</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">xp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">ys</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">ys</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_on_segment</span><span class="p">([</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">],</span> <span class="n">edge</span><span class="p">):</span>
                <span class="n">min_dist</span> <span class="o">=</span> <span class="n">dist_perp</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">min_dist</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">xs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">xs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">ys</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">min_dist</span>

        <span class="n">min_dist_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">min_dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_find_min_dist_to_edge</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span>
        <span class="n">distance_border</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_dist_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">distance_border</span></div>
</div>



<div class="viewcode-block" id="VoronoiClass">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiClass">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VoronoiClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polygons</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A voronoi object stores all the polygons of a voronoi diagram, the</span>
<span class="sd">        coordinates/weights/values of each site, and the canvas of the whole</span>
<span class="sd">        plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span> <span class="o">=</span> <span class="n">polygons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="n">sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span> <span class="o">=</span> <span class="n">canvas_obj</span>

<div class="viewcode-block" id="VoronoiClass.find_sites_causing_displacement">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiClass.find_sites_causing_displacement">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_sites_causing_displacement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a site need to expand its area greatly in the next round, the other</span>
<span class="sd">        sites surrounding it should be displaced a little bit in order to</span>
<span class="sd">        facilitate the process of optimizing the voronoi diagram. This is part</span>
<span class="sd">        of the speed-up heuristic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sites_area_ratio</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_me</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>  <span class="c1"># rescue the sites</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">random_points_in_canvas</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">area_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
                <span class="n">area_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sites_area_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">area_target</span> <span class="o">/</span> <span class="n">area_current</span>
                <span class="k">if</span> <span class="n">area_current</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">move_me</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_causing_disp</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites_area_ratio</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_me</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site_causing_disp</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_causing_disp</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="VoronoiClass.adapt_positions_weights">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiClass.adapt_positions_weights">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">adapt_positions_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adapt the positions and weights of each site within an existing voronoi</span>
<span class="sd">        diagram. This algorithm also considers the point with largest</span>
<span class="sd">        Area_{target}/Area_{current} ratio and displace its neighbor in order to</span>
<span class="sd">        speed up the optimization process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1. move the location of each site to the centroid of each polygon.</span>
        <span class="c1"># If there is no closed polygon for that site, randomly reassign a</span>
        <span class="c1"># location for that site in order to rescue it.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>  <span class="c1"># rescue the sites</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">random_points_in_canvas</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># adapt the position to the centroid</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 2. speed up heuristic: if a site is expected to expand its area</span>
        <span class="c1"># greatly, its neighbor should be displaced in advance in order to speed</span>
        <span class="c1"># up the optimization process.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_me</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>  <span class="c1"># speed-up heuristic#</span>
                    <span class="n">dist_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site_causing_disp</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">dist_abs</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dist_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dist_abs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ds_abs</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span>
                            <span class="mi">5</span> <span class="o">*</span> <span class="n">dist_abs</span>
                        <span class="p">)</span>
                        <span class="n">site_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">dist_vec</span> <span class="o">*</span> <span class="n">ds_abs</span> <span class="o">/</span> <span class="n">dist_abs</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">point_is_within_canvas</span><span class="p">(</span><span class="n">site_new</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">site_new</span>

                <span class="c1"># 3. if the square root of weights exceed the minimum distance from the</span>
                <span class="c1"># site to the current border of the polygon, the weight should be</span>
                <span class="c1"># decreased.</span>
                <span class="n">distance_border</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">find_min_dist_to_border</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">([</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">distance_border</span><span class="p">])</span>
                <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="VoronoiClass.adapt_weights">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiClass.adapt_weights">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">adapt_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adapt the weight of each site. increase the weight if current area is</span>
<span class="sd">        different from the targeted area of each site. However, if the weight is</span>
<span class="sd">        too big such that the site is encroaching its neighbor, the weight</span>
<span class="sd">        should be decreased.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_nearest_neighbor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            find the nearest neighbor of each site and return the DISTANCE</span>
<span class="sd">            (rather than the index) between each site and its nearest neighbor</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">nn_dist_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span>
                <span class="n">distance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span><span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">nn_dist_cal</span>

        <span class="n">nn_dist</span> <span class="o">=</span> <span class="n">_nearest_neighbor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># minimum weight of each site</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>  <span class="c1"># rescue the sites</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">random_points_in_canvas</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">area_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
                <span class="n">area_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">f_adapt</span> <span class="o">=</span> <span class="n">area_target</span> <span class="o">/</span> <span class="n">area_current</span>
                <span class="n">sqrt_w_new</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">f_adapt</span>
                <span class="n">sqrt_w_max</span> <span class="o">=</span> <span class="n">nn_dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">([</span><span class="n">sqrt_w_new</span><span class="p">,</span> <span class="n">sqrt_w_max</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">epsilon</span><span class="p">])</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="VoronoiClass.compute_error">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiClass.compute_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the error of the voronoi plot. The error is defined as</span>
<span class="sd">        sum(abs(Area_current - Area_target))/(2*Area_canvas)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>  <span class="c1"># rescue the sites if the polygon is empty</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">random_points_in_canvas</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sites</span>
                <span class="n">error</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_value</span>
                <span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">error</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error</span></div>
</div>



<div class="viewcode-block" id="LineClass">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.LineClass">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LineClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A line object store the information of a line in this format of</span>
<span class="sd">        &quot;dx + ey = f&quot;, using formula:</span>
<span class="sd">        2(x1-x2)x + 2(y1-y2)y = (x1^2+y1^2-w1) - (x2^2+y2^2-w2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">[[</span><span class="n">x1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x_col</span>
        <span class="p">[[</span><span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">y2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">y_col</span>
        <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">w1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">w2</span><span class="p">)</span>

<div class="viewcode-block" id="LineClass.find_intersect_with_canvas">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.LineClass.find_intersect_with_canvas">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_intersect_with_canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function finds the intersection points of a bisector with a canvas.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_line_intersect_with_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_canvas</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            This function finds the intersection points of a line with an edge.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># [P1, P2] = edge_canvas</span>
            <span class="p">[[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">edge_canvas</span>
            <span class="c1"># convert to ax + by = c, dx + ey = f</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
            <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
            <span class="n">det</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
            <span class="n">det_x</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">b</span>
            <span class="n">det_y</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>

            <span class="c1"># if their slopes are the same but they don&#39;t intersect,</span>
            <span class="c1"># they are parallel</span>
            <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">det_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">det_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">intersect_point</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">intersect_point</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_int</span> <span class="o">=</span> <span class="n">det_x</span> <span class="o">/</span> <span class="n">det</span>
                <span class="n">y_int</span> <span class="o">=</span> <span class="n">det_y</span> <span class="o">/</span> <span class="n">det</span>
                <span class="k">if</span> <span class="n">is_on_segment</span><span class="p">([</span><span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">],</span> <span class="n">edge_canvas</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">intersect_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">intersect_point</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">intersect_point</span>

        <span class="n">intersect_TF_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge_canvas</span> <span class="ow">in</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">intersect_point</span> <span class="o">=</span> <span class="n">_line_intersect_with_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_canvas</span><span class="p">)</span>
            <span class="n">intersect_TF_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_point</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">intersect_point</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">intersect_coordinates</span><span class="p">,</span> <span class="n">intersect_point</span><span class="p">]</span>
                        <span class="p">)</span>

        <span class="n">edge</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">intersect_coordinates</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="p">(</span><span class="n">intersect_coordinates</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span>
            <span class="p">)</span>
            <span class="n">unique_intersect_coordinate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_intersect_coordinate</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="n">unique_intersect_coordinate</span>

        <span class="k">return</span> <span class="n">edge</span></div>
</div>



<div class="viewcode-block" id="RayClass">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.RayClass">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RayClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">tangent</span><span class="p">,</span> <span class="n">main_sites</span><span class="p">,</span> <span class="n">adjunct_site</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A ray object stores the origin and the tangent vector of a ray, and</span>
<span class="sd">        the site it represents. It is store in this format:</span>
<span class="sd">        ~ origin + a*tangent, a&gt;=0</span>
<span class="sd">        ~ a_r*x + b_r*y + c_r = 0</span>
<span class="sd">        ~ t_y*x - t_x*y + (t_x*y_int - t_y*x_int) = 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tangent</span> <span class="o">=</span> <span class="n">tangent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_r</span> <span class="o">=</span> <span class="n">tangent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_r</span> <span class="o">=</span> <span class="o">-</span><span class="n">tangent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_r</span> <span class="o">=</span> <span class="n">tangent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tangent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_sites</span> <span class="o">=</span> <span class="n">main_sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjunct_site</span> <span class="o">=</span> <span class="n">adjunct_site</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_ip</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span>

<div class="viewcode-block" id="RayClass.is_on_ray">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.RayClass.is_on_ray">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_on_ray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether a point is on a ray by checking if Ax+By-C == 0 and</span>
<span class="sd">        its relative position with respect to the origin is on the same</span>
<span class="sd">        direction as the tangent vector of the ray.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tangent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tangent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_r</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_r</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_r</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">test</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t_x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">int</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">t_x</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">int</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">t_y</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="RayClass.ray_intersect_with_edge">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.RayClass.ray_intersect_with_edge">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ray_intersect_with_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_canvas</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function determines if a ray is intersected with an edge.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_canvas</span>
        <span class="p">[[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">edge_canvas</span>
        <span class="c1"># convert to ax + by = c, dx+ey = f</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
        <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_r</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_r</span>
        <span class="n">det_x</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_r</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">c_r</span><span class="p">)</span>
        <span class="n">det_y</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">c_r</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_r</span>
        <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">det_x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">det_y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">intersect_point</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># (det == 0) and (det_x == 0) and (det_y == 0)</span>
                <span class="n">p1_is_on_ray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_on_ray</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
                <span class="n">p2_is_on_ray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_on_ray</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p1_is_on_ray</span> <span class="ow">and</span> <span class="n">p2_is_on_ray</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">intersect_point</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">p1_is_on_ray</span> <span class="o">!=</span> <span class="n">p2_is_on_ray</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span>
                        <span class="n">p2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
                    <span class="p">):</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">intersect_point</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span>
                            <span class="n">p1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
                        <span class="p">)</span> <span class="o">+</span> <span class="n">p2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">intersect_point</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">intersect_point</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_int</span> <span class="o">=</span> <span class="n">det_x</span> <span class="o">/</span> <span class="n">det</span>
            <span class="n">y_int</span> <span class="o">=</span> <span class="n">det_y</span> <span class="o">/</span> <span class="n">det</span>
            <span class="k">if</span> <span class="n">is_on_segment</span><span class="p">([</span><span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">],</span> <span class="n">edge_canvas</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_on_ray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">intersect_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">intersect_point</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">intersect_point</span></div>


<div class="viewcode-block" id="RayClass.keep_nearest_point_on_ray">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.RayClass.keep_nearest_point_on_ray">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">keep_nearest_point_on_ray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intersect_coordinates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a ray is intersect with multiple ipoints,</span>
<span class="sd">        only keep the one that is closest to the origin of the ray.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_candidates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span>
        <span class="c1"># find candidates with shortest distance from the origin</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">intersect_coordinates</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="p">(</span><span class="n">n_candidates</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
        <span class="c1"># avoid the intersection point that is the origin itself</span>
        <span class="n">dist</span><span class="p">[</span><span class="n">dist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">intersect_coordinates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist</span><span class="p">),</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">intersect_coordinates</span></div>


<div class="viewcode-block" id="RayClass.find_ray_intersect_with_canvas">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.RayClass.find_ray_intersect_with_canvas">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_ray_intersect_with_canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function finc the point where a ray object is intersected with</span>
<span class="sd">        canvas by checking the intersection with every edge of the canvas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">intersect_TF_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge_canvas</span> <span class="ow">in</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">intersect_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray_intersect_with_edge</span><span class="p">(</span><span class="n">edge_canvas</span><span class="p">)</span>
            <span class="n">intersect_TF_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_point</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">intersect_point</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">intersect_coordinates</span><span class="p">,</span> <span class="n">intersect_point</span><span class="p">]</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">intersect_coordinates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">])</span>

        <span class="n">edge</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">intersect_coordinates</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="p">(</span><span class="n">intersect_coordinates</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span>
            <span class="p">)</span>
            <span class="n">unique_intersect_coordinate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_intersect_coordinate</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="n">unique_intersect_coordinate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="n">edge</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="RayClass.find_ray_intersect_with_canvas_and_ipoints">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.RayClass.find_ray_intersect_with_canvas_and_ipoints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_ray_intersect_with_canvas_and_ipoints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">ipoints</span><span class="p">,</span> <span class="n">simplices_prune</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function finds the terminal of each ray object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 0. get the label of each ray object</span>
        <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">simplex</span> <span class="o">=</span> <span class="n">simplices_prune</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index_ip</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">simplices_prune</span> <span class="o">==</span> <span class="n">simplex</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">simplices_prune</span> <span class="o">==</span> <span class="n">simplex</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">simplices_prune</span> <span class="o">==</span> <span class="n">simplex</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 1. check if the ray is intersected with any nearby ipoints</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
            <span class="n">ipoint</span> <span class="o">=</span> <span class="n">ipoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_on_ray</span><span class="p">(</span><span class="n">ipoint</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">ipoint</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">intersect_coordinates</span><span class="p">,</span> <span class="n">ipoint</span><span class="p">])</span>

        <span class="c1"># 2. if the ray is not intersected with any ipoints, find its</span>
        <span class="c1"># intersection with canvas</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">intersect_TF_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">edge_canvas</span> <span class="ow">in</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">intersect_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray_intersect_with_edge</span><span class="p">(</span><span class="n">edge_canvas</span><span class="p">)</span>
                <span class="n">intersect_TF_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_point</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">intersect_point</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">intersect_coordinates</span><span class="p">,</span> <span class="n">intersect_point</span><span class="p">]</span>
                            <span class="p">)</span>

        <span class="c1"># 3. only keep the nearest point to the origin of that ray</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">intersect_coordinates</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_nearest_point_on_ray</span><span class="p">(</span>
                <span class="n">intersect_coordinates</span>
            <span class="p">)</span>

        <span class="c1"># 4. append origin and create an edge</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">intersect_coordinates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">])</span>

        <span class="c1"># 5. round and leave only the unique point</span>
        <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="n">intersect_coordinates</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">intersect_coordinates</span> <span class="o">=</span> <span class="p">(</span><span class="n">intersect_coordinates</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span>
            <span class="p">)</span>
            <span class="n">unique_intersect_coordinate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">intersect_coordinates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_intersect_coordinate</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="n">unique_intersect_coordinate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="n">edge</span>
        <span class="k">return</span></div>
</div>



<div class="viewcode-block" id="VoronoiMaster">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">VoronoiMaster</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_max</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">err_thres</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_max</span> <span class="o">=</span> <span class="n">i_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err_thres</span> <span class="o">=</span> <span class="n">err_thres</span>

<div class="viewcode-block" id="VoronoiMaster.plot">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dic</span><span class="p">,</span>
        <span class="n">side_length</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="n">custom_shape_vertices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ax_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">chained</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Master function of generating layered or non-layered voronoi plot from a</span>
<span class="sd">        dictionary.</span>
<span class="sd">        gross_error = \\sum_{i} |Area(i) - Expected Area(i)|</span>
<span class="sd">        error_all = \\sum_{i} |Area(i) - Expected Area(i)|/(2 * total area)</span>
<span class="sd">        The factor 2 in the error formula is to correct the repeated calculation</span>
<span class="sd">        in area error.</span>
<span class="sd">        Args:</span>
<span class="sd">            dic: Layered dictionary which contains the labels and the values you</span>
<span class="sd">                intend to represent in a voronoi diagram. This can be a single</span>
<span class="sd">                dictionary or multiple dictionaries in a nested list. The shape</span>
<span class="sd">                of the list should be the same as the layout of the subplots.</span>
<span class="sd">            side_length: The side length of whole voronoi diagram. The whole</span>
<span class="sd">                diagram is defaulted to be rectangular.</span>
<span class="sd">            custom_shape_vertices: If you want a custom shaped voronoi diagram,</span>
<span class="sd">                enter the vertices of the voronoi diagram in a nested np array</span>
<span class="sd">                like this: np.array([[0, 0], [4, 0], [4, 1], [1.5, 3], [0, 2]])</span>
<span class="sd">                The shape of the whole voronoi diagram will then become a</span>
<span class="sd">                pentagon with vertices [0, 0], [4, 0], [4, 1], [1.5, 3], [0, 2].</span>
<span class="sd">            font_size: The font size of the labeling on the voronoi diagram.</span>
<span class="sd">            title: The title of the plot. This can be a single title or a nested</span>
<span class="sd">                list of titles.</span>
<span class="sd">            ax_shape: the shape of the subplot, in (nrows, ncols)</span>
<span class="sd">            chained: whether the new subplot should be based on the previous</span>
<span class="sd">                subplot or not.</span>
<span class="sd">            verbose: If true, print the magnitude of the error in the areas</span>
<span class="sd">                represented by the plot</span>

<span class="sd">        Returns:</span>
<span class="sd">            The error in total area representation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">voronoi_list_old</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ax_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_all</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">ax_shape</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span>
                <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">ncols</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ax_shape</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                    <span class="n">dic_current</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">chained</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="p">(</span>
                            <span class="n">voronoi_list_new</span><span class="p">,</span>
                            <span class="n">polygon_value_list_new</span><span class="p">,</span>
                            <span class="n">label_site_list_new</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_boundaries</span><span class="p">(</span>
                            <span class="n">dic_current</span><span class="p">,</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">custom_shape_vertices</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="p">(</span>
                            <span class="n">voronoi_list_new</span><span class="p">,</span>
                            <span class="n">polygon_value_list_new</span><span class="p">,</span>
                            <span class="n">label_site_list_new</span><span class="p">,</span>
                        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_boundaries</span><span class="p">(</span>
                            <span class="n">dic_current</span><span class="p">,</span>
                            <span class="n">side_length</span><span class="p">,</span>
                            <span class="n">custom_shape_vertices</span><span class="p">,</span>
                            <span class="n">voronoi_list_old</span><span class="o">=</span><span class="n">voronoi_list_old</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_generate_plot</span><span class="p">(</span><span class="n">voronoi_list_new</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">voronoi_list_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">total_area</span> <span class="o">=</span> <span class="n">voronoi_list_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_labels</span><span class="p">(</span><span class="n">label_site_list_new</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">gross_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_error</span><span class="p">(</span>
                        <span class="n">polygon_value_list_new</span><span class="p">,</span> <span class="n">total_value</span><span class="p">,</span> <span class="n">total_area</span>
                    <span class="p">)</span>
                    <span class="n">error_new</span> <span class="o">=</span> <span class="n">gross_error</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">voronoi_list_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;The error in the area representation of the whole &quot;</span>
                            <span class="s2">&quot;voronoi diagram (</span><span class="si">%i</span><span class="s2">, </span><span class="si">%i</span><span class="s2">): </span><span class="si">%.4f</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span>
                                <span class="n">i</span><span class="p">,</span>
                                <span class="n">j</span><span class="p">,</span>
                                <span class="n">error_new</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="n">error_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_new</span><span class="p">)</span>
                    <span class="n">voronoi_list_old</span> <span class="o">=</span> <span class="n">voronoi_list_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">voronoi_list</span><span class="p">,</span> <span class="n">polygon_value_list</span><span class="p">,</span> <span class="n">label_site_list</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_boundaries</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">custom_shape_vertices</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">side_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">side_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_plot</span><span class="p">(</span><span class="n">voronoi_list</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>

            <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">voronoi_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">total_area</span> <span class="o">=</span> <span class="n">voronoi_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_labels</span><span class="p">(</span><span class="n">label_site_list</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
            <span class="n">gross_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_error</span><span class="p">(</span>
                <span class="n">polygon_value_list</span><span class="p">,</span> <span class="n">total_value</span><span class="p">,</span> <span class="n">total_area</span>
            <span class="p">)</span>
            <span class="n">error_all</span> <span class="o">=</span> <span class="n">gross_error</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">voronoi_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;The error in the area representation of the whole&quot;</span>
                    <span class="s2">&quot;voronoi diagram: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">error_all</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">error_all</span></div>


<div class="viewcode-block" id="VoronoiMaster._generate_plot">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._generate_plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">voronoi_list</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the layered voronoi diagram.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">voronoi</span> <span class="ow">in</span> <span class="n">voronoi_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">voronoi</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">ax</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_plot</span><span class="p">(</span><span class="n">voronoi</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">counter</span><span class="o">=</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">canvas_obj</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span>

                <span class="c1"># plot canvas</span>
                <span class="k">for</span> <span class="n">edge_canvas</span> <span class="ow">in</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">edge_canvas</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">edge_canvas</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                        <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                        <span class="n">solid_capstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span>
                        <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># plot polygons</span>
                <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">colors_all</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">polygons</span><span class="p">:</span>
                    <span class="n">polygon_plot_obj</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">polygon</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">polygon</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">solid_capstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span>
                        <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polygon_plot_obj</span><span class="p">)</span>
                    <span class="n">colors</span> <span class="o">=</span> <span class="n">COLORS</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
                    <span class="n">colors_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">PatchCollection</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">colors_all</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">counter</span></div>


<div class="viewcode-block" id="VoronoiMaster._add_labels">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._add_labels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_site_list</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the label of the Voronoi plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">label_site_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_labels</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">font_size</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="VoronoiMaster._compute_error">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._compute_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polygon_value_list</span><span class="p">,</span> <span class="n">total_value</span><span class="p">,</span> <span class="n">total_area</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute the gross error of the Voronoi plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gross_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">polygon_value_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">gross_error</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_error</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">total_value</span><span class="p">,</span> <span class="n">total_area</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gross_error</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span>
                    <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">-</span> <span class="n">total_area</span> <span class="o">*</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_value</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">gross_error</span></div>


<div class="viewcode-block" id="VoronoiMaster._find_total">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._find_total">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the total value within a number or nestable dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_total</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total</span></div>


<div class="viewcode-block" id="VoronoiMaster._compute_boundaries">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._compute_boundaries">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_boundaries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">side_length</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="n">custom_shape_vertices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">voronoi_list_old</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main function used for computing layered voronoi diagram based on</span>
<span class="sd">        existing voronoi diagram to ensure the location of each block stays</span>
<span class="sd">        the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">custom_shape_vertices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">canvas_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">side_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">side_length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">side_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">side_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">canvas_obj</span> <span class="o">=</span> <span class="n">PolygonClass</span><span class="p">(</span><span class="n">canvas_vertices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">canvas_obj</span> <span class="o">=</span> <span class="n">PolygonClass</span><span class="p">(</span><span class="n">custom_shape_vertices</span><span class="p">)</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_total</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">voronoi_list_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">voronoi_old</span> <span class="o">=</span> <span class="n">voronoi_list_old</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">voronoi_out</span><span class="p">,</span> <span class="n">error_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voronoi_main_function</span><span class="p">(</span>
                <span class="n">labels</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">voronoi_old</span><span class="o">=</span><span class="n">voronoi_old</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">voronoi_out</span><span class="p">,</span> <span class="n">error_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voronoi_main_function</span><span class="p">(</span>
                <span class="n">labels</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">canvas_obj</span>
            <span class="p">)</span>
        <span class="n">voronoi_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">voronoi_out</span><span class="p">]</span>
        <span class="n">polygon_value_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">]</span>
        <span class="n">label_site_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dic</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="n">polygon_value_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">voronoi_out</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">label_site_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">voronoi_out</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">voronoi_list_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">voronoi_old</span> <span class="o">=</span> <span class="n">voronoi_list_old</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">voronoi_list_old</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">new_voronoi</span><span class="p">,</span> <span class="n">polygon_value_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label_site_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_boundaries</span><span class="p">(</span>
                            <span class="n">value</span><span class="p">,</span>
                            <span class="n">voronoi_list_old</span><span class="o">=</span><span class="n">voronoi_old</span><span class="p">,</span>
                            <span class="n">custom_shape_vertices</span><span class="o">=</span><span class="n">voronoi_out</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_voronoi</span><span class="p">,</span> <span class="n">polygon_value_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label_site_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_boundaries</span><span class="p">(</span>
                            <span class="n">value</span><span class="p">,</span> <span class="n">custom_shape_vertices</span><span class="o">=</span><span class="n">voronoi_out</span><span class="o">.</span><span class="n">polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xy</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">voronoi_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_voronoi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">voronoi_list</span><span class="p">,</span> <span class="n">polygon_value_list</span><span class="p">,</span> <span class="n">label_site_list</span></div>


<div class="viewcode-block" id="VoronoiMaster._voronoi_main_function">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._voronoi_main_function">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_voronoi_main_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">voronoi_old</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call voronoi_treemap to compute the voronoi diagram, with baseline</span>
<span class="sd">        number of iterations = 75. If the computed voronoi diagram has error</span>
<span class="sd">        &gt;= 0.15, increase the iterations to 150 and so on until the error</span>
<span class="sd">        &lt; 0.15. If the error increases after increasing the number of iterations</span>
<span class="sd">        , recompute the whole voronoi diagram all over again.</span>

<span class="sd">        Please be careful when interpreting the error output. An error between</span>
<span class="sd">        0.5~0.15 is expected. If the error = 0, that means the whole voronoi</span>
<span class="sd">        diagram is not properly generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">voronoi_old</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">voronoi</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voronoi_treemap</span><span class="p">(</span><span class="n">canvas_obj</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="mf">0.15</span><span class="p">:</span>
                <span class="n">voronoi</span><span class="p">,</span> <span class="n">error_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voronoi_treemap_recal</span><span class="p">(</span><span class="n">voronoi</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error_new</span> <span class="o">&lt;=</span> <span class="mf">0.15</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="n">error_new</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">error_new</span> <span class="o">&gt;=</span> <span class="n">error</span><span class="p">:</span>
                        <span class="n">voronoi</span><span class="p">,</span> <span class="n">error_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voronoi_treemap</span><span class="p">(</span>
                            <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">values</span>
                        <span class="p">)</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">error_new</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;This random seed is not able to produce an error less &quot;</span>
                        <span class="s2">&quot;than 0.15. Please choose another random seed instead.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">voronoi_merge</span> <span class="o">=</span> <span class="n">voronoi_old</span>
            <span class="n">voronoi_merge</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>
            <span class="n">voronoi_merge</span><span class="o">.</span><span class="n">canvas_obj</span> <span class="o">=</span> <span class="n">canvas_obj</span>
            <span class="n">voronoi</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voronoi_treemap_recal</span><span class="p">(</span><span class="n">voronoi_merge</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="mf">0.15</span><span class="p">:</span>
                <span class="n">voronoi</span><span class="p">,</span> <span class="n">error_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voronoi_treemap_recal</span><span class="p">(</span><span class="n">voronoi</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error_new</span> <span class="o">&lt;=</span> <span class="mf">0.15</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="n">error_new</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">error_new</span> <span class="o">&gt;=</span> <span class="n">error</span><span class="p">:</span>
                        <span class="n">voronoi</span><span class="p">,</span> <span class="n">error_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_voronoi_treemap</span><span class="p">(</span>
                            <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">values</span>
                        <span class="p">)</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">error_new</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;This random seed is not able to produce an error less &quot;</span>
                        <span class="s2">&quot;than 0.15. Please choose another random seed instead.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">voronoi</span><span class="p">,</span> <span class="n">error</span></div>


<div class="viewcode-block" id="VoronoiMaster._voronoi_treemap">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._voronoi_treemap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_voronoi_treemap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main working horse of the whole function. This function compute the</span>
<span class="sd">        initial voronoi diagram, adapt the location of each site and the weight</span>
<span class="sd">        of each site, re-compute the voronoi diagram, and compute the error of</span>
<span class="sd">        the voronoi diagram. If the error is too high, repeat this process until</span>
<span class="sd">        the error falls below error threshold or the number of iteration exceeds</span>
<span class="sd">        i_max(= 75).</span>

<span class="sd">        Certain amount of error is intrinsic to this plot. Therefore, blindly</span>
<span class="sd">        increasing the number of maximum iteration does not guarantee a decrease</span>
<span class="sd">        in error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_points</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># if there is only 1 point, we don&#39;t need to compute the diagram</span>
            <span class="n">voronoi</span> <span class="o">=</span> <span class="n">VoronoiClass</span><span class="p">(</span>
                <span class="p">[</span><span class="n">canvas_obj</span><span class="p">],</span>
                <span class="n">canvas_obj</span><span class="o">.</span><span class="n">xy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                <span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
                <span class="n">values</span><span class="p">,</span>
                <span class="n">canvas_obj</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">voronoi</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>
            <span class="k">return</span> <span class="n">voronoi</span><span class="p">,</span> <span class="n">error</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># initialization</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">random_points_in_canvas</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">n_points</span>
            <span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>

            <span class="c1"># calculate initial voronoi plot</span>
            <span class="n">voronoi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_power_diagram</span><span class="p">(</span><span class="n">canvas_obj</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="c1"># adjust position and weight until error becomes acceptable</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_max</span><span class="p">:</span>
                <span class="n">voronoi</span><span class="o">.</span><span class="n">adapt_positions_weights</span><span class="p">()</span>
                <span class="n">voronoi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_power_diagram</span><span class="p">(</span><span class="n">voronoi</span><span class="p">)</span>
                <span class="n">voronoi</span><span class="o">.</span><span class="n">adapt_weights</span><span class="p">()</span>
                <span class="n">voronoi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_power_diagram</span><span class="p">(</span><span class="n">voronoi</span><span class="p">)</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">compute_error</span><span class="p">()</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">err_thres</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">voronoi</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>

        <span class="k">return</span> <span class="n">voronoi</span><span class="p">,</span> <span class="n">error</span></div>


<div class="viewcode-block" id="VoronoiMaster._voronoi_treemap_recal">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._voronoi_treemap_recal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_voronoi_treemap_recal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">voronoi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basically the same function as _voronoi_treemap but skip the</span>
<span class="sd">        initialization part. This ensures the new plot is built on previous</span>
<span class="sd">        results and the previous iterations are not wasted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">points</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_max</span><span class="p">:</span>
            <span class="n">voronoi</span><span class="o">.</span><span class="n">adapt_positions_weights</span><span class="p">()</span>
            <span class="n">voronoi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_power_diagram</span><span class="p">(</span><span class="n">voronoi</span><span class="p">)</span>
            <span class="n">voronoi</span><span class="o">.</span><span class="n">adapt_weights</span><span class="p">()</span>
            <span class="n">voronoi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_power_diagram</span><span class="p">(</span><span class="n">voronoi</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">compute_error</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">err_thres</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">voronoi</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>
        <span class="k">return</span> <span class="n">voronoi</span><span class="p">,</span> <span class="n">error</span></div>


<div class="viewcode-block" id="VoronoiMaster._compute_power_diagram">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._compute_power_diagram">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_power_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the draft of the voronoi diagram, or the power diagram following</span>
<span class="sd">        the nomeclature of our code reference. This function seperate the cases</span>
<span class="sd">        for n = 2, 3, 4 and above. For n = 2, since there should always be a</span>
<span class="sd">        solution, the function will rescue itself by resetting the initial sites</span>
<span class="sd">        until a solution is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_polygon</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_polygon</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># directly compute by intersecting the bisectors</span>
            <span class="k">if</span> <span class="n">n_polygon</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">x_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">y_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">bisector</span> <span class="o">=</span> <span class="n">LineClass</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

                <span class="c1"># find intersect point with canvas</span>
                <span class="n">edge_new</span> <span class="o">=</span> <span class="n">bisector</span><span class="o">.</span><span class="n">find_intersect_with_canvas</span><span class="p">(</span><span class="n">canvas_obj</span><span class="p">)</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sites</span> <span class="o">=</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">random_points_in_canvas</span><span class="p">(</span><span class="n">n_polygon</span><span class="p">)</span>
                    <span class="n">x_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">y_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">bisector</span> <span class="o">=</span> <span class="n">LineClass</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                    <span class="n">edge_new</span> <span class="o">=</span> <span class="n">bisector</span><span class="o">.</span><span class="n">find_intersect_with_canvas</span><span class="p">(</span><span class="n">canvas_obj</span><span class="p">)</span>
                <span class="n">polygons_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_divide_polygons</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">edge_new</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># n_polygon = 3</span>
                <span class="n">site_label</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                <span class="n">sites</span><span class="p">,</span> <span class="n">ray_obj_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_bisector_positive_ray</span><span class="p">(</span>
                    <span class="n">sites</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">site_label</span><span class="p">,</span> <span class="n">canvas_obj</span>
                <span class="p">)</span>
                <span class="n">polygons_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_divide_polygons</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">ray_obj_all</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">y_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="c1"># 1. map sites into dual space</span>
            <span class="n">dual_sites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">x_col</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y_col</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># 2. find the convex hull of the points in dual space</span>
            <span class="n">faces</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">dual_sites</span><span class="p">)</span>
            <span class="n">simplices</span> <span class="o">=</span> <span class="n">faces</span><span class="o">.</span><span class="n">simplices</span>

            <span class="c1"># 3. select only the lower convex hull</span>
            <span class="c1"># and convert the triangle in dual space into the intersection</span>
            <span class="c1"># points(ipoints) in normal space</span>
            <span class="n">ipoints</span><span class="p">,</span> <span class="n">simplices_prune</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_and_convert_to_ipoints</span><span class="p">(</span>
                <span class="n">dual_sites</span><span class="p">,</span> <span class="n">simplices</span><span class="p">,</span> <span class="n">canvas_obj</span>
            <span class="p">)</span>

            <span class="c1"># 4. compute the ray objects of each ipoints</span>
            <span class="n">ray_obj_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_multiple_positive_ray</span><span class="p">(</span>
                <span class="n">sites</span><span class="p">,</span> <span class="n">ipoints</span><span class="p">,</span> <span class="n">simplices_prune</span>
            <span class="p">)</span>

            <span class="c1"># 5. compute the coordinate of each polygon</span>
            <span class="n">polygons_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_divide_polygons</span><span class="p">(</span>
                <span class="n">sites</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">,</span> <span class="p">(</span><span class="n">ray_obj_all</span><span class="p">,</span> <span class="n">simplices_prune</span><span class="p">,</span> <span class="n">ipoints</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># convert to object and find the site with largest</span>
        <span class="c1"># area_target/area_current ratio, which will displace its neighbor</span>
        <span class="n">voronoi</span> <span class="o">=</span> <span class="n">VoronoiClass</span><span class="p">(</span><span class="n">polygons_all</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">)</span>
        <span class="n">voronoi</span><span class="o">.</span><span class="n">find_sites_causing_displacement</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">voronoi</span></div>


<div class="viewcode-block" id="VoronoiMaster._recompute_power_diagram">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._recompute_power_diagram">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_recompute_power_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">voronoi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        the same function as _compute_power_diagram but accept an existing</span>
<span class="sd">        voronoi object as input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">sites</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">weights</span>
        <span class="k">if</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">n_sites</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># directly compute by intersecting the bisectors</span>
            <span class="k">if</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">n_sites</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">x_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">y_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">bisector</span> <span class="o">=</span> <span class="n">LineClass</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

                <span class="c1"># find intersect point with canvas</span>
                <span class="n">edge_new</span> <span class="o">=</span> <span class="n">bisector</span><span class="o">.</span><span class="n">find_intersect_with_canvas</span><span class="p">(</span><span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span><span class="p">)</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sites</span> <span class="o">=</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">random_points_in_canvas</span><span class="p">(</span><span class="n">voronoi</span><span class="o">.</span><span class="n">n_sites</span><span class="p">)</span>
                    <span class="n">x_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">y_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">bisector</span> <span class="o">=</span> <span class="n">LineClass</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
                    <span class="n">edge_new</span> <span class="o">=</span> <span class="n">bisector</span><span class="o">.</span><span class="n">find_intersect_with_canvas</span><span class="p">(</span><span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span><span class="p">)</span>

                <span class="n">polygons_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_divide_polygons</span><span class="p">(</span>
                    <span class="n">sites</span><span class="p">,</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span><span class="p">,</span> <span class="n">edge_new</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># n_polygon = 3</span>
                <span class="n">site_label</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                <span class="n">sites</span><span class="p">,</span> <span class="n">ray_obj_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_bisector_positive_ray</span><span class="p">(</span>
                    <span class="n">sites</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">site_label</span><span class="p">,</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span>
                <span class="p">)</span>
                <span class="n">polygons_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_divide_polygons</span><span class="p">(</span>
                    <span class="n">sites</span><span class="p">,</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span><span class="p">,</span> <span class="n">ray_obj_all</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">y_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="c1"># 1. map sites into dual space</span>
            <span class="n">dual_sites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">x_col</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y_col</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">weights</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># 2. find the convex hull of the points in dual space</span>
            <span class="n">faces</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">dual_sites</span><span class="p">)</span>
            <span class="n">simplices</span> <span class="o">=</span> <span class="n">faces</span><span class="o">.</span><span class="n">simplices</span>

            <span class="c1"># 3. select only the lower convex hull and convert the triangle in</span>
            <span class="c1"># dual space into the intersection points(ipoints) in normal space</span>
            <span class="n">ipoints</span><span class="p">,</span> <span class="n">simplices_prune</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_and_convert_to_ipoints</span><span class="p">(</span>
                <span class="n">dual_sites</span><span class="p">,</span> <span class="n">simplices</span><span class="p">,</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span>
            <span class="p">)</span>

            <span class="c1"># 4. compute the ray objects of each ipoints</span>
            <span class="n">ray_obj_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_multiple_positive_ray</span><span class="p">(</span>
                <span class="n">sites</span><span class="p">,</span> <span class="n">ipoints</span><span class="p">,</span> <span class="n">simplices_prune</span>
            <span class="p">)</span>

            <span class="c1"># 5. compute the coordinate of each polygon</span>
            <span class="n">polygons_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_divide_polygons</span><span class="p">(</span>
                <span class="n">sites</span><span class="p">,</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span><span class="p">,</span> <span class="p">(</span><span class="n">ray_obj_all</span><span class="p">,</span> <span class="n">simplices_prune</span><span class="p">,</span> <span class="n">ipoints</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># convert to object and find the site with largest</span>
        <span class="c1"># area_target/area_current ratio, which will displace its neighbor</span>
        <span class="n">voronoi</span> <span class="o">=</span> <span class="n">VoronoiClass</span><span class="p">(</span>
            <span class="n">polygons_all</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">voronoi</span><span class="o">.</span><span class="n">canvas_obj</span>
        <span class="p">)</span>
        <span class="n">voronoi</span><span class="o">.</span><span class="n">find_sites_causing_displacement</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">voronoi</span></div>


<div class="viewcode-block" id="VoronoiMaster._divide_polygons">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._divide_polygons">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_divide_polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">:</span> <span class="n">PolygonClass</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">n_corners</span> <span class="o">=</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">n_corners</span>
        <span class="n">n_sites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_sites</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">edge</span> <span class="o">=</span> <span class="n">args</span>
            <span class="c1"># 1. convert edge to ax + by = c</span>
            <span class="p">[[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">edge</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
            <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>

            <span class="c1"># 2. calculate for each site and each corner of the canvas,</span>
            <span class="c1"># ax + by - c &gt; 0 or &lt; 0 to determine if they are on the same side</span>
            <span class="c1"># to the edge.</span>
            <span class="n">above_below_sites</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]))</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="n">above_below_corners</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]))</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="n">polygons_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">PolygonClass</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># 3. assign the corners which is on the same side as each site, and</span>
            <span class="c1"># determine the final coordinates of the 2 polygons.</span>
            <span class="k">if</span> <span class="n">above_below_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">above_below_sites</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sites</span><span class="p">):</span>
                    <span class="n">corner_polygon</span> <span class="o">=</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span>
                        <span class="n">above_below_corners</span> <span class="o">==</span> <span class="n">above_below_sites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">]</span>
                    <span class="n">corner_polygon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">corner_polygon</span><span class="p">,</span> <span class="n">edge</span><span class="p">])</span>
                    <span class="n">corner_polygon</span> <span class="o">=</span> <span class="p">(</span><span class="n">corner_polygon</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
                    <span class="n">corner_polygon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">corner_polygon</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">polygon</span> <span class="o">=</span> <span class="n">PolygonClass</span><span class="p">(</span><span class="n">corner_polygon</span><span class="p">)</span>
                    <span class="n">polygons_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">n_sites</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ray_obj_all</span> <span class="o">=</span> <span class="n">args</span>

            <span class="c1"># 0. convert each ray to a_r1*x + b_r1*y + c_r1 = 0</span>
            <span class="n">a_r1</span><span class="p">,</span> <span class="n">a_r2</span><span class="p">,</span> <span class="n">a_r3</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">a_r</span><span class="p">,</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">a_r</span><span class="p">,</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">a_r</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">b_r1</span><span class="p">,</span> <span class="n">b_r2</span><span class="p">,</span> <span class="n">b_r3</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">b_r</span><span class="p">,</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">b_r</span><span class="p">,</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">b_r</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">c_r1</span><span class="p">,</span> <span class="n">c_r2</span><span class="p">,</span> <span class="n">c_r3</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">c_r</span><span class="p">,</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">c_r</span><span class="p">,</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">c_r</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">coefficient_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a_r1</span><span class="p">,</span> <span class="n">a_r2</span><span class="p">,</span> <span class="n">a_r3</span><span class="p">],</span> <span class="p">[</span><span class="n">b_r1</span><span class="p">,</span> <span class="n">b_r2</span><span class="p">,</span> <span class="n">b_r3</span><span class="p">]])</span>
            <span class="n">c_r_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c_r1</span><span class="p">,</span> <span class="n">c_r2</span><span class="p">,</span> <span class="n">c_r3</span><span class="p">])</span>

            <span class="c1"># 1. calculate the edge created by each ray by finding the</span>
            <span class="c1"># intersection point of each ray with canvas</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">find_ray_intersect_with_canvas</span><span class="p">(</span><span class="n">canvas_obj</span><span class="p">)</span>

            <span class="c1"># 2. determine if each site and each corner is above or below each</span>
            <span class="c1"># ray by calculating Ax+By+C &gt;0 or &lt;0 (AB table = above/below table)</span>
            <span class="n">above_below_corners</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">coefficient_matrix</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c_r_matrix</span><span class="p">,</span> <span class="p">(</span><span class="n">n_corners</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">above_below_sites</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">coefficient_matrix</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c_r_matrix</span><span class="p">,</span> <span class="p">(</span><span class="n">n_sites</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="p">)</span>

            <span class="c1"># 3. group the corners, edges, intersection points that are on the</span>
            <span class="c1"># same side as each site and form the coordinates of each polygon.</span>
            <span class="n">polygons_all</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">ab_corners_temp</span> <span class="o">=</span> <span class="n">above_below_corners</span><span class="p">[:,</span> <span class="n">indices</span> <span class="o">!=</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">ab_site_temp</span> <span class="o">=</span> <span class="n">above_below_sites</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">indices</span> <span class="o">!=</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">target_corner</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">ab_corners_temp</span><span class="p">,</span> <span class="n">ab_site_temp</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="c1"># append the included corners by 2 rays</span>
                <span class="n">corner_polygon</span> <span class="o">=</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="n">target_corner</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">j_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">j_list</span> <span class="o">=</span> <span class="n">j_list</span><span class="p">[</span><span class="n">j_list</span> <span class="o">!=</span> <span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">j_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray_obj_all</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">edge</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corner_polygon</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">corner_polygon</span> <span class="o">=</span> <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">edge</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">corner_polygon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">corner_polygon</span><span class="p">,</span> <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">edge</span><span class="p">]</span>
                            <span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corner_polygon</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">corner_polygon</span> <span class="o">=</span> <span class="p">(</span><span class="n">corner_polygon</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
                    <span class="n">corner_polygon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">corner_polygon</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">polygon</span> <span class="o">=</span> <span class="n">PolygonClass</span><span class="p">(</span><span class="n">corner_polygon</span><span class="p">)</span>
                    <span class="n">polygons_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">polygon</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ray_obj_all</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">simplices_prune</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ipoints</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">n_ipoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplices_prune</span><span class="p">)</span>

            <span class="c1"># 1. for all the intersection points, we first determine whether</span>
            <span class="c1"># each site and each corners are above or below each ray.</span>
            <span class="n">ab_corners_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ipoints</span><span class="p">)]</span>
            <span class="n">ab_sites_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ipoints</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ipoints</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="c1"># 1-1. convert each ray to a_r1*x + b_r1*y + c_r1 = 0</span>
                    <span class="n">a_r1</span><span class="p">,</span> <span class="n">a_r2</span><span class="p">,</span> <span class="n">a_r3</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">a_r</span><span class="p">,</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">a_r</span><span class="p">,</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">a_r</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">b_r1</span><span class="p">,</span> <span class="n">b_r2</span><span class="p">,</span> <span class="n">b_r3</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">b_r</span><span class="p">,</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">b_r</span><span class="p">,</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">b_r</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">c_r1</span><span class="p">,</span> <span class="n">c_r2</span><span class="p">,</span> <span class="n">c_r3</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">c_r</span><span class="p">,</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">c_r</span><span class="p">,</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">c_r</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">coefficient_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="p">[[</span><span class="n">a_r1</span><span class="p">,</span> <span class="n">a_r2</span><span class="p">,</span> <span class="n">a_r3</span><span class="p">],</span> <span class="p">[</span><span class="n">b_r1</span><span class="p">,</span> <span class="n">b_r2</span><span class="p">,</span> <span class="n">b_r3</span><span class="p">]]</span>
                    <span class="p">)</span>
                    <span class="n">c_r_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c_r1</span><span class="p">,</span> <span class="n">c_r2</span><span class="p">,</span> <span class="n">c_r3</span><span class="p">])</span>

                    <span class="c1"># 1-2. calculate the edge created by each ray</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">find_ray_intersect_with_canvas_and_ipoints</span><span class="p">(</span>
                            <span class="n">canvas_obj</span><span class="p">,</span> <span class="n">ipoints</span><span class="p">,</span> <span class="n">simplices_prune</span>
                        <span class="p">)</span>

                    <span class="c1"># 1-3. calculate Ax+By+C &gt;0 or &lt;0 (AB table = above/below table)</span>
                    <span class="n">ab_corners_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">canvas_obj</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">coefficient_matrix</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c_r_matrix</span><span class="p">,</span> <span class="p">(</span><span class="n">n_corners</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">ab_sites_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">coefficient_matrix</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c_r_matrix</span><span class="p">,</span> <span class="p">(</span><span class="n">n_sites</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="p">)</span>

            <span class="c1"># 2. by referring to the ab_corners_table and ab_sites_table</span>
            <span class="c1"># find the coordinates of each polygon.</span>
            <span class="n">polygons_all</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sites</span><span class="p">)]</span>
            <span class="n">corner_polygon_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sites</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sites</span><span class="p">):</span>
                <span class="n">iP_index_required</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">simplices_prune</span> <span class="o">==</span> <span class="n">k</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">target_corner_test</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">iP_index_required</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">m</span><span class="p">]:</span>
                        <span class="n">simplex</span> <span class="o">=</span> <span class="n">simplices_prune</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                        <span class="p">[</span><span class="n">loc_012</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">simplex</span> <span class="o">==</span> <span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># 2-1. find the potential corners if they are on the</span>
                        <span class="c1"># same side as each site:</span>
                        <span class="n">ab_corners_temp</span> <span class="o">=</span> <span class="n">ab_corners_table</span><span class="p">[</span><span class="n">m</span><span class="p">][:,</span> <span class="n">indices</span> <span class="o">!=</span> <span class="n">loc_012</span><span class="p">]</span>
                        <span class="n">ab_site_temp</span> <span class="o">=</span> <span class="n">ab_sites_table</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">k</span><span class="p">,</span> <span class="n">indices</span> <span class="o">!=</span> <span class="n">loc_012</span><span class="p">]</span>
                        <span class="n">target_corner_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">ab_corners_temp</span><span class="p">,</span> <span class="n">ab_site_temp</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="o">==</span> <span class="mi">2</span>
                                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                        <span class="c1"># 2-2. append the edges formed by nearby rays.</span>
                        <span class="n">n_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                        <span class="n">n_list</span> <span class="o">=</span> <span class="n">n_list</span><span class="p">[</span><span class="n">n_list</span> <span class="o">!=</span> <span class="n">loc_012</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n_list</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray_obj_all</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">edge</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">edge</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                                        <span class="p">[</span><span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">edge</span><span class="p">]</span>
                                    <span class="p">)</span>

                <span class="c1"># 2-3. reconcile the potential corners across different ipoints,</span>
                <span class="c1"># find target_corner (some corners may be on the same side as</span>
                <span class="c1"># the site with respect to one ipoint, but not other nearby</span>
                <span class="c1"># ipoints. We have to make sure that the final corners included</span>
                <span class="c1"># are on the same side as each site with respect to all ipoints</span>
                <span class="c1"># nearby.)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_corner_test</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_corner_test</span><span class="p">)):</span>
                        <span class="n">target_corner_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_corner_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                            <span class="n">target_corner_test</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                        <span class="p">)</span>

                <span class="c1"># 2-4. append the target corners</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_corner_test</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span>
                            <span class="nb">list</span><span class="p">(</span><span class="n">target_corner_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">:</span>
                        <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                <span class="n">canvas_obj</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">target_corner_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">:],</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># 2-5. remove redundant corners of each polygon</span>
                    <span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                        <span class="nb">int</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
                    <span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># 2-6. create and store the polygon object for each site</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">polygon</span> <span class="o">=</span> <span class="n">PolygonClass</span><span class="p">(</span><span class="n">corner_polygon_all</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">polygons_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">polygon</span>

        <span class="k">return</span> <span class="n">polygons_all</span></div>


<div class="viewcode-block" id="VoronoiMaster._find_bisector_positive_ray">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._find_bisector_positive_ray">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_bisector_positive_ray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">site_label</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is designed for n=3. This function compute the 3 bisectors</span>
<span class="sd">        among 3 sites, find the intersect point (ipoint) of these 3 bisectors,</span>
<span class="sd">        and define the positive direction of each ray.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_compute_determinant</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
            <span class="p">[[</span><span class="n">x0</span><span class="p">],</span> <span class="p">[</span><span class="n">x1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x_col</span>
            <span class="p">[[</span><span class="n">y0</span><span class="p">],</span> <span class="p">[</span><span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">y2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">y_col</span>
            <span class="p">[</span><span class="n">w0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x0</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x1</span>
            <span class="n">a3</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x2</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y0</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y1</span>
            <span class="n">b3</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y2</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x0</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">w0</span><span class="p">)</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">w1</span><span class="p">)</span>
            <span class="n">d3</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">w2</span><span class="p">)</span>
            <span class="n">det</span> <span class="o">=</span> <span class="o">-</span><span class="n">a1</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">-</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">b3</span> <span class="o">-</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">b3</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">b1</span>
            <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">y_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_int</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">d1</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">-</span> <span class="n">d2</span> <span class="o">*</span> <span class="n">b3</span> <span class="o">-</span> <span class="n">d3</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">d3</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">*</span> <span class="n">b3</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">*</span> <span class="n">b1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="o">-</span><span class="n">det</span>
                <span class="p">)</span>
                <span class="n">y_int</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">a1</span> <span class="o">*</span> <span class="n">d2</span> <span class="o">-</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">d3</span> <span class="o">-</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">d1</span> <span class="o">+</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">d2</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">d3</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">d1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="o">-</span><span class="n">det</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">det</span><span class="p">,</span> <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span>

        <span class="c1"># 1. Find the 3 bisectors and the ipoint</span>
        <span class="c1"># If no solution is possible, reset the location of sites until there</span>
        <span class="c1"># is a solution</span>
        <span class="n">x_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">y_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">det</span><span class="p">,</span> <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span> <span class="o">=</span> <span class="n">_compute_determinant</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">random_points_in_canvas</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">x_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">y_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">det</span><span class="p">,</span> <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span> <span class="o">=</span> <span class="n">_compute_determinant</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

        <span class="n">ipoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">])</span>

        <span class="c1"># If the intersection point is not within the canvas,</span>
        <span class="c1"># reset the location of sites until it is within canvas</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">point_is_within_canvas</span><span class="p">(</span><span class="n">ipoint</span><span class="p">):</span>
            <span class="n">det</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sites</span> <span class="o">=</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">random_points_in_canvas</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">x_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">y_col</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">det</span><span class="p">,</span> <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span> <span class="o">=</span> <span class="n">_compute_determinant</span><span class="p">(</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

            <span class="n">ipoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">])</span>

        <span class="c1"># 2. find the positive direction of the 3 rays.</span>
        <span class="n">ray_obj_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_point_is_within_triangle</span><span class="p">(</span><span class="n">ipoint</span><span class="p">,</span> <span class="n">sites</span><span class="p">):</span>
            <span class="c1"># if the ipoint is within the triangle formed by 3 sites, the</span>
            <span class="c1"># positive direction of the ray is the one that moves away from the</span>
            <span class="c1"># opposite site.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">site_remain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">site_remain</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="n">site_remain</span> <span class="o">!=</span> <span class="n">k</span><span class="p">]</span>
                <span class="n">tag1</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tag2</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">t_bisector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_col</span><span class="p">[</span><span class="n">tag2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_col</span><span class="p">[</span><span class="n">tag1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_col</span><span class="p">[</span><span class="n">tag1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_col</span><span class="p">[</span><span class="n">tag2</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t_bisector</span><span class="p">,</span> <span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">t_bisector</span> <span class="o">=</span> <span class="o">-</span><span class="n">t_bisector</span>
                <span class="n">ray_obj_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">RayClass</span><span class="p">(</span>
                        <span class="n">ipoint</span><span class="p">,</span>
                        <span class="n">t_bisector</span><span class="p">,</span>
                        <span class="p">[</span><span class="n">site_label</span><span class="p">[</span><span class="n">tag1</span><span class="p">],</span> <span class="n">site_label</span><span class="p">[</span><span class="n">tag2</span><span class="p">]],</span>
                        <span class="n">site_label</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if the ipoint is not within the triangle formed by 3 sites, the</span>
            <span class="c1"># positive direction is defined in a way that can divide the canvas</span>
            <span class="c1"># into 3 polygons and each polygon contains 1 site.</span>
            <span class="n">com_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">sites</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">sites</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">point_opposite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                <span class="p">(</span><span class="n">com_line</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">com_line</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">site_remain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">site_remain</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="n">site_remain</span> <span class="o">!=</span> <span class="n">k</span><span class="p">]</span>
                <span class="n">tag1</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tag2</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">t_bisector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_col</span><span class="p">[</span><span class="n">tag2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_col</span><span class="p">[</span><span class="n">tag1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_col</span><span class="p">[</span><span class="n">tag1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_col</span><span class="p">[</span><span class="n">tag2</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">point_opposite</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t_bisector</span><span class="p">,</span> <span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">t_bisector</span> <span class="o">=</span> <span class="o">-</span><span class="n">t_bisector</span>
                    <span class="n">ray_obj_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">RayClass</span><span class="p">(</span>
                            <span class="n">ipoint</span><span class="p">,</span>
                            <span class="n">t_bisector</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">site_label</span><span class="p">[</span><span class="n">tag1</span><span class="p">],</span> <span class="n">site_label</span><span class="p">[</span><span class="n">tag2</span><span class="p">]],</span>
                            <span class="n">site_label</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t_bisector</span><span class="p">,</span> <span class="p">(</span><span class="n">com_line</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">t_bisector</span> <span class="o">=</span> <span class="o">-</span><span class="n">t_bisector</span>
                    <span class="n">ray_obj_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">RayClass</span><span class="p">(</span>
                            <span class="n">ipoint</span><span class="p">,</span>
                            <span class="n">t_bisector</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">site_label</span><span class="p">[</span><span class="n">tag1</span><span class="p">],</span> <span class="n">site_label</span><span class="p">[</span><span class="n">tag2</span><span class="p">]],</span>
                            <span class="n">site_label</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">sites</span><span class="p">,</span> <span class="n">ray_obj_all</span></div>


<div class="viewcode-block" id="VoronoiMaster._find_multiple_positive_ray">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._find_multiple_positive_ray">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_multiple_positive_ray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">,</span> <span class="n">ipoints</span><span class="p">,</span> <span class="n">simplices_prune</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is designed for n&gt;=4. This function define the positive</span>
<span class="sd">        direction of each ray in a way that is the same as</span>
<span class="sd">        _find_bisector_positive_ray.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_ipoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">simplices_prune</span><span class="p">)</span>
        <span class="n">ray_obj_all</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ipoints</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ipoints</span><span class="p">):</span>
            <span class="n">ipoint</span> <span class="o">=</span> <span class="n">ipoints</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">site_label</span> <span class="o">=</span> <span class="n">simplices_prune</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sites_temp</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="n">simplices_prune</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">x_col_temp</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="n">simplices_prune</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">y_col_temp</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="n">simplices_prune</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">ray_obj_ipoint</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_point_is_within_triangle</span><span class="p">(</span><span class="n">ipoint</span><span class="p">,</span> <span class="n">sites_temp</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">site_remain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">site_remain</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="n">site_remain</span> <span class="o">!=</span> <span class="n">k</span><span class="p">]</span>
                    <span class="n">tag1</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">tag2</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">t_bisector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_col_temp</span><span class="p">[</span><span class="n">tag2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_col_temp</span><span class="p">[</span><span class="n">tag1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                            <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_col_temp</span><span class="p">[</span><span class="n">tag1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_col_temp</span><span class="p">[</span><span class="n">tag2</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t_bisector</span><span class="p">,</span> <span class="p">(</span><span class="n">sites_temp</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">t_bisector</span> <span class="o">=</span> <span class="o">-</span><span class="n">t_bisector</span>
                    <span class="n">ray_obj</span> <span class="o">=</span> <span class="n">RayClass</span><span class="p">(</span>
                        <span class="n">ipoint</span><span class="p">,</span>
                        <span class="n">t_bisector</span><span class="p">,</span>
                        <span class="p">[</span><span class="n">site_label</span><span class="p">[</span><span class="n">tag1</span><span class="p">],</span> <span class="n">site_label</span><span class="p">[</span><span class="n">tag2</span><span class="p">]],</span>
                        <span class="n">site_label</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">ray_obj</span><span class="o">.</span><span class="n">index_ip</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">ray_obj</span><span class="o">.</span><span class="n">index_ray</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">ray_obj_ipoint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_obj</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">com_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">sites_temp</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">sites_temp</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">point_opposite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">com_line</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">com_line</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">site_remain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">site_remain</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="n">site_remain</span> <span class="o">!=</span> <span class="n">k</span><span class="p">]</span>
                    <span class="n">tag1</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">tag2</span> <span class="o">=</span> <span class="n">site_remain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">t_bisector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_col_temp</span><span class="p">[</span><span class="n">tag2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_col_temp</span><span class="p">[</span><span class="n">tag1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                            <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_col_temp</span><span class="p">[</span><span class="n">tag1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_col_temp</span><span class="p">[</span><span class="n">tag2</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">point_opposite</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t_bisector</span><span class="p">,</span> <span class="p">(</span><span class="n">sites_temp</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">t_bisector</span> <span class="o">=</span> <span class="o">-</span><span class="n">t_bisector</span>
                        <span class="n">ray_obj</span> <span class="o">=</span> <span class="n">RayClass</span><span class="p">(</span>
                            <span class="n">ipoint</span><span class="p">,</span>
                            <span class="n">t_bisector</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">site_label</span><span class="p">[</span><span class="n">tag1</span><span class="p">],</span> <span class="n">site_label</span><span class="p">[</span><span class="n">tag2</span><span class="p">]],</span>
                            <span class="n">site_label</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">ray_obj</span><span class="o">.</span><span class="n">index_ip</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">ray_obj</span><span class="o">.</span><span class="n">index_ray</span> <span class="o">=</span> <span class="n">k</span>
                        <span class="n">ray_obj_ipoint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_obj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t_bisector</span><span class="p">,</span> <span class="p">(</span><span class="n">com_line</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ipoint</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">t_bisector</span> <span class="o">=</span> <span class="o">-</span><span class="n">t_bisector</span>
                        <span class="n">ray_obj</span> <span class="o">=</span> <span class="n">RayClass</span><span class="p">(</span>
                            <span class="n">ipoint</span><span class="p">,</span>
                            <span class="n">t_bisector</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">site_label</span><span class="p">[</span><span class="n">tag1</span><span class="p">],</span> <span class="n">site_label</span><span class="p">[</span><span class="n">tag2</span><span class="p">]],</span>
                            <span class="n">site_label</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">ray_obj</span><span class="o">.</span><span class="n">index_ip</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">ray_obj</span><span class="o">.</span><span class="n">index_ray</span> <span class="o">=</span> <span class="n">k</span>
                        <span class="n">ray_obj_ipoint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_obj</span><span class="p">)</span>

            <span class="n">ray_obj_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray_obj_ipoint</span>
        <span class="k">return</span> <span class="n">ray_obj_all</span></div>


<div class="viewcode-block" id="VoronoiMaster._prune_and_convert_to_ipoints">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._prune_and_convert_to_ipoints">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prune_and_convert_to_ipoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dual_sites</span><span class="p">,</span> <span class="n">simplices</span><span class="p">,</span> <span class="n">canvas_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function determines which ipoints should be kept.</span>
<span class="sd">        Only the ipoints that (1) belong to the lower convex hull and</span>
<span class="sd">        (2) locate within canvas will be kept.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">com_dualsites</span> <span class="o">=</span> <span class="n">dual_sites</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">simplices_prune</span> <span class="o">=</span> <span class="n">simplices</span>
        <span class="n">ipoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">prune_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">simplex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simplices</span><span class="p">):</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="n">dual_sites</span><span class="p">[</span><span class="n">simplex</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">dual_sites</span><span class="p">[</span><span class="n">simplex</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">z3</span> <span class="o">=</span> <span class="n">dual_sites</span><span class="p">[</span><span class="n">simplex</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">*</span> <span class="p">(</span><span class="n">z2</span> <span class="o">-</span> <span class="n">z3</span><span class="p">)</span> <span class="o">+</span> <span class="n">y2</span> <span class="o">*</span> <span class="p">(</span><span class="n">z3</span> <span class="o">-</span> <span class="n">z1</span><span class="p">)</span> <span class="o">+</span> <span class="n">y3</span> <span class="o">*</span> <span class="p">(</span><span class="n">z1</span> <span class="o">-</span> <span class="n">z2</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x3</span><span class="p">)</span> <span class="o">+</span> <span class="n">z2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x3</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="n">z3</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y3</span><span class="p">)</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">x1</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">*</span> <span class="n">z3</span> <span class="o">-</span> <span class="n">y3</span> <span class="o">*</span> <span class="n">z2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">x2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y3</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">z3</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">x3</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">*</span> <span class="n">z2</span> <span class="o">-</span> <span class="n">y2</span> <span class="o">*</span> <span class="n">z1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">alpha</span> <span class="o">/</span> <span class="n">gamma</span>
            <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span> <span class="o">/</span> <span class="n">gamma</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">gamma</span>  <span class="c1"># z = ax+by+c =&gt; nf = (a, b, -1)</span>

            <span class="c1"># (1) determine if the face belongs to the lower convex Hull</span>
            <span class="n">com_face</span> <span class="o">=</span> <span class="p">(</span><span class="n">dual_sites</span><span class="p">[</span><span class="n">simplex</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">com_face</span> <span class="o">-</span> <span class="n">com_dualsites</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># (2) determine if the ipoint is within canvas</span>
                <span class="k">if</span> <span class="n">canvas_obj</span><span class="o">.</span><span class="n">point_is_within_canvas</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])):</span>
                    <span class="n">ipoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ipoints</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prune_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prune_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">ipoints</span> <span class="o">=</span> <span class="n">ipoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">simplices_prune</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">simplices_prune</span><span class="p">,</span> <span class="n">prune_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ipoints</span><span class="p">,</span> <span class="n">simplices_prune</span></div>


<div class="viewcode-block" id="VoronoiMaster._point_is_within_triangle">
<a class="viewcode-back" href="../../../reference/api/wholecell/wholecell.utils.voronoi_plot_main.html#wholecell.utils.voronoi_plot_main.VoronoiMaster._point_is_within_triangle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_point_is_within_triangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">triangle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a point is within a triangle. The algorithm used is the same as</span>
<span class="sd">        point_is_within_canvas. However, this function does not require the</span>
<span class="sd">        input to be a POLYGON object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">triangle</span> <span class="o">==</span> <span class="n">p</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sum_angle</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">:]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">edge</span> <span class="o">-</span> <span class="n">p</span>
                <span class="n">sum_angle</span> <span class="o">+=</span> <span class="n">angle</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sum_angle</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sum_angle</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">result</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2025, The Vivarium E. coli Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>