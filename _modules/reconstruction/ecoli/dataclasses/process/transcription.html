

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>reconstruction.ecoli.dataclasses.process.transcription &mdash; Vivarium E. coli 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Vivarium E. coli
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../stores.html">Stores</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../processes.html">Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../composites.html">Composites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../experiments.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../hpc.html">HPC Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../gcloud.html">Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ci.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pycharm.html">PyCharm Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../diffs.html">Model Differences From wcEcoli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/api_ref.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Vivarium E. coli</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">reconstruction.ecoli.dataclasses.process.transcription</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for reconstruction.ecoli.dataclasses.process.transcription</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SimulationData for transcription process</span>

<span class="sd">TODO: add mapping of tRNA to charged tRNA if allowing more than one modified form of tRNA and separate mappings for tRNA and charged tRNA to AA</span>
<span class="sd">TODO: handle ppGpp and DksA-ppGpp regulation separately</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">reconstruction.ecoli.dataclasses.getter_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">EXCLUDED_RNA_TYPES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.replication</span><span class="w"> </span><span class="kn">import</span> <span class="n">MAX_TIMESTEP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ecoli.library.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">bulk_name_to_idx</span><span class="p">,</span> <span class="n">counts</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">data</span><span class="p">,</span> <span class="n">fitting</span><span class="p">,</span> <span class="n">units</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils.fast_nonnegative_least_squares</span><span class="w"> </span><span class="kn">import</span> <span class="n">fast_nnls</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">normalize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils.unit_struct_array</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnitStructArray</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils.polymerize</span><span class="w"> </span><span class="kn">import</span> <span class="n">polymerize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wholecell.utils.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_elongation_rates</span>


<span class="n">RNA_SEQ_ANALYSIS</span> <span class="o">=</span> <span class="s2">&quot;rsem_tpm&quot;</span>
<span class="n">PPGPP_CONC_UNITS</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">umol</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">L</span>
<span class="n">PRINT_VALUES</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># print values for supplemental table if True</span>


<div class="viewcode-block" id="TranscriptionDirectionError">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.TranscriptionDirectionError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TranscriptionDirectionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="Transcription">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Transcription</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SimulationData for the transcription process</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_ppgpp_regulation</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_oric_terc_coordinates</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_cistron_data</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_rna_data</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_mature_rna_data</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_transcription</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_charged_trna</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_attenuation</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_elongation_rates</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_new_gene_data</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the state to pickle with transcriptionSequences removed and</span>
<span class="sd">        only storing data from transcriptionSequences with pad values stripped.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dissoc_strict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;transcription_sequences&quot;</span><span class="p">,))</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;sequences&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">seq</span><span class="p">[</span><span class="n">seq</span> <span class="o">!=</span> <span class="n">polymerize</span><span class="o">.</span><span class="n">PAD_VALUE</span><span class="p">]</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transcription_sequences</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;sequence_shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transcription_sequences</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore transcriptionSequences and remove processed versions of the data.&quot;&quot;&quot;</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;sequences&quot;</span><span class="p">)</span>
        <span class="n">sequence_shape</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;sequence_shape&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transcription_sequences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="n">sequence_shape</span><span class="p">,</span> <span class="n">polymerize</span><span class="o">.</span><span class="n">PAD_VALUE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sequences</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transcription_sequences</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seq</span>

<div class="viewcode-block" id="Transcription._build_ppgpp_regulation">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_ppgpp_regulation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_ppgpp_regulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine which genes are regulated by ppGpp and store the fold</span>
<span class="sd">        change in expression associated with each gene.</span>

<span class="sd">        Attributes set:</span>
<span class="sd">                ppgpp_regulated_genes (ndarray[str]): cistron ID of regulated genes</span>
<span class="sd">                ppgpp_fold_changes (ndarray[float]): log2 fold change for each gene</span>
<span class="sd">                        in ppgpp_regulated_genes</span>
<span class="sd">                _ppgpp_growth_parameters: parameters for interpolate.splev</span>
<span class="sd">                        to estimate growth rate from ppGpp concentration</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">read_value</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle empty values from raw_data as 0&quot;&quot;&quot;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">val</span>

        <span class="c1"># Flag to check when ppGpp regulated expression has been set</span>
        <span class="c1"># see set_ppgpp_expression()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ppgpp_expression_set</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Determine KM for ppGpp binding to RNAP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solve_ppgpp_km</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">)</span>

        <span class="c1"># Read regulation data from raw_data</span>
        <span class="c1"># Treats ppGpp and DksA-ppGpp regulation the same</span>
        <span class="n">gene_to_rna</span> <span class="o">=</span> <span class="p">{</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]:</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genes</span><span class="p">}</span>
        <span class="n">rna_id_to_rna_type</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">rnas</span><span class="p">}</span>
        <span class="n">regulation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">ppgpp_regulation</span><span class="p">:</span>
            <span class="c1"># Convert to regulated RNA</span>
            <span class="n">gene</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]</span>
            <span class="n">rna</span> <span class="o">=</span> <span class="n">gene_to_rna</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rna</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rna_id_to_rna_type</span><span class="p">[</span><span class="n">rna</span><span class="p">]</span> <span class="ow">in</span> <span class="n">EXCLUDED_RNA_TYPES</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Add additional gene symbols for matching FC data</span>
            <span class="n">curated_gene</span> <span class="o">=</span> <span class="n">reg</span><span class="p">[</span><span class="s2">&quot;Curated Gene&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">gene</span> <span class="o">!=</span> <span class="n">curated_gene</span><span class="p">:</span>
                <span class="n">gene_to_rna</span><span class="p">[</span><span class="n">curated_gene</span><span class="p">]</span> <span class="o">=</span> <span class="n">rna</span>

            <span class="c1"># Update value (some genes are repeated in raw_data))</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="s2">&quot;ppGpp&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">read_value</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="s2">&quot;DksA-ppGpp&quot;</span><span class="p">)</span>
            <span class="n">regulation</span><span class="p">[</span><span class="n">rna</span><span class="p">]</span> <span class="o">=</span> <span class="n">regulation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rna</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">direction</span>

        <span class="c1"># Read fold change data from raw_data</span>
        <span class="c1">## Categories A-D are statistically significant fold changes</span>
        <span class="c1">## Categories E-G are not significant or data is not usable</span>
        <span class="n">valid_categories</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">}</span>
        <span class="n">sample_time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">5</span>  <span class="c1"># Could also be 10 (5 min minimizes downstream regulation impacts)</span>
        <span class="p">)</span>
        <span class="n">sample_id</span> <span class="o">=</span> <span class="s2">&quot;1+2+ </span><span class="si">{}</span><span class="s2"> min&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">sample_time</span>
        <span class="p">)</span>  <span class="c1"># Column contains FC data for given time</span>
        <span class="n">rna_fold_changes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">ppgpp_fc</span><span class="p">:</span>
            <span class="c1"># Convert to regulated RNA</span>
            <span class="n">gene</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]</span>
            <span class="n">rna</span> <span class="o">=</span> <span class="n">gene_to_rna</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rna</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">category</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Category&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_id</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_categories</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">rna_fold_changes</span><span class="p">[</span><span class="n">rna</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="n">sample_id</span><span class="p">]</span>

        <span class="c1"># Store arrays of regulation</span>
        <span class="n">regulated_genes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">regulation_direction</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fold_changes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">regulation</span><span class="p">):</span>
            <span class="n">reg_dir</span> <span class="o">=</span> <span class="n">regulation</span><span class="p">[</span><span class="n">rna</span><span class="p">]</span>
            <span class="n">fc_dir</span> <span class="o">=</span> <span class="n">rna_fold_changes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rna</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Ignore inconsistent regulatory directions</span>
            <span class="k">if</span> <span class="n">reg_dir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Use default value if annotated direction does not match data direction</span>
            <span class="k">if</span> <span class="n">reg_dir</span> <span class="o">*</span> <span class="n">fc_dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fc_dir</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">regulated_genes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rna</span><span class="p">)</span>
            <span class="n">regulation_direction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">reg_dir</span><span class="p">))</span>
            <span class="n">fold_changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fc_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_regulated_genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">regulated_genes</span><span class="p">)</span>
        <span class="n">regulation_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">regulation_direction</span><span class="p">)</span>

        <span class="c1"># Replace fold changes without data with the average</span>
        <span class="n">fold_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fold_changes</span><span class="p">)</span>
        <span class="n">average_positive_fc</span> <span class="o">=</span> <span class="n">fold_changes</span><span class="p">[</span><span class="n">fold_changes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">fold_changes</span><span class="p">[(</span><span class="n">fold_changes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">regulation_direction</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_ppgpp_fc</span>
        <span class="p">)</span>
        <span class="n">fold_changes</span><span class="p">[(</span><span class="n">fold_changes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">regulation_direction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">average_positive_fc</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_fold_changes</span> <span class="o">=</span> <span class="n">fold_changes</span>

        <span class="c1"># Predict growth rate from ppGpp level</span>
        <span class="c1"># Transforms selected for good fit and to keep the growth rate positive</span>
        <span class="c1"># even at high ppGpp concentrations.</span>
        <span class="n">per_dry_mass_to_per_volume</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">cell_density</span> <span class="o">*</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">cell_dry_mass_fraction</span>
        <span class="p">)</span>
        <span class="n">ppgpp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;ppGpp_conc&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">per_dry_mass_to_per_volume</span><span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span>
                    <span class="n">PPGPP_CONC_UNITS</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">growth_rate_dependent_parameters</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">growth_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;doublingTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">growth_rate_dependent_parameters</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ppgpp_growth_parameters</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">fit_linearized_transforms</span><span class="p">(</span>
            <span class="n">ppgpp</span><span class="p">,</span> <span class="n">growth_rates</span><span class="p">,</span> <span class="n">x_fun</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">],</span> <span class="n">y_fun</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;1/sqrt&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">PRINT_VALUES</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Supplement value (KM): </span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ppgpp_km_squared</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Supplement value (FC): [</span><span class="si">{:.2f}</span><span class="s2">, </span><span class="si">{:.2f}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">fold_changes</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">fold_changes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Supplement value (FC-): </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_ppgpp_fc</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Supplement value (FC+): </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">average_positive_fc</span><span class="p">))</span>

        <span class="c1"># Calculate the expected active fraction when RNAP is bound to ppGpp or free</span>
        <span class="n">doubling_times</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">min</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">ppgpp</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">growth_rate_parameters</span><span class="o">.</span><span class="n">get_ppGpp_conc</span><span class="p">(</span><span class="n">doubling_times</span><span class="p">)</span>
        <span class="n">fraction_active</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">growth_rate_parameters</span><span class="o">.</span><span class="n">get_fraction_active_rnap</span><span class="p">(</span>
            <span class="n">doubling_times</span>
        <span class="p">)</span>
        <span class="n">fraction_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="n">ppgpp</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">fraction_bound</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">fraction_bound</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fraction_active_rnap_bound</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_active_rnap_free</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">fraction_active</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_active_rnap_bound</span> <span class="o">&lt;</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_active_rnap_free</span> <span class="o">&lt;</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Transcription._build_oric_terc_coordinates">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_oric_terc_coordinates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_oric_terc_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds coordinates of oriC and terC that are used when calculating</span>
<span class="sd">        genomic positions of cistrons and RNAs relative to the origin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get coordinates of oriC and terC</span>
        <span class="n">oric_left</span><span class="p">,</span> <span class="n">oric_right</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_genomic_coordinates</span><span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_ids</span><span class="o">.</span><span class="n">oriC_site</span>
        <span class="p">)</span>
        <span class="n">terc_left</span><span class="p">,</span> <span class="n">terc_right</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_genomic_coordinates</span><span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_ids</span><span class="o">.</span><span class="n">terC_site</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_oric_coordinate</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">oric_left</span> <span class="o">+</span> <span class="n">oric_right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terc_coordinate</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">terc_left</span> <span class="o">+</span> <span class="n">terc_right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genome_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">genome_sequence</span><span class="p">)</span></div>


<div class="viewcode-block" id="Transcription._build_cistron_data">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_cistron_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_cistron_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build cistron-associated simulation data from raw data. Cistrons are</span>
<span class="sd">        sections of RNAs that encode for a specific polypeptide. A single RNA</span>
<span class="sd">        molecule may contain one or more cistrons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get list of all cistrons with an associated gene and right and left</span>
        <span class="c1"># end positions</span>
        <span class="n">cistron_id_to_gene_id</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genes</span>
        <span class="p">}</span>
        <span class="n">gene_id_to_left_end_pos</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;left_end_pos&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genes</span>
        <span class="p">}</span>
        <span class="n">gene_id_to_right_end_pos</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;right_end_pos&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genes</span>
        <span class="p">}</span>

        <span class="n">all_cistrons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">rna</span>
            <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">rnas</span>
            <span class="k">if</span> <span class="n">rna</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cistron_id_to_gene_id</span>
            <span class="ow">and</span> <span class="n">gene_id_to_left_end_pos</span><span class="p">[</span><span class="n">cistron_id_to_gene_id</span><span class="p">[</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">gene_id_to_right_end_pos</span><span class="p">[</span><span class="n">cistron_id_to_gene_id</span><span class="p">[</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">rna</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">EXCLUDED_RNA_TYPES</span>
        <span class="p">]</span>
        <span class="n">all_cistron_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cistron</span> <span class="ow">in</span> <span class="n">all_cistrons</span><span class="p">]</span>

        <span class="c1"># Load gene IDs associated with each cistron</span>
        <span class="n">gene_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cistron_id_to_gene_id</span><span class="p">[</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="n">all_cistrons</span><span class="p">])</span>
        <span class="n">gene_id_to_cistron_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cistron_id_to_gene_id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># Calculate lengths of each cistron from their gene end positions</span>
        <span class="n">cistron_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">gene_id_to_right_end_pos</span><span class="p">[</span><span class="n">cistron_id_to_gene_id</span><span class="p">[</span><span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]]</span>
                    <span class="o">-</span> <span class="n">gene_id_to_left_end_pos</span><span class="p">[</span><span class="n">cistron_id_to_gene_id</span><span class="p">[</span><span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]]</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">cistron</span> <span class="ow">in</span> <span class="n">all_cistrons</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Get mapping from cistron IDs to coordinate and direction</span>
        <span class="n">cistron_id_to_coordinate</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cistron_id_to_direction</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genes</span><span class="p">:</span>
            <span class="n">cistron_id_to_direction</span><span class="p">[</span><span class="n">gene</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                <span class="n">cistron_id_to_coordinate</span><span class="p">[</span><span class="n">gene</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;left_end_pos&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cistron_id_to_coordinate</span><span class="p">[</span><span class="n">gene</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;right_end_pos&quot;</span><span class="p">]</span>

        <span class="c1"># Get location of each cistron on the chromosome relative to the origin</span>
        <span class="n">replication_coordinate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_coordinates</span><span class="p">(</span><span class="n">cistron_id_to_coordinate</span><span class="p">[</span><span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">cistron</span> <span class="ow">in</span> <span class="n">all_cistrons</span>
        <span class="p">]</span>

        <span class="c1"># Get direction of each cistron</span>
        <span class="n">is_forward</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cistron_id_to_direction</span><span class="p">[</span><span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="k">for</span> <span class="n">cistron</span> <span class="ow">in</span> <span class="n">all_cistrons</span>
        <span class="p">]</span>

        <span class="c1"># Get cistron nucleotide compositions</span>
        <span class="n">genome_sequence</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genome_sequence</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">parse_sequence</span><span class="p">(</span><span class="n">cistron_id</span><span class="p">,</span> <span class="n">left_end_pos</span><span class="p">,</span> <span class="n">right_end_pos</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Parses genome sequence to get the sequence of the RNA transcribed</span>
<span class="sd">            from the cistron, given left and right end positions and</span>
<span class="sd">            transcription direction (Note: the left and right end positions in</span>
<span class="sd">            the raw data files are given as 1-indexed coordinates)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">genome_sequence</span><span class="p">[</span><span class="n">left_end_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">right_end_pos</span><span class="p">]</span><span class="o">.</span><span class="n">transcribe</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">genome_sequence</span><span class="p">[</span><span class="n">left_end_pos</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">right_end_pos</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">reverse_complement</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">transcribe</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TranscriptionDirectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unidentified transcription direction given for </span><span class="si">{</span><span class="n">cistron_id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">rna_seqs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">parse_sequence</span><span class="p">(</span>
                <span class="n">cistron_id</span><span class="p">,</span>
                <span class="n">gene_id_to_left_end_pos</span><span class="p">[</span><span class="n">cistron_id_to_gene_id</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]],</span>
                <span class="n">gene_id_to_right_end_pos</span><span class="p">[</span><span class="n">cistron_id_to_gene_id</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]],</span>
                <span class="n">cistron_id_to_direction</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cistron_id</span> <span class="ow">in</span> <span class="n">all_cistron_ids</span>
        <span class="p">]</span>

        <span class="n">nt_counts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">rna_seqs</span><span class="p">:</span>
            <span class="n">nt_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="n">seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">ntp_code_to_id_ordered</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="p">)</span>
        <span class="n">nt_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nt_counts</span><span class="p">)</span>

        <span class="c1"># Calculate molecular weights of the RNAs corresponding to each cistron</span>
        <span class="n">ppi_mw</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_mass</span><span class="p">(</span><span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_ids</span><span class="o">.</span><span class="n">ppi</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span>
            <span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span>
        <span class="p">)</span>
        <span class="n">polymerized_ntp_mws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_mass</span><span class="p">(</span><span class="n">met_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">met_id</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">polymerized_ntps</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">mws</span> <span class="o">=</span> <span class="n">nt_counts</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">polymerized_ntp_mws</span><span class="p">)</span> <span class="o">+</span> <span class="n">ppi_mw</span>  <span class="c1"># Add end weight</span>

        <span class="c1"># Get boolean arrays for each RNA type</span>
        <span class="n">is_mRNA</span> <span class="o">=</span> <span class="p">[</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mRNA&quot;</span> <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="n">all_cistrons</span><span class="p">]</span>
        <span class="n">is_miscRNA</span> <span class="o">=</span> <span class="p">[</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;miscRNA&quot;</span> <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="n">all_cistrons</span><span class="p">]</span>
        <span class="n">is_rRNA</span> <span class="o">=</span> <span class="p">[</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rRNA&quot;</span> <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="n">all_cistrons</span><span class="p">]</span>
        <span class="n">is_tRNA</span> <span class="o">=</span> <span class="p">[</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tRNA&quot;</span> <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="n">all_cistrons</span><span class="p">]</span>

        <span class="c1"># Load set of mRNA cistron ids</span>
        <span class="n">mRNA_cistron_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_cistron_ids</span><span class="p">)[</span><span class="n">is_mRNA</span><span class="p">])</span>

        <span class="c1"># Load cistron half lives</span>
        <span class="n">cistron_id_to_half_life</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">reported_mRNA_cistron_half_lives</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">rna_half_lives</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">gene_id_to_cistron_id</span>
                <span class="ow">and</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;half_life&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">cistron_id</span> <span class="o">=</span> <span class="n">gene_id_to_cistron_id</span><span class="p">[</span><span class="n">gene</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span>
                <span class="n">cistron_id_to_half_life</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;half_life&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cistron_id</span> <span class="ow">in</span> <span class="n">mRNA_cistron_ids</span><span class="p">:</span>
                    <span class="n">reported_mRNA_cistron_half_lives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene</span><span class="p">[</span><span class="s2">&quot;half_life&quot;</span><span class="p">])</span>

        <span class="c1"># Calculate averaged reported half life of mRNAs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average_mRNA_cistron_half_life</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">reported_mRNA_cistron_half_lives</span><span class="p">)</span>

        <span class="c1"># Half-lives of rRNAs are set to be equal to the average reported half</span>
        <span class="c1"># life of mRNAs</span>
        <span class="c1"># Note: rRNAs complexed into ribosomal subunits will not degrade, so</span>
        <span class="c1"># this will only significantly affect excess rRNAs</span>
        <span class="n">rRNA_cistron_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_cistron_ids</span><span class="p">)[</span><span class="n">is_rRNA</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cistron_id</span> <span class="ow">in</span> <span class="n">rRNA_cistron_ids</span><span class="p">:</span>
            <span class="n">cistron_id_to_half_life</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_mRNA_cistron_half_life</span>

        <span class="c1"># Half-life of tRNAs are set to the stable RNA half life value defined</span>
        <span class="c1"># in sim_data.constants</span>
        <span class="n">tRNA_cistron_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_cistron_ids</span><span class="p">)[</span><span class="n">is_tRNA</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cistron_id</span> <span class="ow">in</span> <span class="n">tRNA_cistron_ids</span><span class="p">:</span>
            <span class="n">cistron_id_to_half_life</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">stable_RNA_half_life</span>
            <span class="p">)</span>

        <span class="c1"># Get half life of each RNA cistron - if the half life is not given, use</span>
        <span class="c1"># the averaged reported half life of mRNAs</span>
        <span class="n">cistron_half_lives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">cistron_id_to_half_life</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">cistron_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_mRNA_cistron_half_life</span>
                <span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cistron_id</span> <span class="ow">in</span> <span class="n">all_cistron_ids</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Calculate expected first-order degradation rates of each cistron</span>
        <span class="n">cistron_deg_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">cistron_half_lives</span>

        <span class="c1"># Construct boolean arrays for ribosomal protein and RNAP-encoding</span>
        <span class="c1"># cistrons</span>
        <span class="n">n_cistrons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_cistrons</span><span class="p">)</span>

        <span class="n">is_ribosomal_protein</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cistrons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">is_RNAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cistrons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cistron</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_cistrons</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">monomer_id</span> <span class="ow">in</span> <span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;monomer_ids&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">monomer_id</span> <span class="o">+</span> <span class="s2">&quot;[c]&quot;</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">ribosomal_proteins</span><span class="p">:</span>
                    <span class="n">is_ribosomal_protein</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">monomer_id</span> <span class="o">+</span> <span class="s2">&quot;[c]&quot;</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">RNAP_subunits</span><span class="p">:</span>
                    <span class="n">is_RNAP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Construct boolean arrays and index arrays for each rRNA type</span>
        <span class="n">is_23S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cistrons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">is_16S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cistrons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">is_5S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cistrons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">idx_23S</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idx_16S</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idx_5S</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">rnaIndex</span><span class="p">,</span> <span class="n">cistron</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_cistrons</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[c]&quot;</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">s50_23s_rRNA</span><span class="p">:</span>
                <span class="n">is_23S</span><span class="p">[</span><span class="n">rnaIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">idx_23S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rnaIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[c]&quot;</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">s30_16s_rRNA</span><span class="p">:</span>
                <span class="n">is_16S</span><span class="p">[</span><span class="n">rnaIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">idx_16S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rnaIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[c]&quot;</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">s50_5s_rRNA</span><span class="p">:</span>
                <span class="n">is_5S</span><span class="p">[</span><span class="n">rnaIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">idx_5S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rnaIndex</span><span class="p">)</span>

        <span class="n">max_cistron_id_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="n">all_cistrons</span><span class="p">)</span>
        <span class="n">max_gene_id_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">gene_id</span><span class="p">)</span>

        <span class="n">cistron_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">n_cistrons</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;U</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_cistron_id_length</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;gene_id&quot;</span><span class="p">,</span> <span class="s2">&quot;U</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_gene_id_length</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;i8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;replication_coordinate&quot;</span><span class="p">,</span> <span class="s2">&quot;i8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_forward&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;mw&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;deg_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_mRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_miscRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_23S_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_16S_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_5S_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_ribosomal_protein&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_RNAP&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;uses_corrected_seq_counts&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_new_gene&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="n">all_cistrons</span><span class="p">]</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;gene_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_id</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cistron_lengths</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;replication_coordinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replication_coordinate</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_forward&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_forward</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mws</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;deg_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cistron_deg_rates</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_mRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_mRNA</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_miscRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_miscRNA</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_rRNA</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_tRNA</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_23S_rRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_23S</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_16S_rRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_16S</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_5S_rRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_5S</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_ribosomal_protein&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_ribosomal_protein</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_RNAP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_RNAP</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;uses_corrected_seq_counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cistrons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_new_gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;NG&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">gene_id</span><span class="p">]</span>

        <span class="n">cistron_field_units</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;gene_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span>
            <span class="s2">&quot;replication_coordinate&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_forward&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;mw&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span>
            <span class="s2">&quot;deg_rate&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
            <span class="s2">&quot;is_mRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_miscRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_rRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_tRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_23S_rRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_16S_rRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_5S_rRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_ribosomal_protein&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_RNAP&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;uses_corrected_seq_counts&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_new_gene&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span> <span class="o">=</span> <span class="n">UnitStructArray</span><span class="p">(</span><span class="n">cistron_data</span><span class="p">,</span> <span class="n">cistron_field_units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cistron_id_to_index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cistron_id</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cistron_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="c1"># Load expression levels of individual cistrons from sequencing data</span>
        <span class="n">cistron_expression</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cistron_id_to_gene_id</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genes</span>
        <span class="p">}</span>
        <span class="n">seq_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">x</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]:</span> <span class="n">x</span><span class="p">[</span><span class="n">sim_data</span><span class="o">.</span><span class="n">basal_expression_condition</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">rna_seq_data</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;rnaseq_</span><span class="si">{</span><span class="n">RNA_SEQ_ANALYSIS</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">cistron_rnaseq_coverage</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cistron_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
            <span class="n">gene_id</span> <span class="o">=</span> <span class="n">cistron_id_to_gene_id</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]</span>
            <span class="c1"># If sequencing data is not found, initialize expression to zero.</span>
            <span class="n">cistron_expression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gene_id</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">cistron_rnaseq_coverage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene_id</span> <span class="ow">in</span> <span class="n">seq_data</span><span class="p">)</span>

        <span class="n">cistron_expression</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cistron_expression</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cistron_is_rnaseq_covered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cistron_rnaseq_coverage</span><span class="p">)</span>

        <span class="c1"># Set basal expression levels of each cistron - conditional values are</span>
        <span class="c1"># set in the parca.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cistron_expression</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cistron_expression</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cistron_expression</span> <span class="o">/</span> <span class="n">cistron_expression</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Initialize dictionary for fitted cistron expression levels. Values for</span>
        <span class="c1"># this dictionary are set in the parca.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_cistron_expression</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="Transcription._build_rna_data">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_rna_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_rna_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build RNA-associated simulation data from raw data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_basal_rna_fractions</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">get_basal_rna_fractions</span><span class="p">()</span>

        <span class="c1"># Get list of transcription units used by the model</span>
        <span class="n">all_valid_tus</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tu</span>
            <span class="k">for</span> <span class="n">tu</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">transcription_units</span>
            <span class="k">if</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">is_valid_molecule</span><span class="p">(</span><span class="n">tu</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="c1"># Get mapping from transcription unit IDs to list of constituent</span>
        <span class="c1"># cistrons</span>
        <span class="n">gene_id_to_rna_id</span> <span class="o">=</span> <span class="p">{</span><span class="n">gene</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genes</span><span class="p">}</span>
        <span class="n">tu_id_to_cistron_ids</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tu</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="p">[</span>
                <span class="n">gene_id_to_rna_id</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">tu</span><span class="p">[</span><span class="s2">&quot;genes&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">gene_id_to_rna_id</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">tu</span> <span class="ow">in</span> <span class="n">all_valid_tus</span>
        <span class="p">}</span>

        <span class="c1"># Get list of cistrons that are covered by one or more TUs</span>
        <span class="n">cistrons_covered_by_tus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cistrons</span> <span class="ow">in</span> <span class="n">tu_id_to_cistron_ids</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">cistrons_covered_by_tus</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cistrons</span><span class="p">)</span>
        <span class="n">cistrons_covered_by_tus</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cistrons_covered_by_tus</span><span class="p">)</span>

        <span class="c1"># Compile IDs of all RNAs that should be directly transcribed in the</span>
        <span class="c1"># model, including RNAs for genes that are not covered by any</span>
        <span class="c1"># transcription units</span>
        <span class="n">rna_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">tu</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tu</span> <span class="ow">in</span> <span class="n">all_valid_tus</span><span class="p">]</span>
        <span class="n">rna_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">cistron_id</span>
                <span class="k">for</span> <span class="n">cistron_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">is_valid_molecule</span><span class="p">(</span><span class="n">cistron_id</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">cistron_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cistrons_covered_by_tus</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">n_rnas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rna_ids</span><span class="p">)</span>

        <span class="c1"># Build mapping matrix between transcription units and constituent</span>
        <span class="c1"># cistrons</span>
        <span class="n">cistron_indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rna_indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Mapping from cistron ID to index</span>
        <span class="n">cistron_id_to_index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cistron_id</span><span class="p">:</span> <span class="n">cistron_index</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">cistron_index</span><span class="p">,</span> <span class="n">cistron_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">rna_index</span><span class="p">,</span> <span class="n">rna_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rna_ids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rna_id</span> <span class="ow">in</span> <span class="n">tu_id_to_cistron_ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">mc_rna_id</span> <span class="ow">in</span> <span class="n">tu_id_to_cistron_ids</span><span class="p">[</span><span class="n">rna_id</span><span class="p">]:</span>
                    <span class="n">cistron_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cistron_id_to_index</span><span class="p">[</span><span class="n">mc_rna_id</span><span class="p">])</span>
                    <span class="n">rna_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rna_index</span><span class="p">)</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cistron_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cistron_id_to_index</span><span class="p">[</span><span class="n">rna_id</span><span class="p">])</span>
                <span class="n">rna_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rna_index</span><span class="p">)</span>
                <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cistron_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cistron_indexes</span><span class="p">)</span>
        <span class="n">rna_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rna_indexes</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">cistron_indexes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rna_indexes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Build sparse mapping matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span>
            <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">cistron_indexes</span><span class="p">,</span> <span class="n">rna_indexes</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span>
        <span class="p">)</span>

        <span class="c1"># Find groups of cistrons and TUs that belong to the same operons.</span>
        <span class="c1"># self.operons is a list of tuples that each specify an operon with</span>
        <span class="c1"># a list of cistron indexes and a list of RNA indexes</span>
        <span class="c1"># (e.g. ([380, 379, 377], [2356, 2433]))</span>
        <span class="n">visited_cistron_indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">visited_rna_indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operons</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">rna_DFS</span><span class="p">(</span><span class="n">rna_index</span><span class="p">,</span> <span class="n">operon_cistron_indexes</span><span class="p">,</span> <span class="n">operon_rna_indexes</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Recursive function to look for indexes of RNAs (transcription units)</span>
<span class="sd">            and cistrons that belong to the same operon as the RNA with the</span>
<span class="sd">            given index.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">visited_rna_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rna_index</span><span class="p">)</span>
            <span class="n">operon_rna_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rna_index</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cistron_indexes</span><span class="p">[</span><span class="n">rna_indexes</span> <span class="o">==</span> <span class="n">rna_index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited_cistron_indexes</span><span class="p">:</span>
                    <span class="n">cistron_DFS</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">operon_cistron_indexes</span><span class="p">,</span> <span class="n">operon_rna_indexes</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cistron_DFS</span><span class="p">(</span><span class="n">cistron_index</span><span class="p">,</span> <span class="n">operon_cistron_indexes</span><span class="p">,</span> <span class="n">operon_rna_indexes</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Recursive function to look for indexes of RNAs (transcription units)</span>
<span class="sd">            and cistrons that belong to the same operon as the cistron with the</span>
<span class="sd">            given index.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">visited_cistron_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cistron_index</span><span class="p">)</span>
            <span class="n">operon_cistron_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cistron_index</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rna_indexes</span><span class="p">[</span><span class="n">cistron_indexes</span> <span class="o">==</span> <span class="n">cistron_index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited_rna_indexes</span><span class="p">:</span>
                    <span class="n">rna_DFS</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">operon_cistron_indexes</span><span class="p">,</span> <span class="n">operon_rna_indexes</span><span class="p">)</span>

        <span class="c1"># Loop through each RNA index</span>
        <span class="k">for</span> <span class="n">rna_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rnas</span><span class="p">):</span>
            <span class="c1"># Search for cistrons and RNAs that can be grouped together into the</span>
            <span class="c1"># same operon</span>
            <span class="k">if</span> <span class="n">rna_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited_rna_indexes</span><span class="p">:</span>
                <span class="n">operon_cistron_indexes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">operon_rna_indexes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">rna_DFS</span><span class="p">(</span><span class="n">rna_index</span><span class="p">,</span> <span class="n">operon_cistron_indexes</span><span class="p">,</span> <span class="n">operon_rna_indexes</span><span class="p">)</span>

                <span class="c1"># Sort cistron indexes by coordinates</span>
                <span class="n">operon_cistron_indexes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">operon_cistron_indexes</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;replication_coordinate&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">operons</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">operon_cistron_indexes</span><span class="p">,</span> <span class="n">operon_rna_indexes</span><span class="p">))</span>

        <span class="c1"># Build list of all RNA IDs with compartment tags</span>
        <span class="n">compartments</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_compartments</span><span class="p">(</span><span class="n">rna_ids</span><span class="p">)</span>
        <span class="n">rna_ids_with_compartments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rna_id</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span> <span class="k">for</span> <span class="p">(</span><span class="n">rna_id</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rna_ids</span><span class="p">,</span> <span class="n">compartments</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Apply RNAseq corrections to shorter genes if required by operon version</span>
        <span class="k">if</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">operons_on</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rnaseq_correction</span><span class="p">()</span>

        <span class="n">expression</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_rna_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_expression</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">])</span>

        <span class="c1"># TODO (Albert): should modify more when other types of hybrid RNAs</span>
        <span class="c1">#  are introduced (only rRNA-tRNA hybrids are included currently)</span>
        <span class="c1"># Determine type of each RNA</span>
        <span class="n">is_mRNA</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_mRNA&quot;</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">is_miscRNA</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_miscRNA&quot;</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">is_rRNA</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># All hybrid TUs containing both rRNAs and tRNAs are assumed to be rRNAs</span>
        <span class="n">includes_tRNA</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">is_tRNA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">includes_tRNA</span><span class="p">,</span> <span class="o">~</span><span class="n">is_rRNA</span><span class="p">)</span>
        <span class="n">is_rtRNA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">is_rRNA</span><span class="p">,</span> <span class="n">is_tRNA</span><span class="p">)</span>

        <span class="c1"># Get boolean array for unprocessed rRNA/tRNA molecules</span>
        <span class="n">mature_cistron_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">is_mature_rtRNA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rna_id</span> <span class="ow">in</span> <span class="n">mature_cistron_ids</span> <span class="k">for</span> <span class="n">rna_id</span> <span class="ow">in</span> <span class="n">rna_ids</span><span class="p">])</span>
        <span class="n">is_unprocessed</span> <span class="o">=</span> <span class="n">is_rtRNA</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">is_mature_rtRNA</span>

        <span class="c1"># Determine if each RNA contains cistrons that encode for special</span>
        <span class="c1"># components</span>
        <span class="n">includes_ribosomal_protein</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_ribosomal_protein&quot;</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">includes_RNAP</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_RNAP&quot;</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Build the relative abundance matrix between transcription units and</span>
        <span class="c1"># constituent cistrons</span>
        <span class="n">cistron_indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rna_indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">cistron_index</span><span class="p">,</span> <span class="n">cistron_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]):</span>
            <span class="n">rna_indexes_this_cistron</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_id_to_rna_indexes</span><span class="p">(</span><span class="n">cistron_id</span><span class="p">)</span>
            <span class="n">v_this_cistron</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rna_indexes_this_cistron</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rna_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rna_indexes_this_cistron</span><span class="p">):</span>
                <span class="n">cistron_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cistron_index</span><span class="p">)</span>
                <span class="n">rna_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rna_index</span><span class="p">)</span>
                <span class="n">v_this_cistron</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="p">[</span><span class="n">rna_index</span><span class="p">]</span>

            <span class="c1"># Assume uniform distribution if cistron is not expressed</span>
            <span class="k">if</span> <span class="n">v_this_cistron</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">v_this_cistron</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_this_cistron</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_this_cistron</span> <span class="o">=</span> <span class="n">v_this_cistron</span> <span class="o">/</span> <span class="n">v_this_cistron</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">v</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v_this_cistron</span><span class="p">)</span>

        <span class="n">cistron_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cistron_indexes</span><span class="p">)</span>
        <span class="n">rna_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rna_indexes</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">cistron_indexes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rna_indexes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">cistron_tu_relative_abundancy_matrix</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span>
            <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">cistron_indexes</span><span class="p">,</span> <span class="n">rna_indexes</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span>
        <span class="p">)</span>

        <span class="n">rna_deg_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rnas</span><span class="p">)</span>
        <span class="c1"># If a measured half-life for the transcription unit exists, use the</span>
        <span class="c1"># measured value to calculate the degradation rate</span>
        <span class="n">rna_id_to_index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">rna_id</span><span class="p">:</span> <span class="n">cistron_index</span> <span class="k">for</span> <span class="p">(</span><span class="n">cistron_index</span><span class="p">,</span> <span class="n">rna_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rna_ids</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">rna</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">rna_half_lives</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rna</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rna_id_to_index</span> <span class="ow">and</span> <span class="n">rna</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cistron_id_to_index</span><span class="p">:</span>
                <span class="n">rna_deg_rates</span><span class="p">[</span><span class="n">rna_id_to_index</span><span class="p">[</span><span class="n">rna</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">rna</span><span class="p">[</span>
                    <span class="s2">&quot;half_life&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Get mask for RNAs with measured deg rates</span>
        <span class="n">mask_measured_deg_rate</span> <span class="o">=</span> <span class="n">rna_deg_rates</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Set the minimum possible degradation rates of mRNAs to the minimum of</span>
        <span class="c1"># the measured degradation rates of mRNA cistrons</span>
        <span class="n">min_deg_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_rnas</span><span class="p">)</span>
        <span class="n">cistron_deg_rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;deg_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="n">mRNA_cistron_deg_rates</span> <span class="o">=</span> <span class="n">cistron_deg_rates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_mRNA&quot;</span><span class="p">]]</span>
        <span class="n">min_deg_rates</span><span class="p">[</span><span class="n">is_mRNA</span><span class="p">]</span> <span class="o">=</span> <span class="n">mRNA_cistron_deg_rates</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">min_deg_rates</span> <span class="o">=</span> <span class="n">min_deg_rates</span><span class="p">[</span><span class="o">~</span><span class="n">mask_measured_deg_rate</span><span class="p">]</span>

        <span class="c1"># Solve NNLS for unmeasured degredation rates, using the fact that</span>
        <span class="c1"># A(x + m) = b is equivalent to Ax = b - Am</span>
        <span class="n">abundancy_no_measurements</span> <span class="o">=</span> <span class="n">cistron_tu_relative_abundancy_matrix</span><span class="p">[</span>
            <span class="p">:,</span> <span class="o">~</span><span class="n">mask_measured_deg_rate</span>
        <span class="p">]</span>
        <span class="n">abundancy_with_measurements</span> <span class="o">=</span> <span class="n">cistron_tu_relative_abundancy_matrix</span><span class="p">[</span>
            <span class="p">:,</span> <span class="n">mask_measured_deg_rate</span>
        <span class="p">]</span>
        <span class="n">deg_rates_from_min_rates</span> <span class="o">=</span> <span class="n">abundancy_no_measurements</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">min_deg_rates</span><span class="p">)</span>
        <span class="n">deg_rates_from_measured_rates</span> <span class="o">=</span> <span class="n">abundancy_with_measurements</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
            <span class="n">rna_deg_rates</span><span class="p">[</span><span class="n">mask_measured_deg_rate</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">rna_deg_rates_estimated_minus_min</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fast_nnls</span><span class="p">(</span>
            <span class="n">abundancy_no_measurements</span><span class="p">,</span>
            <span class="n">cistron_deg_rates</span>
            <span class="o">-</span> <span class="n">deg_rates_from_measured_rates</span>
            <span class="o">-</span> <span class="n">deg_rates_from_min_rates</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">rna_deg_rates</span><span class="p">[</span><span class="o">~</span><span class="n">mask_measured_deg_rate</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rna_deg_rates_estimated_minus_min</span> <span class="o">+</span> <span class="n">min_deg_rates</span>
        <span class="p">)</span>

        <span class="c1"># Clip mRNA degradation rates that are higher than the maximum measured</span>
        <span class="c1"># degradation rate</span>
        <span class="n">max_mRNA_deg_rate</span> <span class="o">=</span> <span class="n">mRNA_cistron_deg_rates</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">rna_deg_rates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">is_mRNA</span><span class="p">,</span> <span class="n">rna_deg_rates</span> <span class="o">&gt;</span> <span class="n">max_mRNA_deg_rate</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">max_mRNA_deg_rate</span>
        <span class="p">)</span>

        <span class="c1"># Set degradation rates of rRNAs and tRNAs from the stable RNA half life</span>
        <span class="c1"># value defined in sim_data.constants</span>
        <span class="n">rna_deg_rates</span><span class="p">[</span><span class="n">is_rtRNA</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="mi">2</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">stable_RNA_half_life</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Calculate synthesis probabilities from expression and normalize</span>
        <span class="n">synth_prob</span> <span class="o">=</span> <span class="n">expression</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">doubling_time</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">rna_deg_rates</span>
        <span class="p">)</span>
        <span class="n">synth_prob</span> <span class="o">/=</span> <span class="n">synth_prob</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Load RNA sequences and molecular weights from getter functions</span>
        <span class="n">rna_seqs</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">(</span><span class="n">rna_ids</span><span class="p">)</span>
        <span class="n">mws</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_masses</span><span class="p">(</span><span class="n">rna_ids</span><span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>

        <span class="c1"># Calculate the masses of component rRNA and tRNA cistrons of each RNA</span>
        <span class="n">rRNA_cistron_mws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">rRNA_cistron_mws</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tRNA_cistron_mws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="n">tRNA_cistron_mws</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">rRNA_mws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rRNA_cistron_mws</span><span class="p">)</span>
        <span class="n">tRNA_mws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tRNA_cistron_mws</span><span class="p">)</span>

        <span class="c1"># Calculate lengths and nt counts from sequence</span>
        <span class="n">rna_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">rna_seqs</span><span class="p">])</span>

        <span class="c1"># Get RNA nucleotide compositions</span>
        <span class="n">ntp_abbreviations</span> <span class="o">=</span> <span class="p">[</span><span class="n">ntp_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ntp_id</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">ntps</span><span class="p">]</span>
        <span class="n">nt_counts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">rna_seqs</span><span class="p">:</span>
            <span class="n">nt_counts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">ntp_abbreviations</span><span class="p">])</span>
        <span class="n">nt_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nt_counts</span><span class="p">)</span>

        <span class="c1"># Get mapping from cistron IDs to coordinate and direction</span>
        <span class="n">rna_id_to_coordinate</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rna_id_to_direction</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genes</span><span class="p">:</span>
            <span class="n">rna_id_to_direction</span><span class="p">[</span><span class="n">gene</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                <span class="n">rna_id_to_coordinate</span><span class="p">[</span><span class="n">gene</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;left_end_pos&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rna_id_to_coordinate</span><span class="p">[</span><span class="n">gene</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gene</span><span class="p">[</span><span class="s2">&quot;right_end_pos&quot;</span><span class="p">]</span>

        <span class="c1"># Further extend the dictionaries to include mappings from transcription</span>
        <span class="c1"># unit IDs to coordinate and direction</span>
        <span class="k">for</span> <span class="n">tu</span> <span class="ow">in</span> <span class="n">all_valid_tus</span><span class="p">:</span>
            <span class="n">rna_id_to_direction</span><span class="p">[</span><span class="n">tu</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tu</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tu</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                <span class="n">rna_id_to_coordinate</span><span class="p">[</span><span class="n">tu</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tu</span><span class="p">[</span><span class="s2">&quot;left_end_pos&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rna_id_to_coordinate</span><span class="p">[</span><span class="n">tu</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tu</span><span class="p">[</span><span class="s2">&quot;right_end_pos&quot;</span><span class="p">]</span>

        <span class="c1"># Get mapping from cistron IDs to lengths</span>
        <span class="n">cistron_id_to_length</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="n">cistron</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cistron</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span>
        <span class="p">}</span>

        <span class="c1"># Get location of transcription initiation relative to origin and the</span>
        <span class="c1"># transcription direction for each transcription unit</span>
        <span class="n">replication_coordinate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_relative_coordinates</span><span class="p">(</span><span class="n">rna_id_to_coordinate</span><span class="p">[</span><span class="n">rna_id</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">rna_id</span> <span class="ow">in</span> <span class="n">rna_ids</span>
        <span class="p">]</span>
        <span class="n">is_forward</span> <span class="o">=</span> <span class="p">[</span><span class="n">rna_id_to_direction</span><span class="p">[</span><span class="n">rna_id</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="k">for</span> <span class="n">rna_id</span> <span class="ow">in</span> <span class="n">rna_ids</span><span class="p">]</span>

        <span class="c1"># Calculate relative start and end positions of each cistron within each</span>
        <span class="c1"># transcription unit</span>
        <span class="n">all_cistron_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cistron_start_end_pos_in_tu</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">rna_idx</span><span class="p">,</span> <span class="n">rna_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rna_ids</span><span class="p">):</span>
            <span class="n">rna_coordinate</span> <span class="o">=</span> <span class="n">rna_id_to_coordinate</span><span class="p">[</span><span class="n">rna_id</span><span class="p">]</span>
            <span class="n">constituent_cistron_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span>
                <span class="n">rna_idx</span>
            <span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">cistron_idx</span> <span class="ow">in</span> <span class="n">constituent_cistron_indexes</span><span class="p">:</span>
                <span class="n">cistron_id</span> <span class="o">=</span> <span class="n">all_cistron_ids</span><span class="p">[</span><span class="n">cistron_idx</span><span class="p">]</span>
                <span class="n">cistron_coordinate</span> <span class="o">=</span> <span class="n">rna_id_to_coordinate</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]</span>

                <span class="n">start_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cistron_coordinate</span> <span class="o">-</span> <span class="n">rna_coordinate</span><span class="p">)</span>
                <span class="n">end_pos</span> <span class="o">=</span> <span class="n">start_pos</span> <span class="o">+</span> <span class="n">cistron_id_to_length</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="c1"># End position should stay within length of entire RNA</span>
                <span class="k">assert</span> <span class="n">end_pos</span> <span class="o">&lt;</span> <span class="n">rna_lengths</span><span class="p">[</span><span class="n">rna_idx</span><span class="p">]</span>

                <span class="c1"># Key: (index of cistron, index of RNA)</span>
                <span class="c1"># Value: (start position, end position)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cistron_start_end_pos_in_tu</span><span class="p">[(</span><span class="n">cistron_idx</span><span class="p">,</span> <span class="n">rna_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">start_pos</span><span class="p">,</span>
                    <span class="n">end_pos</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">max_rna_id_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">rna_ids_with_compartments</span><span class="p">)</span>

        <span class="c1"># Get evidence codes for each transcription unit from raw data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_id_to_evidence_codes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tu</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tu</span><span class="p">[</span><span class="s2">&quot;evidence&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">tu</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">transcription_units</span>
        <span class="p">}</span>

        <span class="n">rna_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">n_rnas</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;U</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_rna_id_length</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;deg_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;deg_rate_is_measured&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;i8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;counts_ACGU&quot;</span><span class="p">,</span> <span class="s2">&quot;4i8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;mw&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;rRNA_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;tRNA_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;Km_endoRNase&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;replication_coordinate&quot;</span><span class="p">,</span> <span class="s2">&quot;int64&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;wt_replication_coordinate&quot;</span><span class="p">,</span> <span class="s2">&quot;int64&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_forward&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_mRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_miscRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;includes_tRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_unprocessed&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;includes_ribosomal_protein&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;includes_RNAP&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rna_ids_with_compartments</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;deg_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rna_deg_rates</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;deg_rate_is_measured&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_measured_deg_rate</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rna_lengths</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;counts_ACGU&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nt_counts</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mws</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;rRNA_mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rRNA_mws</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;tRNA_mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tRNA_mws</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;Km_endoRNase&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">rna_ids_with_compartments</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Set later in ParCa</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;replication_coordinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replication_coordinate</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;wt_replication_coordinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replication_coordinate</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_forward&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_forward</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_mRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_mRNA</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_miscRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_miscRNA</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_rRNA</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_tRNA</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;includes_tRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">includes_tRNA</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_unprocessed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_unprocessed</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;includes_ribosomal_protein&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">includes_ribosomal_protein</span>
        <span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;includes_RNAP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">includes_RNAP</span>

        <span class="n">field_units</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;deg_rate&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
            <span class="s2">&quot;deg_rate_is_measured&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span>
            <span class="s2">&quot;counts_ACGU&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span>
            <span class="s2">&quot;mw&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span>
            <span class="s2">&quot;rRNA_mw&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span>
            <span class="s2">&quot;tRNA_mw&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span>
            <span class="s2">&quot;Km_endoRNase&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">L</span><span class="p">,</span>
            <span class="s2">&quot;replication_coordinate&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;wt_replication_coordinate&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_forward&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_mRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_miscRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_rRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_tRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;includes_tRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_unprocessed&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;includes_ribosomal_protein&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;includes_RNAP&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span> <span class="o">=</span> <span class="n">UnitStructArray</span><span class="p">(</span><span class="n">rna_data</span><span class="p">,</span> <span class="n">field_units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rna_id_to_index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">rna_id</span><span class="p">:</span> <span class="n">cistron_index</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">cistron_index</span><span class="p">,</span> <span class="n">rna_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="c1"># Set basal expression and synthesis probabilities - conditional values</span>
        <span class="c1"># are set in the parca.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_expression</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_synth_prob</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_expression</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span> <span class="o">/</span> <span class="n">expression</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_synth_prob</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">synth_prob</span> <span class="o">/</span> <span class="n">synth_prob</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="Transcription.cistron_id_to_rna_indexes">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.cistron_id_to_rna_indexes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cistron_id_to_rna_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cistron_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the indexes of transcription units containing the given RNA</span>
<span class="sd">        cistron given the ID of the cistron.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="o">.</span><span class="n">getrow</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cistron_id_to_index</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="Transcription.rna_id_to_cistron_indexes">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.rna_id_to_cistron_indexes">[docs]</a>
    <span class="nd">@cache</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rna_id_to_cistron_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rna_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the indexes of cistrons that constitute the given transcription</span>
<span class="sd">        unit given the ID of the RNA transcription unit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rna_id_to_index</span><span class="p">[</span><span class="n">rna_id</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Transcription.fit_rna_expression">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.fit_rna_expression">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_rna_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cistron_expression</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the expression of RNA transcription units that best fits the</span>
<span class="sd">        given expression levels of cistrons using nonnegative least squares.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rna_exp</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">fast_nnls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="p">,</span> <span class="n">cistron_expression</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rna_exp</span><span class="p">,</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Transcription.fit_trna_expression">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.fit_trna_expression">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_trna_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tRNA_cistron_expression</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the expression of tRNA transcription units that best fits the</span>
<span class="sd">        given expression levels of tRNA cistrons using nonnegative least</span>
<span class="sd">        squares.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tRNA_exp</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">fast_nnls</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tRNA_cistron_tu_mapping_matrix</span><span class="p">,</span> <span class="n">tRNA_cistron_expression</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">tRNA_exp</span><span class="p">,</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Transcription._get_relative_coordinates">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._get_relative_coordinates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_relative_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the genomic coordinates of a given gene coordinate relative</span>
<span class="sd">        to the origin of replication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coordinates</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terc_coordinate</span><span class="p">:</span>
            <span class="n">relative_coordinates</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_genome_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oric_coordinate</span> <span class="o">+</span> <span class="n">coordinates</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">coordinates</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oric_coordinate</span><span class="p">:</span>
            <span class="n">relative_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oric_coordinate</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relative_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oric_coordinate</span>

        <span class="k">return</span> <span class="n">relative_coordinates</span></div>


<div class="viewcode-block" id="Transcription._apply_rnaseq_correction">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._apply_rnaseq_correction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_rnaseq_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies correction to RNAseq data for shorter genes as required when</span>
<span class="sd">        operon structure is included in the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cistron_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_expression</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">zero_exp_mask</span> <span class="o">=</span> <span class="n">cistron_expression</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Find minimum length of cistron with nonzero expression</span>
        <span class="n">cistron_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">nt</span><span class="p">)</span>
        <span class="n">length_threshold</span> <span class="o">=</span> <span class="n">cistron_lengths</span><span class="p">[</span><span class="o">~</span><span class="n">zero_exp_mask</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="c1"># Get mask for cistrons that are mRNAs, shorter than the threshold</span>
        <span class="c1"># length, covered by RNAseq data, and with zero expression</span>
        <span class="n">correction_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_mRNA&quot;</span><span class="p">],</span>
                <span class="n">zero_exp_mask</span><span class="p">,</span>
                <span class="n">cistron_lengths</span> <span class="o">&lt;</span> <span class="n">length_threshold</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cistron_is_rnaseq_covered</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">corrected_indexes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">cistron_index</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">correction_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># Get indexes of cistrons in the same operon</span>
            <span class="n">cistrons_in_operon</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">rnas_in_operon</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">operon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operons</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cistron_index</span> <span class="ow">in</span> <span class="n">operon</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">cistrons_in_operon</span> <span class="o">=</span> <span class="n">operon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">rnas_in_operon</span> <span class="o">=</span> <span class="n">operon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">assert</span> <span class="n">cistrons_in_operon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="c1"># Skip monocistronic operons</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cistrons_in_operon</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get cistron-TU mapping matrix for this operon</span>
            <span class="n">mapping_matrix_this_operon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="p">[</span>
                <span class="n">cistrons_in_operon</span><span class="p">,</span> <span class="p">:</span>
            <span class="p">][:,</span> <span class="n">rnas_in_operon</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

            <span class="c1"># Remove given gene from operon and run NNLS</span>
            <span class="n">pos_in_operon</span> <span class="o">=</span> <span class="n">cistrons_in_operon</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cistron_index</span><span class="p">)</span>
            <span class="n">mapping_matrix_gene_removed</span> <span class="o">=</span> <span class="n">mapping_matrix_this_operon</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mapping_matrix_gene_removed</span><span class="p">[</span><span class="n">pos_in_operon</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">rna_exp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fast_nnls</span><span class="p">(</span>
                <span class="n">mapping_matrix_gene_removed</span><span class="p">,</span> <span class="n">cistron_expression</span><span class="p">[</span><span class="n">cistrons_in_operon</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Use solution to get expected expression for given gene</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">mapping_matrix_this_operon</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rna_exp</span><span class="p">)[</span><span class="n">pos_in_operon</span><span class="p">]</span>
            <span class="n">cistron_expression</span><span class="p">[</span><span class="n">cistron_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span>
            <span class="n">corrected_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cistron_index</span><span class="p">)</span>

        <span class="c1"># Reset cistron_expression to new values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cistron_expression</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cistron_expression</span> <span class="o">/</span> <span class="n">cistron_expression</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Keep record of cistrons whose expression was corrected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;uses_corrected_seq_counts&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">corrected_indexes</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">True</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Transcription._build_mature_rna_data">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_mature_rna_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_mature_rna_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build mature RNA-associated simulation data from raw data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unprocessed_rna_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_unprocessed&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get IDs of all mature RNAs that are derived from unprocessed RNAs</span>
        <span class="n">mature_rna_cistron_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="p">[:,</span> <span class="n">unprocessed_rna_indexes</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">mature_rna_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">mature_rna_cistron_indexes</span><span class="p">]</span>
        <span class="n">n_mature_rnas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mature_rna_ids</span><span class="p">)</span>
        <span class="n">compartments</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_compartments</span><span class="p">(</span><span class="n">mature_rna_ids</span><span class="p">)</span>
        <span class="n">mature_rna_ids_with_compartments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rna_id</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span> <span class="k">for</span> <span class="p">(</span><span class="n">rna_id</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mature_rna_ids</span><span class="p">,</span> <span class="n">compartments</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Get stoichiometric matrix for RNA maturation process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_maturation_stoich_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="p">[</span>
            <span class="p">:,</span> <span class="n">unprocessed_rna_indexes</span>
        <span class="p">][</span><span class="n">mature_rna_cistron_indexes</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Build matrix of the end positions of each mature RNA within each</span>
        <span class="c1"># unprocessed RNA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mature_rna_end_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rna_maturation_stoich_matrix</span><span class="o">.</span><span class="n">shape</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_maturation_stoich_matrix</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mature_rna_end_positions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_start_end_pos_in_tu</span><span class="p">[</span>
                <span class="p">(</span><span class="n">mature_rna_cistron_indexes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unprocessed_rna_indexes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Get mapping matrix from mature RNA to processing enzymes that are</span>
        <span class="c1"># needed to get the mature forms</span>
        <span class="n">mature_rna_to_enzyme_list</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;rna_id&quot;</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;enzymes&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">rna_maturation_enzymes</span>
        <span class="p">}</span>
        <span class="n">mature_rna_id_to_index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">rna_id</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rna_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mature_rna_ids</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">all_enzymes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mature_rna_indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">enzyme_indexes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">rna_id</span><span class="p">,</span> <span class="n">enzyme_list</span> <span class="ow">in</span> <span class="n">mature_rna_to_enzyme_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Skip if RNA is not a mature RNA</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mature_rna_index</span> <span class="o">=</span> <span class="n">mature_rna_id_to_index</span><span class="p">[</span><span class="n">rna_id</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">enzyme</span> <span class="ow">in</span> <span class="n">enzyme_list</span><span class="p">:</span>
                <span class="n">mature_rna_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mature_rna_index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">enzyme</span> <span class="ow">in</span> <span class="n">all_enzymes</span><span class="p">:</span>
                    <span class="n">enzyme_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_enzymes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">enzyme</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">enzyme_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_enzymes</span><span class="p">))</span>
                    <span class="n">all_enzymes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enzyme</span><span class="p">)</span>

        <span class="n">mature_rna_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mature_rna_indexes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">enzyme_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">enzyme_indexes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">mature_rna_to_enzyme_mapping_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">n_mature_rnas</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_enzymes</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
        <span class="p">)</span>
        <span class="n">mature_rna_to_enzyme_mapping_matrix</span><span class="p">[</span><span class="n">mature_rna_indexes</span><span class="p">,</span> <span class="n">enzyme_indexes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Convert to mapping matrix between unprocessed RNAs and enzymes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_maturation_enzyme_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_maturation_stoich_matrix</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
            <span class="n">mature_rna_to_enzyme_mapping_matrix</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">enzyme_compartments</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_compartments</span><span class="p">(</span><span class="n">all_enzymes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_maturation_enzymes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">enzyme_id</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">enzyme_id</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_enzymes</span><span class="p">,</span> <span class="n">enzyme_compartments</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Get mapping matrix between rtRNA cistrons and TUs</span>
        <span class="n">rRNA_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rRNA_cistron_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rRNA_cistron_tu_mapping_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="p">[</span>
            <span class="p">:,</span> <span class="n">rRNA_indexes</span>
        <span class="p">][</span><span class="n">rRNA_cistron_indexes</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">tRNA_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;includes_tRNA&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tRNA_cistron_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tRNA_cistron_tu_mapping_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="p">[</span>
            <span class="p">:,</span> <span class="n">tRNA_indexes</span>
        <span class="p">][</span><span class="n">tRNA_cistron_indexes</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Get RNA nucleotide compositions of unprocessed and processed RNAs</span>
        <span class="n">unprocessed_rna_nt_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;counts_ACGU&quot;</span><span class="p">][</span>
            <span class="n">unprocessed_rna_indexes</span>
        <span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">nt</span><span class="p">)</span>

        <span class="n">mature_rna_seqs</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">(</span><span class="n">mature_rna_ids</span><span class="p">)</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">mature_rna_seqs</span><span class="p">])</span>
        <span class="n">ntp_abbreviations</span> <span class="o">=</span> <span class="p">[</span><span class="n">ntp_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ntp_id</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">ntps</span><span class="p">]</span>

        <span class="n">mature_rna_nt_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">mature_rna_seqs</span><span class="p">:</span>
            <span class="n">mature_rna_nt_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">mature_rna_nt_counts</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">ntp_abbreviations</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Calculate number of nucleotides that are degraded as part of the</span>
        <span class="c1"># maturation process for each unprocessed RNA</span>
        <span class="n">degraded_nt_counts</span> <span class="o">=</span> <span class="n">unprocessed_rna_nt_counts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_maturation_stoich_matrix</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
            <span class="n">degraded_nt_counts</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-=</span> <span class="n">mature_rna_nt_counts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">degraded_nt_counts</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rna_maturation_degraded_nt_counts</span> <span class="o">=</span> <span class="n">degraded_nt_counts</span>

        <span class="c1"># Get identities of each stable RNA</span>
        <span class="n">is_rRNA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">][</span><span class="n">mature_rna_cistron_indexes</span><span class="p">]</span>
        <span class="n">is_tRNA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">][</span><span class="n">mature_rna_cistron_indexes</span><span class="p">]</span>
        <span class="n">is_23S_rRNA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_23S_rRNA&quot;</span><span class="p">][</span><span class="n">mature_rna_cistron_indexes</span><span class="p">]</span>
        <span class="n">is_16S_rRNA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_16S_rRNA&quot;</span><span class="p">][</span><span class="n">mature_rna_cistron_indexes</span><span class="p">]</span>
        <span class="n">is_5S_rRNA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_5S_rRNA&quot;</span><span class="p">][</span><span class="n">mature_rna_cistron_indexes</span><span class="p">]</span>

        <span class="n">rna_deg_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_mature_rnas</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">stable_rrna</span><span class="p">:</span>
            <span class="c1"># If stable rRNA option is on, set degradation rates of mature rRNAs</span>
            <span class="c1"># to the values calculated from the half-life in sim_data.constants</span>
            <span class="n">rna_deg_rates</span><span class="p">[</span><span class="n">is_rRNA</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="mi">2</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">stable_RNA_half_life</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default: Set degradation rates of mature rRNAs to the average</span>
            <span class="c1"># reported degradation rates of mRNAs</span>
            <span class="c1"># Note: rRNAs complexed into ribosomal subunits will not degrade, so</span>
            <span class="c1"># this will only significantly affect excess rRNAs</span>
            <span class="n">rna_deg_rates</span><span class="p">[</span><span class="n">is_rRNA</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="mi">2</span>
            <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_mRNA_cistron_half_life</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Set degradation rates of tRNAs to the values calculated from the</span>
        <span class="c1"># half-life in sim_data.constants</span>
        <span class="n">rna_deg_rates</span><span class="p">[</span><span class="n">is_tRNA</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="mi">2</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">stable_RNA_half_life</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># Get MWs of mature RNA molecules</span>
        <span class="n">mws</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_masses</span><span class="p">(</span><span class="n">mature_rna_ids</span><span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_mature_rnas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_rna_id_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">mature_rna_ids_with_compartments</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_rna_id_length</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">mature_rna_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">n_mature_rnas</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;U</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_rna_id_length</span><span class="p">)),</span>
                <span class="p">(</span><span class="s2">&quot;deg_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;i8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;counts_ACGU&quot;</span><span class="p">,</span> <span class="s2">&quot;4i8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;mw&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;Km_endoRNase&quot;</span><span class="p">,</span> <span class="s2">&quot;f8&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_23S_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_16S_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;is_5S_rRNA&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mature_rna_ids_with_compartments</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;deg_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rna_deg_rates</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengths</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;counts_ACGU&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mature_rna_nt_counts</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;mw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mws</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;Km_endoRNase&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">mature_rna_ids_with_compartments</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Set later in ParCa</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_rRNA</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_tRNA</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;is_23S_rRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_23S_rRNA</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;is_16S_rRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_16S_rRNA</span>
        <span class="n">mature_rna_data</span><span class="p">[</span><span class="s2">&quot;is_5S_rRNA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_5S_rRNA</span>

        <span class="n">field_units</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;deg_rate&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
            <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span>
            <span class="s2">&quot;counts_ACGU&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">nt</span><span class="p">,</span>
            <span class="s2">&quot;mw&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span>
            <span class="s2">&quot;Km_endoRNase&quot;</span><span class="p">:</span> <span class="n">units</span><span class="o">.</span><span class="n">mol</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">L</span><span class="p">,</span>
            <span class="s2">&quot;is_rRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_tRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_23S_rRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_16S_rRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;is_5S_rRNA&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mature_rna_data</span> <span class="o">=</span> <span class="n">UnitStructArray</span><span class="p">(</span><span class="n">mature_rna_data</span><span class="p">,</span> <span class="n">field_units</span><span class="p">)</span></div>


<div class="viewcode-block" id="Transcription._build_transcription">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_transcription">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_transcription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build transcription-associated simulation data from raw data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load sequence data</span>
        <span class="n">rna_seqs</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_sequences</span><span class="p">(</span>
            <span class="p">[</span><span class="n">rna_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">rna_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span>
        <span class="p">)</span>

        <span class="c1"># Construct transcription sequence matrix</span>
        <span class="n">maxLen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="c1"># Add buffer to account for elongation by max timestep</span>
            <span class="o">+</span> <span class="n">MAX_TIMESTEP</span>
            <span class="o">*</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">RNAP_elongation_rate_for_stable_RNA</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span>
                <span class="n">units</span><span class="o">.</span><span class="n">nt</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transcription_sequences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rna_seqs</span><span class="p">),</span> <span class="n">maxLen</span><span class="p">),</span> <span class="n">polymerize</span><span class="o">.</span><span class="n">PAD_VALUE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span>
        <span class="p">)</span>
        <span class="n">ntMapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">ntpId</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ntpId</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">])}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rna_seqs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">letter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transcription_sequences</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntMapping</span><span class="p">[</span><span class="n">letter</span><span class="p">]</span>

        <span class="c1"># Calculate weights of transcript nucleotide monomers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transcription_monomer_weights</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_masses</span><span class="p">(</span><span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">ntps</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_masses</span><span class="p">([</span><span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_ids</span><span class="o">.</span><span class="n">ppi</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">n_avogadro</span>
        <span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">fg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transcription_end_weight</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_masses</span><span class="p">([</span><span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_ids</span><span class="o">.</span><span class="n">ppi</span><span class="p">])</span>
            <span class="o">/</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">n_avogadro</span>
        <span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">fg</span><span class="p">)</span>

        <span class="c1"># Load active RNAP footprint on DNA</span>
        <span class="n">molecule_id_to_footprint_sizes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;molecule_id&quot;</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;footprint_size&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">footprint_sizes</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_rnap_footprint_size</span> <span class="o">=</span> <span class="n">molecule_id_to_footprint_sizes</span><span class="p">[</span>
                <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_ids</span><span class="o">.</span><span class="n">full_RNAP</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DNA footprint size for RNA polymerses not found.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Transcription._build_charged_trna">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_charged_trna">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_charged_trna</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads information and creates data structures necessary for charging of tRNA</span>

<span class="sd">        Note:</span>
<span class="sd">                Requires self.rna_data so can&#39;t be built in translation even if some</span>
<span class="sd">                data structures would be more appropriate there.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create list of charged tRNAs</span>
        <span class="n">uncharged_trna_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;[c]&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">]]</span>
        <span class="p">]</span>

        <span class="n">charged_trnas</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span><span class="p">[</span><span class="s2">&quot;modified_forms&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">rnas</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[c]&quot;</span> <span class="ow">in</span> <span class="n">uncharged_trna_names</span>
        <span class="p">]</span>

        <span class="n">filtered_charged_trna</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">charged_list</span> <span class="ow">in</span> <span class="n">charged_trnas</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">trna</span> <span class="ow">in</span> <span class="n">charged_list</span><span class="p">:</span>
                <span class="c1"># Skip modified forms so only one charged tRNA per uncharged tRNA</span>
                <span class="k">if</span> <span class="s2">&quot;FMET&quot;</span> <span class="ow">in</span> <span class="n">trna</span> <span class="ow">or</span> <span class="s2">&quot;modified&quot;</span> <span class="ow">in</span> <span class="n">trna</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">assert</span> <span class="s2">&quot;c&quot;</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_compartment</span><span class="p">(</span><span class="n">trna</span><span class="p">)</span>
                <span class="n">filtered_charged_trna</span> <span class="o">+=</span> <span class="p">[</span><span class="n">trna</span> <span class="o">+</span> <span class="s2">&quot;[c]&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span> <span class="o">=</span> <span class="n">uncharged_trna_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charged_trna_names</span> <span class="o">=</span> <span class="n">filtered_charged_trna</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charged_trna_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">)</span>

        <span class="c1"># Create mapping of each tRNA/charged tRNA to associated AA</span>
        <span class="n">trna_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;RNA0-300[c]&quot;</span><span class="p">:</span> <span class="s2">&quot;VAL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RNA0-301[c]&quot;</span><span class="p">:</span> <span class="s2">&quot;LYS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RNA0-302[c]&quot;</span><span class="p">:</span> <span class="s2">&quot;LYS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RNA0-303[c]&quot;</span><span class="p">:</span> <span class="s2">&quot;LYS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RNA0-304[c]&quot;</span><span class="p">:</span> <span class="s2">&quot;ASN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RNA0-305[c]&quot;</span><span class="p">:</span> <span class="s2">&quot;ILE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RNA0-306[c]&quot;</span><span class="p">:</span> <span class="s2">&quot;MET&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">aa_names</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">amino_acids</span>
        <span class="n">aa_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">aa</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">aa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aa_names</span><span class="p">)}</span>
        <span class="n">trna_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">trna</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trna</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_trna</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aa_names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">trna</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">:</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">trna</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">aa</span> <span class="o">==</span> <span class="s2">&quot;ALA&quot;</span><span class="p">:</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="s2">&quot;L-ALPHA-ALANINE&quot;</span>
            <span class="k">elif</span> <span class="n">aa</span> <span class="o">==</span> <span class="s2">&quot;ASP&quot;</span><span class="p">:</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="s2">&quot;L-ASPARTATE&quot;</span>
            <span class="k">elif</span> <span class="n">aa</span> <span class="o">==</span> <span class="s2">&quot;SEL&quot;</span><span class="p">:</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="s2">&quot;L-SELENOCYSTEINE&quot;</span>
            <span class="k">elif</span> <span class="n">aa</span> <span class="o">==</span> <span class="s2">&quot;RNA&quot;</span><span class="p">:</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">trna_dict</span><span class="p">[</span><span class="n">trna</span><span class="p">]</span>

            <span class="k">assert</span> <span class="s2">&quot;c&quot;</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_compartment</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span>
            <span class="n">aa</span> <span class="o">+=</span> <span class="s2">&quot;[c]&quot;</span>
            <span class="k">if</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">aa_names</span><span class="p">:</span>
                <span class="n">aa_idx</span> <span class="o">=</span> <span class="n">aa_indices</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span>
                <span class="n">trna_idx</span> <span class="o">=</span> <span class="n">trna_indices</span><span class="p">[</span><span class="n">trna</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">[</span><span class="n">aa_idx</span><span class="p">,</span> <span class="n">trna_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Arrays for stoichiometry and synthetase mapping matrices</span>
        <span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Sparse matrix representation - i, j are row/column indices and v is value</span>
        <span class="n">stoich_matrix_i</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stoich_matrix_j</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stoich_matrix_v</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">synthetase_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">synthetase_mapping_aa</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">synthetase_mapping_syn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">synthetase_metabolites</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Get IDs of all metabolites</span>
        <span class="n">metabolite_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">met</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">metabolites</span><span class="p">}</span>

        <span class="c1"># Create stoichiometry matrix for charging reactions</span>
        <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">trna_charging_reactions</span><span class="p">:</span>
            <span class="c1"># Get uncharged tRNA name for the given reaction</span>
            <span class="n">trna</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">mol_id</span> <span class="ow">in</span> <span class="n">reaction</span><span class="p">[</span><span class="s2">&quot;stoichiometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mol_id</span><span class="si">}</span><span class="s2">[c]&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">:</span>
                    <span class="n">trna</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mol_id</span><span class="si">}</span><span class="s2">[c]&quot;</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">trna</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">trna_index</span> <span class="o">=</span> <span class="n">trna_indices</span><span class="p">[</span><span class="n">trna</span><span class="p">]</span>

            <span class="c1"># Get molecule information</span>
            <span class="n">aa_idx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">mol_id</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">reaction</span><span class="p">[</span><span class="s2">&quot;stoichiometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">mol_id</span> <span class="ow">in</span> <span class="n">metabolite_ids</span><span class="p">:</span>
                    <span class="n">molecule_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">mol_id</span><span class="p">,</span>
                        <span class="s2">&quot;c&quot;</span><span class="p">,</span>
                        <span class="c1"># Assume all metabolites are in cytosol</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">molecule_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">mol_id</span><span class="p">,</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_compartment</span><span class="p">(</span><span class="n">mol_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">molecule_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">:</span>
                    <span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>
                    <span class="n">molecule_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecules</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">molecule_index</span> <span class="o">=</span> <span class="n">molecules</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">)</span>

                <span class="n">aa_idx</span> <span class="o">=</span> <span class="n">aa_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">,</span> <span class="n">aa_idx</span><span class="p">)</span>

                <span class="c1"># Assume coefficents given as null are -1</span>
                <span class="k">if</span> <span class="n">coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">assert</span> <span class="n">coeff</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span>

                <span class="n">stoich_matrix_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">molecule_index</span><span class="p">)</span>
                <span class="n">stoich_matrix_j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trna_index</span><span class="p">)</span>
                <span class="n">stoich_matrix_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">aa_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="c1"># Create mapping for synthetases catalyzing charging</span>
            <span class="k">for</span> <span class="n">synthetase</span> <span class="ow">in</span> <span class="n">reaction</span><span class="p">[</span><span class="s2">&quot;catalyzed_by&quot;</span><span class="p">]:</span>
                <span class="n">synthetase_metabolites</span><span class="p">[</span><span class="n">synthetase</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">synthetase_metabolites</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">synthetase</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
                    <span class="o">|</span> <span class="n">reaction</span><span class="p">[</span><span class="s2">&quot;stoichiometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">synthetase</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">synthetase</span><span class="p">,</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">getter</span><span class="o">.</span><span class="n">get_compartment</span><span class="p">(</span><span class="n">synthetase</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">synthetase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">synthetase_names</span><span class="p">:</span>
                    <span class="n">synthetase_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">synthetase</span><span class="p">)</span>

                <span class="n">synthetase_mapping_aa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aa_idx</span><span class="p">)</span>
                <span class="n">synthetase_mapping_syn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">synthetase_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">synthetase</span><span class="p">))</span>

        <span class="c1"># Extract KM data for amino acids and tRNA in charging reactions</span>
        <span class="n">synthetase_names_without_tag</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">synthetase_names</span><span class="p">}</span>
        <span class="n">aa_names_without_tag</span> <span class="o">=</span> <span class="p">[</span><span class="n">aa</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">]</span>
        <span class="n">aa_kms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">trna_kms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">skipped_reactions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;RXN-16165&quot;</span><span class="p">}</span>  <span class="c1"># Not correct MET charging reaction</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">metabolism_kinetics</span><span class="p">:</span>
            <span class="c1"># Only look at data for charging reactions</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;reactionID&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">skipped_reactions</span>
                <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;enzymeID&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">synthetase_names_without_tag</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">met</span><span class="p">,</span> <span class="n">km</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;substrateIDs&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;kM&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">aa_names_without_tag</span><span class="p">:</span>
                    <span class="c1"># Prevent data from mismatched amino acid/synthetases being used</span>
                    <span class="k">if</span> <span class="n">met</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">synthetase_metabolites</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;enzymeID&quot;</span><span class="p">]]:</span>
                        <span class="k">continue</span>
                    <span class="n">aa_kms</span><span class="p">[</span><span class="n">met</span><span class="p">]</span> <span class="o">=</span> <span class="n">aa_kms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">km</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">&quot;tRNA&quot;</span> <span class="ow">in</span> <span class="n">met</span><span class="p">:</span>
                    <span class="c1"># Exclude suspiciously high data</span>
                    <span class="k">if</span> <span class="n">km</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">Km_synthetase_uncharged_trna</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">aa</span> <span class="o">=</span> <span class="n">met</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">aa</span> <span class="o">==</span> <span class="s2">&quot;ALA&quot;</span><span class="p">:</span>
                        <span class="n">aa</span> <span class="o">=</span> <span class="s2">&quot;L-ALPHA-ALANINE&quot;</span>
                    <span class="k">elif</span> <span class="n">aa</span> <span class="o">==</span> <span class="s2">&quot;ASP&quot;</span><span class="p">:</span>
                        <span class="n">aa</span> <span class="o">=</span> <span class="s2">&quot;L-ASPARTATE&quot;</span>
                    <span class="k">elif</span> <span class="n">aa</span> <span class="o">==</span> <span class="s2">&quot;Elongation&quot;</span><span class="p">:</span>
                        <span class="n">aa</span> <span class="o">=</span> <span class="s2">&quot;MET&quot;</span>
                    <span class="n">trna_kms</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span> <span class="o">=</span> <span class="n">trna_kms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">km</span><span class="p">]</span>

        <span class="c1"># Save average KM values and use the default value if no data is available</span>
        <span class="n">km_units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">umol</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">L</span>
        <span class="n">average_aa_kms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">average_trna_kms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">aa_id</span> <span class="ow">in</span> <span class="n">aa_names_without_tag</span><span class="p">:</span>
            <span class="n">average_aa_kms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">aa_kms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aa_id</span><span class="p">,</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">Km_synthetase_amino_acid</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">km_units</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">average_trna_kms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">trna_kms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aa_id</span><span class="p">,</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">Km_synthetase_uncharged_trna</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">km_units</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_kms</span> <span class="o">=</span> <span class="n">km_units</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">average_aa_kms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trna_kms</span> <span class="o">=</span> <span class="n">km_units</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">average_trna_kms</span><span class="p">)</span>

        <span class="c1"># Save matrices and related lists of names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stoich_matrix_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stoich_matrix_i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stoich_matrix_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stoich_matrix_j</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stoich_matrix_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stoich_matrix_v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_synthetase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aa_names</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">synthetase_names</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_synthetase</span><span class="p">[</span><span class="n">synthetase_mapping_aa</span><span class="p">,</span> <span class="n">synthetase_mapping_syn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">synthetase_names</span> <span class="o">=</span> <span class="n">synthetase_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_molecules</span> <span class="o">=</span> <span class="n">molecules</span></div>


<div class="viewcode-block" id="Transcription.charging_stoich_matrix">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.charging_stoich_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">charging_stoich_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates stoich matrix from i, j, v arrays</span>

<span class="sd">        Returns 2D array with rows of metabolites for each tRNA charging reaction on the column</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stoich_matrix_i</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stoich_matrix_j</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stoich_matrix_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stoich_matrix_j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stoich_matrix_v</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Transcription._build_attenuation">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_attenuation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_attenuation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load fold changes related to transcriptional attenuation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load data from file</span>
        <span class="n">aa_rna_pair_to_log_fcs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">gene_symbol_to_cistron_id</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">g</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]:</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;rna_ids&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">genes</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">transcriptional_attenuation</span><span class="p">:</span>
            <span class="n">trna_aa</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;tRNA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;[c]&quot;</span>
            <span class="n">gene</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Target&quot;</span><span class="p">]</span>
            <span class="n">cistron_id</span> <span class="o">=</span> <span class="n">gene_symbol_to_cistron_id</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span>

            <span class="c1"># Map FC to all RNAs that cover the cistron</span>
            <span class="n">rna_indexes_with_cistron</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_id_to_rna_indexes</span><span class="p">(</span><span class="n">cistron_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rna_idx</span> <span class="ow">in</span> <span class="n">rna_indexes_with_cistron</span><span class="p">:</span>
                <span class="n">rna_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">rna_idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">trna_aa</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">rna_idx</span><span class="p">])</span> <span class="ow">in</span> <span class="n">aa_rna_pair_to_log_fcs</span><span class="p">:</span>
                    <span class="n">aa_rna_pair_to_log_fcs</span><span class="p">[(</span><span class="n">trna_aa</span><span class="p">,</span> <span class="n">rna_id</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;log2 FC&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aa_rna_pair_to_log_fcs</span><span class="p">[(</span><span class="n">trna_aa</span><span class="p">,</span> <span class="n">rna_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;log2 FC&quot;</span><span class="p">]]</span>

        <span class="n">aa_trnas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attenuated_rnas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fold_changes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">trna_aa</span><span class="p">,</span> <span class="n">rna_id</span><span class="p">),</span> <span class="n">all_log_fcs</span> <span class="ow">in</span> <span class="n">aa_rna_pair_to_log_fcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">aa_trnas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trna_aa</span><span class="p">)</span>
            <span class="n">attenuated_rnas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rna_id</span><span class="p">)</span>

            <span class="c1"># Take the average of the reported FCs of each constituent cistron</span>
            <span class="n">fold_changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_log_fcs</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attenuated_rna_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">attenuated_rnas</span><span class="p">)</span>

        <span class="c1"># Convert data to matrix mapping tRNA to genes with a fold change</span>
        <span class="n">trna_to_row</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">)}</span>
        <span class="n">rna_to_col</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attenuated_rna_ids</span><span class="p">)}</span>
        <span class="n">n_aas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim_data</span><span class="o">.</span><span class="n">molecule_groups</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">)</span>
        <span class="n">n_rnas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attenuated_rna_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attenuation_rna_fold_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_aas</span><span class="p">,</span> <span class="n">n_rnas</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">trna</span><span class="p">,</span> <span class="n">cistron_id</span><span class="p">,</span> <span class="n">fc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aa_trnas</span><span class="p">,</span> <span class="n">attenuated_rnas</span><span class="p">,</span> <span class="n">fold_changes</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">trna_to_row</span><span class="p">[</span><span class="n">trna</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">rna_to_col</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attenuation_rna_fold_changes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc</span>

        <span class="c1"># Attenuated cistron index mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attenuated_rna_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rna_id_to_index</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attenuated_rna_ids</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Specify location in gene where attenuation will occur</span>
        <span class="c1"># Currently just assumes before a transcript begins elongation (position &lt; 1)</span>
        <span class="c1"># TODO: base this on specific locations for each gene</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attenuated_rna_indices</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_location</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">idx</span><span class="p">:</span> <span class="n">loc</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attenuated_rna_indices</span><span class="p">,</span> <span class="n">locations</span><span class="p">)</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Transcription.calculate_attenuation">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.calculate_attenuation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_attenuation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">,</span> <span class="n">cell_specs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate constants for each attenuated gene.</span>

<span class="sd">        TODO:</span>
<span class="sd">                Calculate estimated charged tRNA concentration to use instead of all tRNA</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_trna_conc</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">cell_specs</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span>
            <span class="n">unprocessed_trna_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;includes_tRNA&quot;</span><span class="p">]]</span>
            <span class="n">unprocessed_trna_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span>
                <span class="n">unprocessed_trna_ids</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;bulkAverageContainer&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">unprocessed_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">(</span>
                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;bulkAverageContainer&quot;</span><span class="p">],</span> <span class="n">unprocessed_trna_idx</span>
            <span class="p">)</span>
            <span class="n">trna_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tRNA_cistron_tu_mapping_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">unprocessed_counts</span><span class="p">)</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;avgCellDryMassInit&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">cell_density</span>
                <span class="o">/</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">cell_dry_mass_fraction</span>
            <span class="p">)</span>
            <span class="c1"># Order of operations for conc (counts last) is to get units to work well</span>
            <span class="n">conc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">n_avogadro</span> <span class="o">/</span> <span class="n">volume</span> <span class="o">*</span> <span class="n">trna_counts</span>
            <span class="k">return</span> <span class="n">conc</span>

        <span class="n">k_units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">umol</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">L</span>
        <span class="n">trna_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_trna</span> <span class="o">@</span> <span class="n">get_trna_conc</span><span class="p">(</span><span class="s2">&quot;with_aa&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">k_units</span><span class="p">)</span>

        <span class="c1"># Calculate constant for stop probability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attenuation_rna_fold_changes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attenuation_rna_fold_changes</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">trna_conc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attenuation_rna_fold_changes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_k</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">k_units</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_k</span>

        <span class="c1"># Adjust basal synthesis probabilities to account for less synthesis</span>
        <span class="c1"># due to attenuation</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s2">&quot;basal&quot;</span>
        <span class="n">basal_prob</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">transcription_regulation</span><span class="o">.</span><span class="n">basal_prob</span>
        <span class="n">delta_prob</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">transcription_regulation</span><span class="o">.</span><span class="n">get_delta_prob_matrix</span><span class="p">()</span>
        <span class="n">p_promoter_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">sim_data</span><span class="o">.</span><span class="n">pPromoterBound</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="n">tf</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">transcription_regulation</span><span class="o">.</span><span class="n">tf_ids</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">delta_prob</span> <span class="o">@</span> <span class="n">p_promoter_bound</span>
        <span class="n">basal_stop_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attenuation_stop_probabilities</span><span class="p">(</span>
            <span class="n">get_trna_conc</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">basal_synth_prob</span> <span class="o">=</span> <span class="p">(</span><span class="n">basal_prob</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">attenuated_rna_indices</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_basal_prob_adjustments</span> <span class="o">=</span> <span class="n">basal_synth_prob</span> <span class="o">*</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">basal_stop_prob</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1"># Store expected readthrough fraction for each condition to use in initial conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_readthrough</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_readthrough</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attenuation_stop_probabilities</span><span class="p">(</span><span class="n">get_trna_conc</span><span class="p">(</span><span class="n">condition</span><span class="p">))</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Transcription.get_attenuation_stop_probabilities">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.get_attenuation_stop_probabilities">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_attenuation_stop_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trna_conc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the probability of a transcript stopping early due to attenuation.</span>

<span class="sd">        TODO:</span>
<span class="sd">                Consider a maximum stop probability factor (eg can only attenuate up to 90% of RNAs)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trna_by_aa</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aa_from_trna</span><span class="p">,</span> <span class="n">trna_conc</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">strip_empty_units</span><span class="p">(</span><span class="n">trna_by_aa</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_k</span><span class="p">))</span></div>


<div class="viewcode-block" id="Transcription._build_elongation_rates">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_elongation_rates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_elongation_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stable_RNA_elongation_rate</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">RNAP_elongation_rate_for_stable_RNA</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span>
                <span class="n">units</span><span class="o">.</span><span class="n">nt</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># rRNAs are set to have higher elongation rates</span>
        <span class="c1"># TODO (ggsun): Consider adding tRNAs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rRNA_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Transcription.make_elongation_rates">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.make_elongation_rates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_elongation_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">variable_elongation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">make_elongation_rates</span><span class="p">(</span>
            <span class="n">random</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transcription_sequences</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">base</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rRNA_indexes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stable_RNA_elongation_rate</span><span class="p">,</span>
            <span class="n">time_step</span><span class="p">,</span>
            <span class="n">variable_elongation</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Transcription._solve_ppgpp_km">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._solve_ppgpp_km">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_solve_ppgpp_km</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves for general expression rates for bound and free RNAP and</span>
<span class="sd">        a KM for ppGpp to RNAP based on global cellular measurements.</span>
<span class="sd">        Parameters are solved for at different doubling times using a</span>
<span class="sd">        gradient descent method to minimize the difference in expression</span>
<span class="sd">        of stable RNA compared to the measured RNA in a cell.</span>
<span class="sd">        Assumes a Hill coefficient of 2 for ppGpp binding to RNAP.</span>

<span class="sd">        Attributes set:</span>
<span class="sd">                _fit_ppgpp_fc (float): log2 fold change in stable RNA expression</span>
<span class="sd">                        from a fast doubling time to a slow doubling time based on</span>
<span class="sd">                        the rates of bound and free RNAP expression found</span>
<span class="sd">                _ppgpp_km_squared (float): squared and unitless KM value for</span>
<span class="sd">                        to limit computation needed for fraction bound</span>
<span class="sd">                ppgpp_km (float with mol / volume units): KM for ppGpp binding</span>
<span class="sd">                        to RNAP</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Data for different doubling times (100, 60, 40, 30, 24 min)</span>
        <span class="n">per_dry_mass_to_per_volume</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">cell_density</span> <span class="o">*</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">cell_dry_mass_fraction</span>
        <span class="p">)</span>
        <span class="n">ppgpp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;ppGpp_conc&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">per_dry_mass_to_per_volume</span><span class="p">)</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span>
                        <span class="n">PPGPP_CONC_UNITS</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">growth_rate_dependent_parameters</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">rna</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;rnaMassFraction&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">dry_mass_composition</span><span class="p">])</span>
        <span class="n">mass_per_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">d</span><span class="p">[</span><span class="s2">&quot;averageDryMass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">fg</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">dry_mass_composition</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">rnap_per_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;RNAP_per_cell&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">growth_rate_dependent_parameters</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Variables for the objective</span>
        <span class="c1">## a1: rate of RNA production from free RNAP</span>
        <span class="c1">## a2: rate of RNA production from RNAP bound to ppGpp</span>
        <span class="c1">## km: KM of ppGpp binding to RNAP</span>
        <span class="n">a1s</span><span class="p">,</span> <span class="n">a2s</span><span class="p">,</span> <span class="n">kms</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;a1 a2 km&quot;</span><span class="p">)</span>

        <span class="c1"># Create objective to minimize</span>
        <span class="c1">## Objective is squared difference between RNA created with different rates for RNAP bound</span>
        <span class="c1">## to ppGpp and free RNAP compared to measured RNA in the cell for each measured doubling time.</span>
        <span class="c1">## Use sp.exp to prevent negative parameter values, also improves stability for larger step size.</span>
        <span class="n">difference</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rnap_per_cell</span>
            <span class="o">/</span> <span class="n">mass_per_cell</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a1s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ppgpp</span> <span class="o">/</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kms</span><span class="p">)</span> <span class="o">+</span> <span class="n">ppgpp</span><span class="p">))</span>
                <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a2s</span><span class="p">)</span> <span class="o">*</span> <span class="n">ppgpp</span> <span class="o">/</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kms</span><span class="p">)</span> <span class="o">+</span> <span class="n">ppgpp</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="n">rna</span>
        <span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">difference</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">difference</span><span class="p">)</span>

        <span class="c1"># Convert to functions for faster performance</span>
        <span class="n">dJda1</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">a1s</span><span class="p">,</span> <span class="n">a2s</span><span class="p">,</span> <span class="n">kms</span><span class="p">),</span> <span class="n">J</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">a1s</span><span class="p">))</span>
        <span class="n">dJda2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">a1s</span><span class="p">,</span> <span class="n">a2s</span><span class="p">,</span> <span class="n">kms</span><span class="p">),</span> <span class="n">J</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">a2s</span><span class="p">))</span>
        <span class="n">dJdkm</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">a1s</span><span class="p">,</span> <span class="n">a2s</span><span class="p">,</span> <span class="n">kms</span><span class="p">),</span> <span class="n">J</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">kms</span><span class="p">))</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">a1s</span><span class="p">,</span> <span class="n">a2s</span><span class="p">,</span> <span class="n">kms</span><span class="p">),</span> <span class="n">J</span><span class="p">)</span>

        <span class="c1"># Initial parameters</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">575</span><span class="p">)</span>
        <span class="n">step_size</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Use gradient descent to find</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">J</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">km</span><span class="p">)</span>
        <span class="n">old_obj</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_step</span> <span class="o">=</span> <span class="mf">1e5</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span>
        <span class="n">rel_tol</span> <span class="o">=</span> <span class="mf">1e-9</span>
        <span class="k">while</span> <span class="n">obj</span> <span class="o">&gt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">obj</span> <span class="o">/</span> <span class="n">old_obj</span> <span class="o">&gt;</span> <span class="n">rel_tol</span><span class="p">:</span>
            <span class="n">a1</span> <span class="o">-=</span> <span class="n">dJda1</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="n">step_size</span>
            <span class="n">a2</span> <span class="o">-=</span> <span class="n">dJda2</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="n">step_size</span>
            <span class="n">km</span> <span class="o">-=</span> <span class="n">dJdkm</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="n">step_size</span>

            <span class="n">old_obj</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">J</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">km</span><span class="p">)</span>

            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="n">max_step</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Fitting ppGpp binding KM failed to converge.&quot;</span>
                    <span class="s2">&quot; Check tolerances or maximum number of steps.&quot;</span>
                <span class="p">)</span>

        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">km</span><span class="p">)</span>
        <span class="n">f_low</span> <span class="o">=</span> <span class="n">ppgpp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">km</span> <span class="o">+</span> <span class="n">ppgpp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">a2</span> <span class="o">/</span> <span class="p">(</span><span class="n">a1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_low</span><span class="p">)</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">f_low</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_ppgpp_fc</span> <span class="o">=</span> <span class="n">fc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ppgpp_km_squared</span> <span class="o">=</span> <span class="n">km</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_km</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="n">PPGPP_CONC_UNITS</span></div>


<div class="viewcode-block" id="Transcription.get_rna_fractions">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.get_rna_fractions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_rna_fractions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppgpp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates expected RNA subgroup mass fractions based on ppGpp</span>
<span class="sd">        concentration. If ppGpp expression has not been set yet, uses default</span>
<span class="sd">        measured fractions.</span>

<span class="sd">        Args:</span>
<span class="sd">                ppgpp (float with or without mol / volume units): concentration of</span>
<span class="sd">                        ppGpp, if unitless, should represent the concentration of</span>
<span class="sd">                        PPGPP_CONC_UNITS</span>

<span class="sd">        Returns:</span>
<span class="sd">                dict[str, float]: mass fraction for each subgroup mass, values sum</span>
<span class="sd">                to 1</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ppgpp_expression_set</span><span class="p">:</span>
            <span class="n">rna_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression_from_ppgpp</span><span class="p">(</span><span class="n">ppgpp</span><span class="p">)</span>
            <span class="n">cistron_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_tu_mapping_matrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rna_exp</span><span class="p">)</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;mw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cistron_exp</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="n">mass</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass</span><span class="p">))</span><span class="o">.</span><span class="n">asNumber</span><span class="p">()</span>

            <span class="n">fractions</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;rRNA&quot;</span><span class="p">:</span> <span class="n">mass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;tRNA&quot;</span><span class="p">:</span> <span class="n">mass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_tRNA&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;mRNA&quot;</span><span class="p">:</span> <span class="n">mass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;is_mRNA&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fractions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basal_rna_fractions</span>

        <span class="k">return</span> <span class="n">fractions</span></div>


<div class="viewcode-block" id="Transcription.set_ppgpp_expression">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.set_ppgpp_expression">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_ppgpp_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called during the parca to determine expression of each transcription</span>
<span class="sd">        unit for ppGpp bound and free RNAP.</span>

<span class="sd">        Attributes set:</span>
<span class="sd">                exp_ppgpp (ndarray[float]): expression for each TU when RNAP is</span>
<span class="sd">                        bound to ppGpp</span>
<span class="sd">                exp_free (ndarray[float]): expression for each TU when RNAP is not</span>
<span class="sd">                        bound to ppGpp</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ppgpp_aa</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">growth_rate_parameters</span><span class="o">.</span><span class="n">get_ppGpp_conc</span><span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">condition_to_doubling_time</span><span class="p">[</span><span class="s2">&quot;with_aa&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ppgpp_basal</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">growth_rate_parameters</span><span class="o">.</span><span class="n">get_ppGpp_conc</span><span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">condition_to_doubling_time</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">f_ppgpp_aa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="n">ppgpp_aa</span><span class="p">)</span>
        <span class="n">f_ppgpp_basal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="n">ppgpp_basal</span><span class="p">)</span>
        <span class="n">cistron_id_to_idx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cistron</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cistron</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="c1"># Since fold changes are reported for each cistron (gene), the FCs are</span>
        <span class="c1"># applied first to the expression levels of individual cistrons which</span>
        <span class="c1"># are converted back to TU expression levels through NNLS</span>
        <span class="n">cistron_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_cistron_expression</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">]</span>

        <span class="n">fcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cistron_data</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">cistron_id</span><span class="p">,</span> <span class="n">fc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_regulated_genes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppgpp_fold_changes</span><span class="p">):</span>
            <span class="n">fcs</span><span class="p">[</span><span class="n">cistron_id_to_idx</span><span class="p">[</span><span class="n">cistron_id</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fc</span>

        <span class="c1"># Apply fold changes to expression levels of cistrons</span>
        <span class="n">cistron_exp_ppgpp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">2</span><span class="o">**</span><span class="n">fcs</span> <span class="o">*</span> <span class="n">cistron_exp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp_aa</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp_basal</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mi">1</span>
            <span class="o">-</span> <span class="mi">2</span><span class="o">**</span><span class="n">fcs</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">f_ppgpp_aa</span> <span class="o">-</span> <span class="n">f_ppgpp_basal</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp_aa</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp_basal</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">cistron_exp_free</span> <span class="o">=</span> <span class="p">(</span><span class="n">cistron_exp</span> <span class="o">-</span> <span class="n">cistron_exp_ppgpp</span> <span class="o">*</span> <span class="n">f_ppgpp_basal</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp_basal</span>
        <span class="p">)</span>
        <span class="n">cistron_exp_free</span><span class="p">[</span><span class="n">cistron_exp_free</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">0</span>  <span class="c1"># fold change is limited by KM, can&#39;t have very high positive fold changes</span>
        <span class="p">)</span>

        <span class="c1"># Map expression levels of cistrons to those of TUs through NNLS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_ppgpp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_rna_expression</span><span class="p">(</span><span class="n">cistron_exp_ppgpp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_free</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_rna_expression</span><span class="p">(</span><span class="n">cistron_exp_free</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_ppgpp_expression</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ppgpp_expression_set</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Transcription.adjust_polymerizing_ppgpp_expression">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.adjust_polymerizing_ppgpp_expression">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_polymerizing_ppgpp_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust ppGpp expression based on fit for ribosome and RNAP physiological</span>
<span class="sd">        constraints using least squares fit for 3 conditions with different</span>
<span class="sd">        growth rates/ppGpp.</span>

<span class="sd">        Modifies attributes:</span>
<span class="sd">                exp_ppgpp (ndarray[float]): expression for each gene when RNAP</span>
<span class="sd">                        is bound to ppGpp, adjusted for necessary RNAP and ribosome</span>
<span class="sd">                        expression, normalized to 1</span>
<span class="sd">                exp_free (ndarray[float]): expression for each gene when RNAP</span>
<span class="sd">                        is not bound to ppGpp, adjusted for necessary RNAP and ribosome</span>
<span class="sd">                        expression, normalized to 1</span>

<span class="sd">        Note:</span>
<span class="sd">                See docs/processes/transcription_regulation.pdf for a description</span>
<span class="sd">                of the math used in this section.</span>

<span class="sd">        TODO:</span>
<span class="sd">                fit for all conditions and not just those specified below?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Fraction RNAP bound to ppGpp in different conditions</span>
        <span class="n">ppgpp_aa</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">growth_rate_parameters</span><span class="o">.</span><span class="n">get_ppGpp_conc</span><span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">condition_to_doubling_time</span><span class="p">[</span><span class="s2">&quot;with_aa&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ppgpp_basal</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">growth_rate_parameters</span><span class="o">.</span><span class="n">get_ppGpp_conc</span><span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">condition_to_doubling_time</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ppgpp_anaerobic</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">growth_rate_parameters</span><span class="o">.</span><span class="n">get_ppGpp_conc</span><span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">condition_to_doubling_time</span><span class="p">[</span><span class="s2">&quot;no_oxygen&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">f_ppgpp_aa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="n">ppgpp_aa</span><span class="p">)</span>
        <span class="n">f_ppgpp_basal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="n">ppgpp_basal</span><span class="p">)</span>
        <span class="n">f_ppgpp_anaerobic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="n">ppgpp_anaerobic</span><span class="p">)</span>

        <span class="c1"># Adjustments for TFs</span>
        <span class="c1">## Probabilities need to be unnormalized to match the scale of delta prob</span>
        <span class="c1">## This includes not having get_delta_prob_matrix normalized for ppGpp</span>
        <span class="n">tf_adjustments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">delta_prob</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">transcription_regulation</span><span class="o">.</span><span class="n">get_delta_prob_matrix</span><span class="p">(</span>
            <span class="n">ppgpp</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">adjusted_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;includes_RNAP&quot;</span><span class="p">]</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;includes_ribosomal_protein&quot;</span><span class="p">]</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;with_aa&quot;</span><span class="p">,</span> <span class="s2">&quot;basal&quot;</span><span class="p">,</span> <span class="s2">&quot;no_oxygen&quot;</span><span class="p">]:</span>
            <span class="n">p_promoter_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">sim_data</span><span class="o">.</span><span class="n">pPromoterBound</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="n">tf</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">transcription_regulation</span><span class="o">.</span><span class="n">tf_ids</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">delta_prob</span> <span class="o">@</span> <span class="n">p_promoter_bound</span>
            <span class="n">condition_prob</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">transcription_regulation</span><span class="o">.</span><span class="n">basal_prob</span> <span class="o">+</span> <span class="n">delta</span>
            <span class="p">)</span>
            <span class="n">tf_adjustments</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">delta</span><span class="p">[</span><span class="n">adjusted_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">condition_prob</span><span class="p">[</span><span class="n">adjusted_mask</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Solve least squares fit for expression of each component of RNAP and ribosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_ppgpp_expression</span><span class="p">()</span>  <span class="c1"># Need to normalize first to get correct scale</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp_aa</span><span class="p">,</span> <span class="n">f_ppgpp_aa</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp_basal</span><span class="p">,</span> <span class="n">f_ppgpp_basal</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp_anaerobic</span><span class="p">,</span> <span class="n">f_ppgpp_anaerobic</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">Flst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F</span><span class="p">))</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rna_expression</span><span class="p">[</span><span class="s2">&quot;with_aa&quot;</span><span class="p">][</span><span class="n">adjusted_mask</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tf_adjustments</span><span class="p">[</span><span class="s2">&quot;with_aa&quot;</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rna_expression</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">][</span><span class="n">adjusted_mask</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tf_adjustments</span><span class="p">[</span><span class="s2">&quot;basal&quot;</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rna_expression</span><span class="p">[</span><span class="s2">&quot;no_oxygen&quot;</span><span class="p">][</span><span class="n">adjusted_mask</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tf_adjustments</span><span class="p">[</span><span class="s2">&quot;no_oxygen&quot;</span><span class="p">]),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">adjusted_free</span><span class="p">,</span> <span class="n">adjusted_ppgpp</span> <span class="o">=</span> <span class="n">Flst</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_free</span><span class="p">[</span><span class="n">adjusted_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjusted_free</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_ppgpp</span><span class="p">[</span><span class="n">adjusted_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjusted_ppgpp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_ppgpp_expression</span><span class="p">()</span></div>


<div class="viewcode-block" id="Transcription.adjust_ppgpp_expression_for_tfs">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.adjust_ppgpp_expression_for_tfs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">adjust_ppgpp_expression_for_tfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjusts ppGpp regulated expression to get expression with and without</span>
<span class="sd">        ppGpp regulation to match in basal condition and taking into account</span>
<span class="sd">        the effect transcription factors will have.</span>

<span class="sd">        TODO:</span>
<span class="sd">                Should this not adjust polymerizing genes (adjusted_mask in</span>
<span class="sd">                        adjust_polymerizing_ppgpp_expression) since they have already</span>
<span class="sd">                        been adjusted for transcription factor effects?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">condition</span> <span class="o">=</span> <span class="s2">&quot;basal&quot;</span>

        <span class="c1"># Current (unnormalized) probabilities from ppGpp regulation</span>
        <span class="n">ppgpp_conc</span> <span class="o">=</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">growth_rate_parameters</span><span class="o">.</span><span class="n">get_ppGpp_conc</span><span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">condition_to_doubling_time</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">old_prob</span><span class="p">,</span> <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synth_prob_from_ppgpp</span><span class="p">(</span>
            <span class="n">ppgpp_conc</span><span class="p">,</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">replication</span><span class="o">.</span><span class="n">get_average_copy_number</span>
        <span class="p">)</span>

        <span class="c1"># Calculate the average expected effect of TFs in basal condition</span>
        <span class="n">p_promoter_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">sim_data</span><span class="o">.</span><span class="n">pPromoterBound</span><span class="p">[</span><span class="n">condition</span><span class="p">][</span><span class="n">tf</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">transcription_regulation</span><span class="o">.</span><span class="n">tf_ids</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">delta_prob_no_ppgpp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">transcription_regulation</span><span class="o">.</span><span class="n">get_delta_prob_matrix</span><span class="p">(</span><span class="n">ppgpp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">delta_prob_with_ppgpp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sim_data</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">transcription_regulation</span><span class="o">.</span><span class="n">get_delta_prob_matrix</span><span class="p">(</span><span class="n">ppgpp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">delta_no_ppgpp</span> <span class="o">=</span> <span class="n">delta_prob_no_ppgpp</span> <span class="o">@</span> <span class="n">p_promoter_bound</span>
        <span class="n">delta_with_ppgpp</span> <span class="o">=</span> <span class="n">delta_prob_with_ppgpp</span> <span class="o">@</span> <span class="n">p_promoter_bound</span>

        <span class="c1"># Calculate the required probability to match expression without ppGpp</span>
        <span class="n">new_prob</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_expression</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta_no_ppgpp</span>
        <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">delta_with_ppgpp</span><span class="p">)</span>
        <span class="n">new_prob</span><span class="p">[</span><span class="n">new_prob</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_prob</span><span class="p">[</span><span class="n">new_prob</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">new_prob</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">new_prob</span><span class="p">)</span>

        <span class="c1"># Determine adjustments to the current ppGpp expression to scale</span>
        <span class="c1"># to the expected expression</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
            <span class="n">adjustment</span> <span class="o">=</span> <span class="n">new_prob</span> <span class="o">/</span> <span class="n">old_prob</span>
        <span class="n">adjustment</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">adjustment</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Scale free and bound expression and renormalize ppGpp regulated expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_free</span> <span class="o">*=</span> <span class="n">adjustment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_ppgpp</span> <span class="o">*=</span> <span class="n">adjustment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_ppgpp_expression</span><span class="p">()</span></div>


<div class="viewcode-block" id="Transcription._normalize_ppgpp_expression">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._normalize_ppgpp_expression">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_ppgpp_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize both free and ppGpp bound expression values to 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exp_free</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_free</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_ppgpp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_ppgpp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_free</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_free</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_ppgpp</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_ppgpp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="Transcription.set_ppgpp_kinetics_parameters">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.set_ppgpp_kinetics_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_ppgpp_kinetics_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_container</span><span class="p">,</span> <span class="n">constants</span><span class="p">):</span>
        <span class="n">uncharged_trna_idx</span> <span class="o">=</span> <span class="n">bulk_name_to_idx</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uncharged_trna_names</span><span class="p">,</span> <span class="n">init_container</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">trna_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aa_from_trna</span> <span class="o">@</span> <span class="n">counts</span><span class="p">(</span><span class="n">init_container</span><span class="p">,</span> <span class="n">uncharged_trna_idx</span><span class="p">)</span>
        <span class="n">trna_ratio</span> <span class="o">=</span> <span class="n">trna_counts</span> <span class="o">/</span> <span class="n">trna_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">adjustment_fraction</span> <span class="o">=</span> <span class="n">trna_ratio</span> <span class="o">/</span> <span class="n">trna_ratio</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">KD_RelA</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">KD_RelA_ribosome</span> <span class="o">*</span> <span class="n">adjustment_fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">KI_SpoT</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">KI_SpoT_ppGpp_degradation</span> <span class="o">*</span> <span class="n">adjustment_fraction</span></div>


<div class="viewcode-block" id="Transcription.fraction_rnap_bound_ppgpp">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.fraction_rnap_bound_ppgpp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppgpp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the fraction of RNAP expected to be bound to ppGpp</span>
<span class="sd">        at a given concentration of ppGpp.</span>

<span class="sd">        Args:</span>
<span class="sd">                ppgpp (float with or without mol / volume units): concentration of ppGpp,</span>
<span class="sd">                        if unitless, should represent the concentration of PPGPP_CONC_UNITS</span>

<span class="sd">        Returns:</span>
<span class="sd">                float: fraction of RNAP that will be bound to ppGpp</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">units</span><span class="o">.</span><span class="n">hasUnit</span><span class="p">(</span><span class="n">ppgpp</span><span class="p">):</span>
            <span class="n">ppgpp</span> <span class="o">=</span> <span class="n">ppgpp</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">PPGPP_CONC_UNITS</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ppgpp</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ppgpp_km_squared</span> <span class="o">+</span> <span class="n">ppgpp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="Transcription.expression_from_ppgpp">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.expression_from_ppgpp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">expression_from_ppgpp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppgpp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the expression of each gene at a given concentration of ppGpp.</span>

<span class="sd">        Args:</span>
<span class="sd">                ppgpp (float with or without mol / volume units): concentration of ppGpp,</span>
<span class="sd">                        if unitless, should represent the concentration of PPGPP_CONC_UNITS</span>

<span class="sd">        Returns:</span>
<span class="sd">                ndarray[float]: normalized expression for each gene</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">f_ppgpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="n">ppgpp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_free</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_ppgpp</span> <span class="o">*</span> <span class="n">f_ppgpp</span><span class="p">)</span></div>


<div class="viewcode-block" id="Transcription.synth_prob_from_ppgpp">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.synth_prob_from_ppgpp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">synth_prob_from_ppgpp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppgpp</span><span class="p">,</span> <span class="n">copy_number</span><span class="p">,</span> <span class="n">balanced_rRNA_prob</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the synthesis probability of each gene at a given concentration</span>
<span class="sd">        of ppGpp.</span>

<span class="sd">        Args:</span>
<span class="sd">                ppgpp (float with mol / volume units): concentration of ppGpp</span>
<span class="sd">                copy_number (Callable[float, int]): function that gives the expected copy</span>
<span class="sd">                        number given a doubling time and gene replication coordinate</span>
<span class="sd">                balanced_rRNA_prob (bool): if True, set synthesis probabilities</span>
<span class="sd">                    of rRNA promoters equal to one another</span>

<span class="sd">        Returns</span>
<span class="sd">                prob (ndarray[float]): normalized synthesis probability for each gene</span>
<span class="sd">                factor (ndarray[float]): factor to adjust expression to probability for each gene</span>

<span class="sd">        Note:</span>
<span class="sd">                copy_number should be sim_data.process.replication.get_average_copy_number</span>
<span class="sd">                but saving the function handle as a class attribute prevents pickling of sim_data</span>
<span class="sd">                without additional handling</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ppgpp</span> <span class="o">=</span> <span class="n">ppgpp</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="n">PPGPP_CONC_UNITS</span><span class="p">)</span>
        <span class="n">f_ppgpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="n">ppgpp</span><span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">interpolate_linearized_fit</span><span class="p">(</span><span class="n">ppgpp</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_ppgpp_growth_parameters</span><span class="p">)</span>
        <span class="n">growth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">growth</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">growth</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;deg_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asNumber</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="c1"># Use the wildtype replication coordinates that were used to calculate</span>
        <span class="c1"># exp_free and exp_ppgpp, instead of coordinates that can be adjusted</span>
        <span class="c1"># via variants</span>
        <span class="n">n_avg_copy</span> <span class="o">=</span> <span class="n">copy_number</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;wt_replication_coordinate&quot;</span><span class="p">])</span>

        <span class="c1"># Return values</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="n">n_avg_copy</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_free</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_ppgpp</span> <span class="o">*</span> <span class="n">f_ppgpp</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">balanced_rRNA_prob</span><span class="p">:</span>
            <span class="n">prob</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">prob</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rna_data</span><span class="p">[</span><span class="s2">&quot;is_rRNA&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">prob</span><span class="p">,</span> <span class="n">factor</span></div>


<div class="viewcode-block" id="Transcription.get_rnap_active_fraction_from_ppGpp">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription.get_rnap_active_fraction_from_ppGpp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_rnap_active_fraction_from_ppGpp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppgpp</span><span class="p">):</span>
        <span class="n">f_ppgpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_rnap_bound_ppgpp</span><span class="p">(</span><span class="n">ppgpp</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fraction_active_rnap_bound</span> <span class="o">*</span> <span class="n">f_ppgpp</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fraction_active_rnap_free</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">f_ppgpp</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Transcription._build_new_gene_data">
<a class="viewcode-back" href="../../../../../reference/api/reconstruction/reconstruction.ecoli.dataclasses.process.transcription.html#reconstruction.ecoli.dataclasses.process.transcription.Transcription._build_new_gene_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_new_gene_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">sim_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load baseline values for new gene expression in all simulations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">new_gene_expression_baselines</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">raw_data</span><span class="o">.</span><span class="n">new_gene_data</span><span class="o">.</span><span class="n">new_gene_baseline_expression_parameters</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2026, The Vivarium E. coli Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>